<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <h2>Lista de Producciones de Cultivo</h2>
      <hr>
    </div>
  </div>

  <!-- Filters and Actions -->
  <div class="row mb-4">
    <div class="col-lg-8">
      <div class="row align-items-end">
        <div class="col-md-2">
          <label class="form-label">Solo Activas</label>
          <div class="form-check">
            <input
              type="checkbox"
              id="onlyActives"
              class="form-check-input"
              [(ngModel)]="onlyActive"
              (change)="loadCropProductions()">
            <label class="form-check-label" for="onlyActives">
              Mostrar solo activas
            </label>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Filtro por Estado</label>
          <select
            class="form-select"
            [(ngModel)]="selectedStatus"
            (change)="loadCropProductions()">
            <option value="">Todos los estados</option>
            <option value="Preparacion">Preparación</option>
            <option value="Siembra">Siembra</option>
            <option value="Crecimiento">Crecimiento</option>
            <option value="Floracion">Floración</option>
            <option value="Fructificacion">Fructificación</option>
            <option value="Cosecha">Cosecha</option>
            <option value="Finalizada">Finalizada</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Filtro por Cultivo</label>
          <select
            class="form-select"
            [(ngModel)]="selectedCropId"
            (change)="loadCropProductions()">
            <option value="">Todos los cultivos</option>
            <option *ngFor="let crop of crops" [value]="crop.id">
              {{ crop.name }}
            </option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary" (click)="loadCropProductions()">
            <i class="bi bi-search me-1"></i>Consultar
          </button>
        </div>
        <div class="col-md-2">
          <button class="btn btn-success" (click)="createNew()">
            <i class="bi bi-plus me-1"></i>Nueva
          </button>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="input-group">
        <input
          type="text"
          class="form-control"
          placeholder="Buscar producciones..."
          [(ngModel)]="searchTerm"
          (keyup.enter)="loadCropProductions()">
        <button class="btn btn-outline-secondary" (click)="loadCropProductions()">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="row" *ngIf="isLoading">
    <div class="col-12 text-center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2">Cargando producciones de cultivo...</p>
    </div>
  </div>

  <!-- Crop Productions Table -->
  <div class="row" *ngIf="!isLoading && (cropProductions$ | async) as cropProductions">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-seedling me-2"></i>
            Producciones de Cultivo ({{ cropProductions.length }})
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Código</th>
                  <th>Cultivo</th>
                  <th>Unidad de Producción</th>
                  <th>Estado</th>
                  <th>Fecha Siembra</th>
                  <th>Fecha Est. Cosecha</th>
                  <th>Progreso</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let production of cropProductions; trackBy: trackByFn">
                  <td>
                    <span class="badge bg-secondary">{{ production.id }}</span>
                  </td>
                  <td>
                    <strong>{{ production.code || 'CP-' + production.id }}</strong>
                    <div class="text-muted small" *ngIf="production.description">
                      {{ production.description | slice:0:30 }}{{ production.description.length > 30 ? '...' : '' }}
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <i class="bi bi-flower1 me-2 text-success"></i>
                      <div>
                        <strong>{{ getCropName(production) }}</strong>
                      </div>
                    </div>
                  </td>
                  <td>
                    <i class="bi bi-grid-3x3-gap me-1"></i>
                    {{ getProductionUnitName(production) }}
                  </td>
                  <td>
                    <span class="badge" [ngClass]="getStatusClass(production.status)">
                      <i class="bi" [ngClass]="getStatusIcon(production.status)"></i>
                      {{ getStatusText(production.status) }}
                    </span>
                  </td>
                  <td>
                    <i class="bi bi-calendar-date me-1"></i>
                    {{ getStartDate(production) | date:'shortDate' }}
                  </td>
                  <td>
                    <i class="bi bi-calendar-check me-1"></i>
                    {{ getEndDate(production) | date:'shortDate' }}
                    <div class="text-muted small" *ngIf="getEndDate(production) && getDaysToHarvest(getEndDate(production)) !== null">
                      {{ getDaysToHarvest(getEndDate(production))! > 0 ?
                         getDaysToHarvest(getEndDate(production))! + ' días restantes' :
                         'Listo para cosecha' }}
                    </div>
                  </td>
                  <td>
                    <div class="progress" style="width: 100px; height: 20px;">
                      <div
                        class="progress-bar"
                        [class.bg-success]="(production.progress ?? 0) >= 100"
                        [class.bg-info]="(production.progress ?? 0) < 100"
                        [style.width.%]="production.progress ?? 0">
                        {{ production.progress ?? 0 }}%
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-info"
                        (click)="view(production)"
                        title="Ver detalles">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-primary"
                        (click)="edit(production)"
                        title="Editar">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-success"
                        (click)="manageIrrigation(production)"
                        title="Gestionar irrigación">
                        <i class="bi bi-droplet"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-danger"
                        (click)="delete(production)"
                        title="Eliminar">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Empty State -->
            <div class="text-center p-4" *ngIf="cropProductions.length === 0">
              <i class="bi bi-seedling display-4 text-muted"></i>
              <h5 class="mt-3">No se encontraron producciones de cultivo</h5>
              <p class="text-muted">
                {{ getEmptyStateMessage() }}
              </p>
              <button class="btn btn-primary" (click)="createNew()">
                <i class="bi bi-plus me-1"></i>
                Crear primera producción de cultivo
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div class="row" *ngIf="successMessage">
    <div class="col-12">
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        {{ successMessage }}
        <button type="button" class="btn-close" (click)="successMessage = ''"></button>
      </div>
    </div>
  </div>

  <div class="row" *ngIf="errorMessage">
    <div class="col-12">
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ errorMessage }}
        <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mt-4" *ngIf="(cropProductions$ | async) as cropProductions">
    <div class="col-md-3">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4>{{ cropProductions.length }}</h4>
              <p class="mb-0">Total Producciones</p>
            </div>
            <i class="bi bi-seedling display-6"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4>{{ getProductionsByStatus(cropProductions, 'Crecimiento').length }}</h4>
              <p class="mb-0">En Crecimiento</p>
            </div>
            <i class="bi bi-graph-up-arrow display-6"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-warning">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4>{{ getProductionsByStatus(cropProductions, 'Cosecha').length }}</h4>
              <p class="mb-0">Listas para Cosecha</p>
            </div>
            <i class="bi bi-scissors display-6"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-info">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4>{{ getAverageProgress(cropProductions) | number:'1.0-0' }}%</h4>
              <p class="mb-0">Progreso Promedio</p>
            </div>
            <i class="bi bi-bar-chart display-6"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- VIEW MODAL -->
  <div class="modal fade show d-block" *ngIf="showViewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="bi bi-eye me-2"></i>
            Detalles de Producción
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeModal()"></button>
        </div>
        <div class="modal-body" *ngIf="selectedProduction">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Código</label>
              <p class="fw-bold">{{ selectedProduction.code || 'CP-' + selectedProduction.id }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Estado</label>
              <p>
                <span class="badge" [ngClass]="getStatusClass(selectedProduction.status)">
                  <i class="bi" [ngClass]="getStatusIcon(selectedProduction.status)"></i>
                  {{ getStatusText(selectedProduction.status) }}
                </span>
              </p>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Cultivo</label>
              <p class="fw-bold">
                <i class="bi bi-flower1 text-success me-1"></i>
                {{ getCropName(selectedProduction) }}
              </p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Unidad de Producción</label>
              <p class="fw-bold">
                <i class="bi bi-grid-3x3-gap text-info me-1"></i>
                {{ getProductionUnitName(selectedProduction) }}
              </p>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Fecha de Inicio</label>
              <p>
                <i class="bi bi-calendar-date me-1"></i>
                {{ getStartDate(selectedProduction) | date:'fullDate' }}
              </p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Fecha de Fin</label>
              <p>
                <i class="bi bi-calendar-check me-1"></i>
                {{ getEndDate(selectedProduction) | date:'fullDate' }}
              </p>
              <small class="text-muted" *ngIf="getEndDate(selectedProduction) && getDaysToHarvest(getEndDate(selectedProduction))">
                {{ getDaysToHarvest(getEndDate(selectedProduction))! > 0 ?
                   getDaysToHarvest(getEndDate(selectedProduction))! + ' días restantes' :
                   'Listo para cosecha' }}
              </small>
            </div>
          </div>

          <!-- Dimensions and Area -->
          <h6 class="text-primary mb-3 mt-3">Dimensiones y Área</h6>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Ancho</label>
              <p class="fw-bold">{{ getFieldValue(selectedProduction, 'width') }} m</p>
            </div>
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Largo</label>
              <p class="fw-bold">{{ getFieldValue(selectedProduction, 'length') }} m</p>
            </div>
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Área Total</label>
              <p class="fw-bold text-success">{{ calculateArea(selectedProduction) }} m²</p>
            </div>
          </div>

          <!-- Spacing Configuration -->
          <h6 class="text-primary mb-3 mt-3">Configuración de Espaciamiento</h6>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Dist. Entre Filas</label>
              <p>{{ getFieldValue(selectedProduction, 'betweenRowDistance') }} m</p>
            </div>
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Dist. Entre Contenedores</label>
              <p>{{ getFieldValue(selectedProduction, 'betweenContainerDistance') }} m</p>
            </div>
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Dist. Entre Plantas</label>
              <p>{{ getFieldValue(selectedProduction, 'betweenPlantDistance') }} m</p>
            </div>
          </div>

          <!-- Container and Plant Information -->
          <h6 class="text-primary mb-3 mt-3">Información de Contenedores y Plantas</h6>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Contenedor</label>
              <p class="fw-bold">
                <i class="bi bi-box text-info me-1"></i>
                {{ getContainerName(selectedProduction) }}
              </p>
            </div>
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Medio de Cultivo</label>
              <p class="fw-bold">
                <i class="bi bi-layers text-warning me-1"></i>
                {{ getGrowingMediumName(selectedProduction) }}
              </p>
            </div>
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Plantas por Contenedor</label>
              <p class="fw-bold text-primary">{{ getFieldValue(selectedProduction, 'plantsPerContainer') }}</p>
            </div>
          </div>

          <!-- Irrigation Information -->
          <h6 class="text-primary mb-3 mt-3">Información de Riego</h6>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Gotero</label>
              <p class="fw-bold">
                <i class="bi bi-droplet-fill text-primary me-1"></i>
                {{ getDropperName(selectedProduction) }}
              </p>
            </div>
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Goteros por Contenedor</label>
              <p>{{ getFieldValue(selectedProduction, 'numberOfDroppersPerContainer') }}</p>
            </div>
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Umbral de Drenaje</label>
              <p>{{ getFieldValue(selectedProduction, 'drainThreshold') }}%</p>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="text-muted small">% Agotamiento</label>
              <p>{{ getFieldValue(selectedProduction, 'depletionPercentage') }}%</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Altura Medición Viento</label>
              <p>{{ getFieldValue(selectedProduction, 'windSpeedMeasurementHeight') }} m</p>
            </div>
          </div>

          <!-- Location Information -->
          <h6 class="text-primary mb-3 mt-3">Información de Ubicación</h6>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Altitud</label>
              <p>
                <i class="bi bi-arrow-up me-1"></i>
                {{ getFieldValue(selectedProduction, 'altitude') }} msnm
              </p>
            </div>
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Latitud</label>
              <p>
                <i class="bi bi-geo-alt me-1"></i>
                {{ getFieldValue(selectedProduction, 'latitude') }}°
              </p>
            </div>
            <div class="col-md-4 mb-3">
              <label class="text-muted small">Longitud</label>
              <p>
                <i class="bi bi-geo-alt me-1"></i>
                {{ getFieldValue(selectedProduction, 'longitude') }}°
              </p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cerrar</button>
          <button type="button" class="btn btn-primary" (click)="edit(selectedProduction!)">
            <i class="bi bi-pencil me-1"></i>Editar
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" *ngIf="showViewModal" (click)="closeModal()"></div>

  <!-- CREATE/EDIT MODAL -->
  <div class="modal fade show d-block" *ngIf="showCreateModal || showEditModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header" [ngClass]="showCreateModal ? 'bg-success text-white' : 'bg-primary text-white'">
          <h5 class="modal-title">
            <i class="bi" [ngClass]="showCreateModal ? 'bi-plus-circle' : 'bi-pencil'" class="me-2"></i>
            {{ showCreateModal ? 'Nueva Producción de Cultivo' : 'Editar Producción' }}
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeModal()"></button>
        </div>
        <div class="modal-body">
          <!-- Error Message -->
          <div class="alert alert-danger" *ngIf="formErrorMessage">
            <i class="bi bi-exclamation-triangle me-2"></i>
            {{ formErrorMessage }}
          </div>

          <!-- Form -->
          <form [formGroup]="productionForm">
            <!-- Basic Information -->
            <h6 class="text-primary mb-3">Información Básica</h6>
            <div class="row">
              <!-- Name -->
              <div class="col-md-6 mb-3">
                <label for="name" class="form-label">Nombre <span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  id="name"
                  formControlName="name"
                  [class.is-invalid]="productionForm.get('name')?.invalid && productionForm.get('name')?.touched"
                  placeholder="Ej: Producción Tomate Primavera 2025">
                <div class="invalid-feedback">El nombre es requerido</div>
              </div>

              <!-- Crop -->
              <div class="col-md-6 mb-3">
                <label for="cropId" class="form-label">Cultivo <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  id="cropId"
                  formControlName="cropId"
                  [class.is-invalid]="productionForm.get('cropId')?.invalid && productionForm.get('cropId')?.touched">
                  <option [value]="null" disabled>Seleccione un cultivo</option>
                  <option *ngFor="let crop of crops" [value]="crop.id">
                    {{ crop.name }}
                  </option>
                </select>
                <div class="invalid-feedback">El cultivo es requerido</div>
              </div>
            </div>

            <div class="row">
              <!-- Production Unit -->
              <div class="col-md-6 mb-3">
                <label for="productionUnitId" class="form-label">Unidad de Producción <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  id="productionUnitId"
                  formControlName="productionUnitId"
                  [class.is-invalid]="productionForm.get('productionUnitId')?.invalid && productionForm.get('productionUnitId')?.touched">
                  <option [value]="null" disabled>Seleccione una unidad</option>
                  <option *ngFor="let unit of productionUnits" [value]="unit.id">
                    {{ unit.name }}
                  </option>
                </select>
                <div class="invalid-feedback">La unidad de producción es requerida</div>
              </div>

              <!-- Container -->
              <div class="col-md-6 mb-3">
                <label for="containerId" class="form-label">Contenedor <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  id="containerId"
                  formControlName="containerId"
                  [class.is-invalid]="productionForm.get('containerId')?.invalid && productionForm.get('containerId')?.touched">
                  <option [value]="null" disabled>Seleccione un contenedor</option>
                  <option *ngFor="let container of containers" [value]="container.id">
                    {{ container.name }}
                  </option>
                </select>
                <div class="invalid-feedback">El contenedor es requerido</div>
              </div>
            </div>

            <div class="row">
              <!-- Growing Medium -->
              <div class="col-md-6 mb-3">
                <label for="growingMediumId" class="form-label">Medio de Cultivo <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  id="growingMediumId"
                  formControlName="growingMediumId"
                  [class.is-invalid]="productionForm.get('growingMediumId')?.invalid && productionForm.get('growingMediumId')?.touched">
                  <option [value]="null" disabled>Seleccione un medio de cultivo</option>
                  <option *ngFor="let medium of growingMediums" [value]="medium.id">
                    {{ medium.name }}
                  </option>
                </select>
                <div class="invalid-feedback">El medio de cultivo es requerido</div>
              </div>

              <!-- Dropper -->
              <div class="col-md-6 mb-3">
                <label for="dropperId" class="form-label">Gotero <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  id="dropperId"
                  formControlName="dropperId"
                  [class.is-invalid]="productionForm.get('dropperId')?.invalid && productionForm.get('dropperId')?.touched">
                  <option [value]="null" disabled>Seleccione un gotero</option>
                  <option *ngFor="let dropper of droppers" [value]="dropper.id">
                    {{ dropper.name }}
                  </option>
                </select>
                <div class="invalid-feedback">El gotero es requerido</div>
              </div>
            </div>

            <!-- Dimensions -->
            <h6 class="text-primary mb-3 mt-3">Dimensiones y Espaciamiento</h6>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="width" class="form-label">Ancho (m) <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="width"
                  formControlName="width"
                  [class.is-invalid]="productionForm.get('width')?.invalid && productionForm.get('width')?.touched"
                  min="0"
                  step="0.01">
                <div class="invalid-feedback">El ancho es requerido</div>
              </div>

              <div class="col-md-4 mb-3">
                <label for="length" class="form-label">Largo (m) <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="length"
                  formControlName="length"
                  [class.is-invalid]="productionForm.get('length')?.invalid && productionForm.get('length')?.touched"
                  min="0"
                  step="0.01">
                <div class="invalid-feedback">El largo es requerido</div>
              </div>

              <div class="col-md-4 mb-3">
                <label for="betweenRowDistance" class="form-label">Dist. Entre Filas (m) <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="betweenRowDistance"
                  formControlName="betweenRowDistance"
                  [class.is-invalid]="productionForm.get('betweenRowDistance')?.invalid && productionForm.get('betweenRowDistance')?.touched"
                  min="0"
                  step="0.01">
                <div class="invalid-feedback">Este campo es requerido</div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="betweenContainerDistance" class="form-label">Dist. Entre Contenedores (m) <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="betweenContainerDistance"
                  formControlName="betweenContainerDistance"
                  [class.is-invalid]="productionForm.get('betweenContainerDistance')?.invalid && productionForm.get('betweenContainerDistance')?.touched"
                  min="0"
                  step="0.01">
                <div class="invalid-feedback">Este campo es requerido</div>
              </div>

              <div class="col-md-4 mb-3">
                <label for="betweenPlantDistance" class="form-label">Dist. Entre Plantas (m) <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="betweenPlantDistance"
                  formControlName="betweenPlantDistance"
                  [class.is-invalid]="productionForm.get('betweenPlantDistance')?.invalid && productionForm.get('betweenPlantDistance')?.touched"
                  min="0"
                  step="0.01">
                <div class="invalid-feedback">Este campo es requerido</div>
              </div>

              <div class="col-md-4 mb-3">
                <label for="plantsPerContainer" class="form-label">Plantas por Contenedor <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="plantsPerContainer"
                  formControlName="plantsPerContainer"
                  [class.is-invalid]="productionForm.get('plantsPerContainer')?.invalid && productionForm.get('plantsPerContainer')?.touched"
                  min="1">
                <div class="invalid-feedback">Este campo es requerido</div>
              </div>
            </div>

            <!-- Irrigation and Climate -->
            <h6 class="text-primary mb-3 mt-3">Riego y Clima</h6>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="numberOfDroppersPerContainer" class="form-label">Goteros por Contenedor <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="numberOfDroppersPerContainer"
                  formControlName="numberOfDroppersPerContainer"
                  [class.is-invalid]="productionForm.get('numberOfDroppersPerContainer')?.invalid && productionForm.get('numberOfDroppersPerContainer')?.touched"
                  min="0">
                <div class="invalid-feedback">Este campo es requerido</div>
              </div>

              <div class="col-md-4 mb-3">
                <label for="windSpeedMeasurementHeight" class="form-label">Altura Med. Viento (m) <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="windSpeedMeasurementHeight"
                  formControlName="windSpeedMeasurementHeight"
                  [class.is-invalid]="productionForm.get('windSpeedMeasurementHeight')?.invalid && productionForm.get('windSpeedMeasurementHeight')?.touched"
                  min="0"
                  step="0.1">
                <div class="invalid-feedback">Este campo es requerido</div>
              </div>

              <div class="col-md-4 mb-3">
                <label for="depletionPercentage" class="form-label">% Agotamiento <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="depletionPercentage"
                  formControlName="depletionPercentage"
                  [class.is-invalid]="productionForm.get('depletionPercentage')?.invalid && productionForm.get('depletionPercentage')?.touched"
                  min="0"
                  max="100"
                  step="0.1">
                <div class="invalid-feedback">Ingrese un valor entre 0 y 100</div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12 mb-3">
                <label for="drainThreshold" class="form-label">Umbral de Drenaje <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="drainThreshold"
                  formControlName="drainThreshold"
                  [class.is-invalid]="productionForm.get('drainThreshold')?.invalid && productionForm.get('drainThreshold')?.touched"
                  min="0"
                  step="0.1">
                <div class="invalid-feedback">Este campo es requerido</div>
              </div>
            </div>

            <!-- Dates and Location -->
            <h6 class="text-primary mb-3 mt-3">Fechas y Ubicación</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="startDate" class="form-label">Fecha de Inicio <span class="text-danger">*</span></label>
                <input
                  type="date"
                  class="form-control"
                  id="startDate"
                  formControlName="startDate"
                  [class.is-invalid]="productionForm.get('startDate')?.invalid && productionForm.get('startDate')?.touched">
                <div class="invalid-feedback">La fecha de inicio es requerida</div>
              </div>

              <div class="col-md-6 mb-3">
                <label for="endDate" class="form-label">Fecha de Fin <span class="text-danger">*</span></label>
                <input
                  type="date"
                  class="form-control"
                  id="endDate"
                  formControlName="endDate"
                  [class.is-invalid]="productionForm.get('endDate')?.invalid && productionForm.get('endDate')?.touched">
                <div class="invalid-feedback">La fecha de fin es requerida</div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="altitude" class="form-label">Altitud (msnm) <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="altitude"
                  formControlName="altitude"
                  [class.is-invalid]="productionForm.get('altitude')?.invalid && productionForm.get('altitude')?.touched">
                <div class="invalid-feedback">La altitud es requerida</div>
              </div>

              <div class="col-md-4 mb-3">
                <label for="latitude" class="form-label">Latitud <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="latitude"
                  formControlName="latitude"
                  [class.is-invalid]="productionForm.get('latitude')?.invalid && productionForm.get('latitude')?.touched"
                  step="0.000001"
                  placeholder="Ej: 9.936377">
                <div class="invalid-feedback">La latitud es requerida</div>
              </div>

              <div class="col-md-4 mb-3">
                <label for="longitude" class="form-label">Longitud <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="longitude"
                  formControlName="longitude"
                  [class.is-invalid]="productionForm.get('longitude')?.invalid && productionForm.get('longitude')?.touched"
                  step="0.000001"
                  placeholder="Ej: -84.087502">
                <div class="invalid-feedback">La longitud es requerida</div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="isSubmitting">Cancelar</button>
          <button
            type="button"
            class="btn"
            [ngClass]="showCreateModal ? 'btn-success' : 'btn-primary'"
            (click)="saveProduction()"
            [disabled]="isSubmitting">
            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-1"></span>
            <i class="bi" [ngClass]="showCreateModal ? 'bi-check-circle' : 'bi-save'" *ngIf="!isSubmitting" class="me-1"></i>
            {{ isSubmitting ? 'Guardando...' : (showCreateModal ? 'Guardar' : 'Actualizar') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" *ngIf="showCreateModal || showEditModal" (click)="closeModal()"></div>

  <!-- IRRIGATION MODAL -->
  <div class="modal fade show d-block" *ngIf="showIrrigationModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">
            <i class="bi bi-droplet me-2"></i>
            Gestión de Riego
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeModal()"></button>
        </div>
        <div class="modal-body" *ngIf="selectedProduction">
          <h6 class="mb-3">
            Producción: <strong>{{ selectedProduction.code || 'CP-' + selectedProduction.id }}</strong>
          </h6>

          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Información:</strong> Configure los parámetros de riego para esta producción.
          </div>

          <div class="card mb-3">
            <div class="card-body">
              <h6 class="card-title">Parámetros de Riego</h6>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Frecuencia de Riego (días)</label>
                  <input type="number" class="form-control" value="3" min="1">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Volumen por Riego (L)</label>
                  <input type="number" class="form-control" value="100" min="0">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Método de Riego</label>
                  <select class="form-select">
                    <option>Goteo</option>
                    <option>Aspersión</option>
                    <option>Microaspersión</option>
                    <option>Inundación</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Horario Preferido</label>
                  <input type="time" class="form-control" value="06:00">
                </div>
              </div>
            </div>
          </div>

          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Nota:</strong> Los cambios se guardarán en el sistema de gestión de riego.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
          <button type="button" class="btn btn-info" (click)="onProductionSaved()">
            <i class="bi bi-save me-1"></i>Guardar Configuración
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" *ngIf="showIrrigationModal" (click)="closeModal()"></div>
</div>
