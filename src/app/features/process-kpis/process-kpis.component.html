<!-- src/app/features/dashboard/process-kpis/process-kpis.component.html -->
<div class="process-kpis-container">
  <!-- Header -->
  <div class="page-header">
    <h1><i class="bi bi-calculator"></i> Process KPIs - Cálculos Agronómicos</h1>
  </div>

  <button type="button" class="btn btn-secondary me-2" (click)="goToDashboard()">
    <i class="bi bi-arrow-left"></i>
    Regresar al Dashboard
  </button>

  <br />
  <br />

  <!-- Filter Form -->
  <div class="filter-section card">
    <div class="card-header">
      <h5><i class="bi bi-filter"></i> Filtros de Cálculo</h5>
    </div>
    <div class="card-body">
      <form [formGroup]="filterForm" (ngSubmit)="calculateKPIs()">
        <div class="row">
          <!-- Crop Production Selection -->
          <div class="col-md-3">
            <label class="form-label">Producción de Cultivo *</label>
            <select class="form-select" formControlName="cropProductionId">
              <option [value]="null">Seleccione...</option>
              <option *ngFor="let cp of cropProductions" [value]="cp.id">
                {{ cp.name }}
              </option>
            </select>
          </div>

          <!-- Start Date -->
          <div class="col-md-3">
            <label class="form-label">Fecha Inicio *</label>
            <input type="date" class="form-control" formControlName="startDate" />
          </div>

          <!-- End Date -->
          <div class="col-md-3">
            <label class="form-label">Fecha Fin *</label>
            <input type="date" class="form-control" formControlName="endDate" />
          </div>

          <!-- Calculate Button -->
          <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100" [disabled]="isCalculating || filterForm.invalid">
              <span *ngIf="!isCalculating">
                <i class="bi bi-play-circle"></i> Calcular KPIs
              </span>
              <span *ngIf="isCalculating">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Calculando...
              </span>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-danger alert-dismissible fade show">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
    <button type="button" class="btn-close" (click)="error = null"></button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3">Cargando datos...</p>
  </div>

  <!-- KPI Results -->
  <div *ngIf="kpiData.length > 0 && !isLoading" class="kpi-results">

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4">
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'overview'" (click)="setActiveTab('overview')">
          <i class="bi bi-grid"></i> Resumen
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'climate'" (click)="setActiveTab('climate')">
          <i class="bi bi-cloud-sun"></i> KPIs Climáticos
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'irrigation'" (click)="setActiveTab('irrigation')">
          <i class="bi bi-droplet"></i> KPIs Riego
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'crop'" (click)="setActiveTab('crop')">
          <i class="bi bi-flower1"></i> KPIs Cultivo
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'aggregation'" (click)="setActiveTab('aggregation')">
          <i class="bi bi-bar-chart-fill"></i> Agregación Semanal/Etapas
        </a>
      </li>
    </ul>

    <!-- Overview Tab -->
    <div *ngIf="activeTab === 'overview'" class="tab-content">
      <div class="row mb-4">
        <!-- Summary Cards -->
        <div class="col-md-3">
          <div class="stat-card stat-card-primary">
            <div class="stat-icon">
              <i class="bi bi-calendar-range"></i>
            </div>
            <div class="stat-info">
              <h3>{{ kpiData.length }}</h3>
              <p>Días Analizados</p>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="stat-card stat-card-success">
            <div class="stat-icon">
              <i class="bi bi-droplet-half"></i>
            </div>
            <div class="stat-info">
              <h3>{{ getAverageET() | number:'1.2-2' }}</h3>
              <p>ET Promedio (mm/día)</p>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="stat-card stat-card-warning">
            <div class="stat-icon">
              <i class="bi bi-thermometer-half"></i>
            </div>
            <div class="stat-info">
              <h3>{{ getTotalDegreesDay() | number:'1.0-0' }}</h3>
              <p>Grados Día Acumulados</p>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="stat-card stat-card-info">
            <div class="stat-icon">
              <i class="bi bi-water"></i>
            </div>
            <div class="stat-info">
              <h3>{{ getTotalIrrigationVolume() | number:'1.0-0' }}</h3>
              <p>Volumen Riego Total (L)</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Daily KPIs Table -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5><i class="bi bi-table"></i> KPIs Diarios</h5>
          <button class="btn btn-sm btn-outline-primary" (click)="exportToCSV()">
            <i class="bi bi-download"></i> Exportar CSV
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>ET Ref (mm/día)</th>
                  <th>VPD (kPa)</th>
                  <th>Grados Día</th>
                  <th>Radiación Neta (MJ/m²/día)</th>
                  <th>Vol. Riego (L)</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let kpi of kpiData">
                  <td>{{ kpi.date | date:'shortDate' }}</td>
                  <td>{{ kpi.climate.referenceET | number:'1.2-2' }}</td>
                  <td>{{ kpi.climate.vaporPressureDeficit | number:'1.2-2' }}</td>
                  <td>{{ kpi.climate.degreesDay | number:'1.1-1' }}</td>
                  <td>{{ kpi.climate.netRadiation | number:'1.2-2' }}</td>
                  <td>{{ kpi.irrigation.totalVolume | number:'1.0-0' }}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-info" (click)="viewDayDetails(kpi)">
                      <i class="bi bi-eye"></i> Ver Detalles
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Climate Tab -->
    <div *ngIf="activeTab === 'climate'" class="tab-content">
      <div class="row">
        <div class="col-12 mb-3">
          <h5><i class="bi bi-cloud-sun"></i> KPIs Climáticos Detallados</h5>
          <p class="text-muted">
            Cálculos basados en FAO-56 Penman-Monteith
            <span class="badge bg-success ms-2">
              <i class="bi bi-calculator-fill"></i> 17 funciones CALCULUS activas
            </span>
          </p>
        </div>

        <div *ngFor="let kpi of kpiData" class="col-md-6 col-lg-4 mb-3">
          <div class="card kpi-card">
            <div class="card-header bg-primary text-white">
              <strong>{{ kpi.date | date:'shortDate' }}</strong>
            </div>
            <div class="card-body">
              <div class="kpi-row">
                <span class="kpi-label">ET Referencia:</span>
                <span class="kpi-value">{{ kpi.climate.referenceET | number:'1.2-2' }} mm/día</span>
              </div>

              <!-- Calculated with getSaturationVaporPressure() -->
              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Presión Vapor Sat (Calc):
                </span>
                <span class="kpi-value">{{ kpi.climate.saturationVaporPressure | number:'1.3-3' }} kPa</span>
              </div>

              <!-- Calculated with getRealVaporPressure() -->
              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Presión Vapor Real (Calc):
                </span>
                <span class="kpi-value">{{ kpi.climate.realVaporPressure | number:'1.3-3' }} kPa</span>
              </div>

              <div class="kpi-row">
                <span class="kpi-label">VPD (Déficit):</span>
                <span class="kpi-value">{{ kpi.climate.vaporPressureDeficit | number:'1.3-3' }} kPa</span>
              </div>

              <div class="kpi-row">
                <span class="kpi-label">Radiación Extraterrestre:</span>
                <span class="kpi-value">{{ kpi.climate.extraterrestrialRadiation | number:'1.2-2' }} MJ/m²/día</span>
              </div>

              <div class="kpi-row">
                <span class="kpi-label">Radiación Cielo Claro:</span>
                <span class="kpi-value">{{ kpi.climate.clearSkySolarRadiation | number:'1.2-2' }} MJ/m²/día</span>
              </div>

              <div class="kpi-row">
                <span class="kpi-label">Radiación Neta:</span>
                <span class="kpi-value">{{ kpi.climate.netRadiation | number:'1.2-2' }} MJ/m²/día</span>
              </div>

              <!-- Calculated with getDegreesDay() -->
              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Grados Día (Calculado):
                </span>
                <span class="kpi-value">{{ kpi.climate.degreesDay | number:'1.2-2' }} °C·día</span>
              </div>

              <div class="kpi-row">
                <span class="kpi-label">Constante Psicrométrica:</span>
                <span class="kpi-value">{{ kpi.climate.psychrometricConstant | number:'1.3-3' }} kPa/°C</span>
              </div>

              <!-- Shows days in year calculated with getNDays() -->
              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calendar2-check text-info"></i> Días en el Año:
                </span>
                <span class="kpi-value">
                  {{ getDaysInYear(kpi.date) }}
                  <span class="badge bg-info ms-1" *ngIf="getDaysInYear(kpi.date) === 366">Bisiesto</span>
                </span>
              </div>

              <!-- Batch 2 - New Climate Calculations -->
              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Presión Vapor Real Promedio:
                </span>
                <span class="kpi-value">{{ kpi.climate.avgRealVaporPressure | number:'1.3-3' }} kPa</span>
              </div>

              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Distancia Tierra-Sol Inversa:
                </span>
                <span class="kpi-value">{{ kpi.climate.earthSunInverseDistance | number:'1.4-4' }}</span>
              </div>

              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Latitud en Radianes:
                </span>
                <span class="kpi-value">{{ kpi.climate.latitudeRadians | number:'1.4-4' }} rad</span>
              </div>

              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Inclinación Solar:
                </span>
                <span class="kpi-value">{{ kpi.climate.solarInclination | number:'1.4-4' }} rad</span>
              </div>

              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Ángulo Puesta Solar:
                </span>
                <span class="kpi-value">{{ kpi.climate.solarSunsetAngle | number:'1.4-4' }} rad</span>
              </div>

              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Radiación Solar Extraterrestre:
                </span>
                <span class="kpi-value">{{ kpi.climate.extraterrestrialSolarRadiationTerm | number:'1.3-3' }}
                  MJ/m²/día</span>
              </div>

              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Velocidad Viento (m/s):
                </span>
                <span class="kpi-value">{{ kpi.climate.windSpeedMtsPerSecond | number:'1.2-2' }} m/s</span>
              </div>

              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Pendiente Curva Vapor:
                </span>
                <span class="kpi-value">{{ kpi.climate.slopeVaporPressureCurveCalc | number:'1.4-4' }} kPa/°C</span>
              </div>

              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Calor Latente Evaporación:
                </span>
                <span class="kpi-value">{{ kpi.climate.latentHeatEvaporation | number:'1.2-2' }} MJ/kg</span>
              </div>

              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-info"></i> Constante Psicrométrica (Calc):
                </span>
                <span class="kpi-value">{{ kpi.climate.psychrometricConstantCalc | number:'1.4-4' }} kPa/°C</span>
              </div>

              <!-- Batch 3 - Longwave Radiation Components -->
              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-warning"></i> Factor Radiación Isotérmica:
                </span>
                <span class="kpi-value">{{ kpi.climate.isothermalLongwaveRadiationFactor | number:'1.4-4' }}
                  MJ/m²/día</span>
              </div>

              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-warning"></i> Factor de Humedad:
                </span>
                <span class="kpi-value">{{ kpi.climate.humidityFactor | number:'1.3-3' }}</span>
              </div>

              <div class="kpi-row highlight">
                <span class="kpi-label">
                  <i class="bi bi-calculator-fill text-warning"></i> Factor de Nubosidad:
                </span>
                <span class="kpi-value">{{ kpi.climate.cloudFactor | number:'1.3-3' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Irrigation Tab -->
    <div *ngIf="activeTab === 'irrigation'" class="tab-content">
      <div class="row">
        <div class="col-12 mb-3">
          <h5><i class="bi bi-droplet"></i> KPIs de Riego</h5>
          <p class="text-muted">
            Métricas de riego y volúmenes aplicados
            <span class="badge bg-success ms-2">
              <i class="bi bi-calculator-fill"></i> 9 funciones CALCULUS activas
            </span>
          </p>
        </div>

        <!-- Show Crop Densities (calculated with getDensities) -->
        <div class="col-12 mb-4" *ngIf="kpiData.length > 0">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h6 class="mb-0">
                <i class="bi bi-calculator-fill"></i> Densidades de Cultivo (Calculadas con getDensities)
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="density-display">
                    <div class="density-icon">
                      <i class="bi bi-box text-primary"></i>
                    </div>
                    <div class="density-info">
                      <div class="density-label">Densidad de Contenedores</div>
                      <div class="density-value">{{ kpiData[0].crop.densityContainer | number:'1.2-2' }} cont/m²</div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="density-display">
                    <div class="density-icon">
                      <i class="bi bi-flower1 text-success"></i>
                    </div>
                    <div class="density-info">
                      <div class="density-label">Densidad de Plantas</div>
                      <div class="density-value">{{ kpiData[0].crop.densityPlant | number:'1.2-2' }} plantas/m²</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Batch 3: Irrigation Statistics -->
        <div class="col-12 mb-4" *ngIf="kpiData.length > 0">
          <div class="card">
            <div class="card-header bg-info text-white">
              <h6 class="mb-0">
                <i class="bi bi-calculator-fill"></i> Estadísticas de Riego del Período (Batch 3)
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Volume Statistics -->
                <div class="col-md-4">
                  <div class="stat-group">
                    <h6 class="stat-group-title">
                      <i class="bi bi-droplet-fill text-info"></i> Estadísticas de Volumen
                    </h6>
                    <div class="kpi-row highlight">
                      <span class="kpi-label">Volumen Total:</span>
                      <span class="kpi-value">{{ getTotalIrrigationVolume() | number:'1.0-0' }} L</span>
                    </div>
                    <div class="kpi-row highlight">
                      <span class="kpi-label">Volumen Promedio:</span>
                      <span class="kpi-value">{{ getAverageIrrigationVolume() | number:'1.2-2' }} L</span>
                    </div>
                    <div class="kpi-row highlight">
                      <span class="kpi-label">Volumen Mínimo:</span>
                      <span class="kpi-value">{{ getMinIrrigationVolume() | number:'1.2-2' }} L</span>
                    </div>
                    <div class="kpi-row highlight">
                      <span class="kpi-label">Volumen Máximo:</span>
                      <span class="kpi-value">{{ getMaxIrrigationVolume() | number:'1.2-2' }} L</span>
                    </div>
                  </div>
                </div>

                <!-- Interval Statistics -->
                <div class="col-md-4">
                  <div class="stat-group">
                    <h6 class="stat-group-title">
                      <i class="bi bi-clock-history text-warning"></i> Estadísticas de Intervalos
                    </h6>
                    <div class="kpi-row highlight">
                      <span class="kpi-label">Intervalo Promedio:</span>
                      <span class="kpi-value">{{ getAverageInterval() | number:'1.1-1' }} h</span>
                    </div>
                    <div class="kpi-row highlight">
                      <span class="kpi-label">Intervalo Mínimo:</span>
                      <span class="kpi-value">{{ getMinInterval() | number:'1.1-1' }} h</span>
                    </div>
                    <div class="kpi-row highlight">
                      <span class="kpi-label">Intervalo Máximo:</span>
                      <span class="kpi-value">{{ getMaxInterval() | number:'1.1-1' }} h</span>
                    </div>
                  </div>
                </div>

                <!-- Duration Statistics -->
                <div class="col-md-4">
                  <div class="stat-group">
                    <h6 class="stat-group-title">
                      <i class="bi bi-stopwatch text-success"></i> Estadísticas de Duración
                    </h6>
                    <div class="kpi-row highlight">
                      <span class="kpi-label">Duración Total:</span>
                      <span class="kpi-value">{{ getTotalDuration() | number:'1.0-0' }} min</span>
                    </div>
                    <div class="kpi-row highlight">
                      <span class="kpi-label">Duración Promedio:</span>
                      <span class="kpi-value">{{ getAverageDuration() | number:'1.1-1' }} min</span>
                    </div>
                    <div class="kpi-row highlight">
                      <span class="kpi-label">Duración Mínima:</span>
                      <span class="kpi-value">{{ getMinDuration() | number:'1.1-1' }} min</span>
                    </div>
                    <div class="kpi-row highlight">
                      <span class="kpi-label">Duración Máxima:</span>
                      <span class="kpi-value">{{ getMaxDuration() | number:'1.1-1' }} min</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div *ngFor="let kpi of kpiData" class="col-md-6 col-lg-4 mb-3">
          <div class="card kpi-card">
            <div class="card-header bg-info text-white">
              <strong>{{ kpi.date | date:'shortDate' }}</strong>
            </div>
            <div class="card-body">
              <div class="kpi-row">
                <span class="kpi-label">Volumen Total:</span>
                <span class="kpi-value">{{ kpi.irrigation.totalVolume | number:'1.0-0' }} L</span>
              </div>
              <div class="kpi-row">
                <span class="kpi-label">Duración:</span>
                <span class="kpi-value">{{ kpi.irrigation.totalDuration | number:'1.0-0' }} min</span>
              </div>
              <div class="kpi-row">
                <span class="kpi-label">% Drenaje Promedio:</span>
                <span class="kpi-value">{{ kpi.irrigation.averageDrainPercentage | number:'1.1-1' }}%</span>
              </div>
              <div class="kpi-row">
                <span class="kpi-label">Eventos de Riego:</span>
                <span class="kpi-value">{{ kpi.irrigation.metrics.length }}</span>
              </div>
              <div *ngIf="kpi.cropEvapoTranspiration" class="kpi-row highlight">
                <span class="kpi-label">ET Cultivo:</span>
                <span class="kpi-value">{{ kpi.cropEvapoTranspiration | number:'1.2-2' }} mm/día</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Crop Tab -->
    <div *ngIf="activeTab === 'crop'" class="tab-content">
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h5><i class="bi bi-flower1"></i> Información del Cultivo</h5>
            </div>
            <div class="card-body">
              <div *ngIf="kpiData.length > 0" class="kpi-details">
                <!-- Calculated with getArea() -->
                <div class="kpi-row highlight">
                  <span class="kpi-label">
                    <i class="bi bi-calculator-fill text-success"></i> Área Total (Calculada):
                  </span>
                  <span class="kpi-value">{{ kpiData[0].crop.area | number:'1.2-2' }} m²</span>
                </div>

                <!-- Calculated with getDensityPlant() -->
                <div class="kpi-row highlight">
                  <span class="kpi-label">
                    <i class="bi bi-calculator-fill text-success"></i> Densidad Plantas (Calculada):
                  </span>
                  <span class="kpi-value">{{ kpiData[0].crop.densityPlant | number:'1.2-2' }} plantas/m²</span>
                </div>

                <div class="kpi-row">
                  <span class="kpi-label">Densidad Contenedores:</span>
                  <span class="kpi-value">{{ kpiData[0].crop.densityContainer | number:'1.2-2' }} cont/m²</span>
                </div>

                <!-- Calculated with getTotalPlants() -->
                <div class="kpi-row highlight">
                  <span class="kpi-label">
                    <i class="bi bi-calculator-fill text-success"></i> Total Plantas (Calculado):
                  </span>
                  <span class="kpi-value">{{ kpiData[0].crop.totalPlants | number:'1.0-0' }}</span>
                </div>

                <!-- Calculated with getNumberOfRows() -->
                <div class="kpi-row highlight">
                  <span class="kpi-label">
                    <i class="bi bi-calculator-fill text-success"></i> Número de Hileras (Calculado):
                  </span>
                  <span class="kpi-value">{{ kpiData[0].crop.numberOfRows }}</span>
                </div>

                <!-- Batch 2 - Calculated with getNumberOfPlantsPerRow() -->
                <div class="kpi-row highlight">
                  <span class="kpi-label">
                    <i class="bi bi-calculator-fill text-success"></i> Plantas por Hilera (Calculado):
                  </span>
                  <span class="kpi-value">{{ kpiData[0].crop.numberOfPlantsPerRow }}</span>
                </div>

                <!-- Batch 2 - Calculated with getLatitudeGrades() and getLatitudeMinutes() -->
                <div class="kpi-row highlight">
                  <span class="kpi-label">
                    <i class="bi bi-calculator-fill text-success"></i> Latitud (Calculada):
                  </span>
                  <span class="kpi-value">
                    {{ kpiData[0].crop.latitudeGrades }}° {{ kpiData[0].crop.latitudeMinutes }}'
                    <span class="badge bg-success ms-1">
                      <i class="bi bi-geo-alt"></i> Grados/Minutos
                    </span>
                  </span>
                </div>

                <!-- Calculated with getVolume() -->
                <div *ngIf="kpiData[0].crop.containerVolume" class="kpi-row highlight">
                  <span class="kpi-label">
                    <i class="bi bi-calculator-fill text-success"></i> Volumen Contenedor (Calculado):
                  </span>
                  <span class="kpi-value">{{ kpiData[0].crop.containerVolume.value | number:'1.2-2' }} L</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-warning text-dark">
              <h5><i class="bi bi-moisture"></i> Medio de Crecimiento</h5>
            </div>
            <div class="card-body">
              <div *ngIf="kpiData.length > 0" class="kpi-details">
                <!-- Calculated with getTotalAvailableWaterPercentage() -->
                <div class="kpi-row highlight">
                  <span class="kpi-label">
                    <i class="bi bi-calculator-fill text-warning"></i> Agua Total Disponible (Calculada):
                  </span>
                  <span class="kpi-value">{{ kpiData[0].growingMedium.totalAvailableWaterPercentage | number:'1.1-1'
                    }}%</span>
                </div>

                <!-- Calculated with getEaselyAvailableWaterPercentage() -->
                <div class="kpi-row highlight">
                  <span class="kpi-label">
                    <i class="bi bi-calculator-fill text-warning"></i> Agua Fácilmente Disponible (Calculada):
                  </span>
                  <span class="kpi-value">{{ kpiData[0].growingMedium.easelyAvailableWaterPercentage | number:'1.1-1'
                    }}%</span>
                </div>

                <!-- Calculated with getReserveWaterPercentage() -->
                <div class="kpi-row highlight">
                  <span class="kpi-label">
                    <i class="bi bi-calculator-fill text-warning"></i> Agua de Reserva (Calculada):
                  </span>
                  <span class="kpi-value">{{ kpiData[0].growingMedium.reserveWaterPercentage | number:'1.1-1' }}%</span>
                </div>

                <!-- Visual Water Balance -->
                <div class="water-balance-visual mt-4">
                  <h6 class="text-center mb-3">Balance Hídrico Visual</h6>
                  <div class="water-gauge-compact">
                    <div class="gauge-label-compact">Total Disponible</div>
                    <div class="gauge-bar-compact">
                      <div class="gauge-fill-compact bg-info"
                        [style.width.%]="kpiData[0].growingMedium.totalAvailableWaterPercentage">
                      </div>
                    </div>
                    <div class="gauge-value-compact">{{ kpiData[0].growingMedium.totalAvailableWaterPercentage |
                      number:'1.1-1' }}%</div>
                  </div>
                  <div class="water-gauge-compact">
                    <div class="gauge-label-compact">Fácilmente Disponible</div>
                    <div class="gauge-bar-compact">
                      <div class="gauge-fill-compact bg-success"
                        [style.width.%]="kpiData[0].growingMedium.easelyAvailableWaterPercentage">
                      </div>
                    </div>
                    <div class="gauge-value-compact">{{ kpiData[0].growingMedium.easelyAvailableWaterPercentage |
                      number:'1.1-1' }}%</div>
                  </div>
                  <div class="water-gauge-compact">
                    <div class="gauge-label-compact">Reserva</div>
                    <div class="gauge-bar-compact">
                      <div class="gauge-fill-compact bg-warning"
                        [style.width.%]="kpiData[0].growingMedium.reserveWaterPercentage">
                      </div>
                    </div>
                    <div class="gauge-value-compact">{{ kpiData[0].growingMedium.reserveWaterPercentage | number:'1.1-1'
                      }}%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- AGGREGATION TAB -->
    <div *ngIf="activeTab === 'aggregation'" class="tab-content">

      <!-- AGGREGATION VIEW SELECTOR -->
      <div class="aggregation-controls">
        <div class="view-selector">
          <button class="btn" [class.btn-primary]="currentAggregationView === 'weekly'"
            [class.btn-outline-primary]="currentAggregationView !== 'weekly'" (click)="switchAggregationView('weekly')">
            <i class="bi bi-calendar-week"></i>
            Por Semana
          </button>
          <button class="btn" [class.btn-primary]="currentAggregationView === 'stage'"
            [class.btn-outline-primary]="currentAggregationView !== 'stage'" (click)="switchAggregationView('stage')">
            <i class="bi bi-graph-up-arrow"></i>
            Por Etapa de Crecimiento
          </button>
        </div>

        <!-- Chart Options -->
        <div class="chart-options">
          <label class="form-check-label me-3">
            <input type="checkbox" class="form-check-input" [checked]="aggregationChartConfig.showIrrigation"
              (change)="toggleChartSeries('irrigation')">
            Riego
          </label>
          <label class="form-check-label me-3">
            <input type="checkbox" class="form-check-input" [checked]="aggregationChartConfig.showDrainage"
              (change)="toggleChartSeries('drainage')">
            Drenaje
          </label>
          <label class="form-check-label">
            <input type="checkbox" class="form-check-input" [checked]="aggregationChartConfig.showET"
              (change)="toggleChartSeries('et')">
            ET
          </label>
        </div>
      </div>

      <!-- WEEKLY VIEW -->
      <div *ngIf="currentAggregationView === 'weekly' && weeklyAggregation" class="aggregation-view">

        <!-- Summary Cards -->
        <div class="summary-cards">
          <div class="row g-3 mb-4">
            <div class="col-md-3">
              <div class="summary-card">
                <div class="card-icon">
                  <i class="bi bi-droplet-fill text-primary"></i>
                </div>
                <div class="card-content">
                  <h6>Riego Total</h6>
                  <div class="value">{{ weeklyAggregation.totals.totalIrrigationVolume | number:'1.0-0' }} L</div>
                  <small>{{ weeklyAggregation.totals.totalIrrigationVolume / weeklyAggregation.metadata.area |
                    number:'1.1-1' }} L/m²</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="summary-card">
                <div class="card-icon">
                  <i class="bi bi-funnel-fill text-danger"></i>
                </div>
                <div class="card-content">
                  <h6>Drenaje Total</h6>
                  <div class="value">{{ weeklyAggregation.totals.totalDrainageVolume | number:'1.0-0' }} L</div>
                  <small>{{ weeklyAggregation.totals.averageDrainPercentage | number:'1.1-1' }}% promedio</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="summary-card">
                <div class="card-icon">
                  <i class="bi bi-calendar-week text-success"></i>
                </div>
                <div class="card-content">
                  <h6>Semanas</h6>
                  <div class="value">{{ weeklyAggregation.periods.length }}</div>
                  <small>{{ getWeeklyTotalDays(weeklyAggregation) }} días totales</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="summary-card">
                <div class="card-icon">
                  <i class="bi bi-graph-up text-info"></i>
                </div>
                <div class="card-content">
                  <h6>Eventos de Riego</h6>
                  <div class="value">{{ getWeeklyTotalEvents(weeklyAggregation) }}</div>
                  <small>Promedio por semana: {{ (getWeeklyTotalEvents(weeklyAggregation) /
                    weeklyAggregation.periods.length) | number:'1.1-1' }}</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
          <canvas #weeklyChart></canvas>
        </div>

        <!-- Detailed Table -->
        <div class="detailed-table mt-4">
          <h5 class="section-title">
            <i class="bi bi-table"></i>
            Detalle por Semana
          </h5>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Semana</th>
                  <th>Periodo</th>
                  <th>Días</th>
                  <th>Riego (L)</th>
                  <th>Riego (L/m²)</th>
                  <th>Drenaje (%)</th>
                  <th>Eventos</th>
                  <th>Vol. Promedio</th>
                  <th>Duración Prom.</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let period of weeklyAggregation.periods">
                  <td><strong>{{ period.periodLabel }}</strong></td>
                  <td>
                    <small>
                      {{ period.startDate | date:'dd/MM' }} - {{ period.endDate | date:'dd/MM' }}
                    </small>
                  </td>
                  <td>{{ period.daysInPeriod }}</td>
                  <td>{{ period.irrigation.totalVolume | number:'1.0-0' }}</td>
                  <td>{{ period.irrigation.totalVolumePerM2 | number:'1.2-2' }}</td>
                  <td>
                    <span class="badge"
                      [class.bg-success]="period.drainage.averageDrainPercentage >= 15 && period.drainage.averageDrainPercentage <= 25"
                      [class.bg-warning]="period.drainage.averageDrainPercentage < 15 || period.drainage.averageDrainPercentage > 25"
                      [class.bg-danger]="period.drainage.averageDrainPercentage < 10 || period.drainage.averageDrainPercentage > 35">
                      {{ period.drainage.averageDrainPercentage | number:'1.1-1' }}%
                    </span>
                  </td>
                  <td>{{ period.irrigation.numberOfEvents }}</td>
                  <td>{{ period.irrigation.averageEventVolume | number:'1.1-1' }} L</td>
                  <td>{{ period.irrigation.averageDuration | number:'1.0-0' }} min</td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="table-primary">
                  <th colspan="3">TOTAL</th>
                  <th>{{ weeklyAggregation.totals.totalIrrigationVolume | number:'1.0-0' }}</th>
                  <th>{{ weeklyAggregation.totals.totalIrrigationVolume / weeklyAggregation.metadata.area |
                    number:'1.2-2' }}</th>
                  <th>{{ weeklyAggregation.totals.averageDrainPercentage | number:'1.1-1' }}%</th>
                  <th>{{ getWeeklyTotalEvents(weeklyAggregation) }}</th>
                  <th colspan="2">-</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- GROWTH STAGE VIEW -->
      <div *ngIf="currentAggregationView === 'stage' && stageAggregation" class="aggregation-view">

        <!-- Growth Stage Timeline -->
        <div class="growth-stage-timeline mb-4">
          <div class="timeline-container">
            <div *ngFor="let period of stageAggregation.periods" class="timeline-stage"
              [style.flex]="period.daysInPeriod" [style.background]="period.growthStage?.color + '33'">
              <div class="stage-header" [style.color]="period.growthStage?.color">
                <i class="bi {{ period.growthStage?.icon }}"></i>
                <strong>{{ period.periodLabel }}</strong>
              </div>
              <div class="stage-days">{{ period.daysInPeriod }} días</div>
              <div class="stage-irrigation">
                {{ period.irrigation.totalVolume | number:'1.0-0' }} L
              </div>
            </div>
          </div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
          <canvas #stageChart></canvas>
        </div>

        <!-- Stage Details Cards -->
        <div class="stage-details mt-4">
          <h5 class="section-title">
            <i class="bi bi-info-circle"></i>
            Detalle por Etapa de Crecimiento
          </h5>
          <div class="row g-3">
            <div class="col-md-6" *ngFor="let period of stageAggregation.periods">
              <div class="stage-detail-card" [style.border-left-color]="period.growthStage?.color">
                <div class="stage-header-card">
                  <i class="bi {{ period.growthStage?.icon }}" [style.color]="period.growthStage?.color"></i>
                  <h6>{{ period.periodLabel }}</h6>
                  <span class="stage-badge" [style.background]="period.growthStage?.color">
                    Días {{ period.growthStage?.startDay }} - {{ period.growthStage?.endDay }}
                  </span>
                </div>
                <p class="stage-description">{{ period.growthStage?.description }}</p>

                <div class="stage-metrics">
                  <div class="metric-row">
                    <span class="metric-label">Periodo de datos:</span>
                    <span class="metric-value">
                      {{ period.startDate | date:'dd/MM/yyyy' }} - {{ period.endDate | date:'dd/MM/yyyy' }}
                      ({{ period.daysInPeriod }} días)
                    </span>
                  </div>
                  <div class="metric-row">
                    <span class="metric-label">Riego total:</span>
                    <span class="metric-value">{{ period.irrigation.totalVolume | number:'1.0-0' }} L</span>
                  </div>
                  <div class="metric-row">
                    <span class="metric-label">Promedio diario:</span>
                    <span class="metric-value">{{ period.irrigation.averageDailyVolume | number:'1.1-1' }} L/día</span>
                  </div>
                  <div class="metric-row">
                    <span class="metric-label">Eventos de riego:</span>
                    <span class="metric-value">{{ period.irrigation.numberOfEvents }}</span>
                  </div>
                  <div class="metric-row">
                    <span class="metric-label">Drenaje promedio:</span>
                    <span class="metric-value"
                      [class.text-success]="period.drainage.averageDrainPercentage >= 15 && period.drainage.averageDrainPercentage <= 25"
                      [class.text-warning]="period.drainage.averageDrainPercentage < 15 || period.drainage.averageDrainPercentage > 25">
                      {{ period.drainage.averageDrainPercentage | number:'1.1-1' }}%
                    </span>
                  </div>
                  <div class="metric-row" *ngIf="period.climate">
                    <span class="metric-label">ET promedio:</span>
                    <span class="metric-value">{{ period.climate.averageET | number:'1.2-2' }} mm/día</span>
                  </div>
                  <div class="metric-row" *ngIf="period.climate">
                    <span class="metric-label">VPD promedio:</span>
                    <span class="metric-value">{{ period.climate.averageVPD | number:'1.2-2' }} kPa</span>
                  </div>
                  <div class="metric-row" *ngIf="period.climate">
                    <span class="metric-label">Grados día acumulados:</span>
                    <span class="metric-value">{{ period.climate.totalDegreeDays | number:'1.0-0' }} °C·día</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- NO DATA STATE -->
      <div *ngIf="!weeklyAggregation && !stageAggregation" class="empty-state">
        <div class="empty-icon">
          <i class="bi bi-bar-chart"></i>
        </div>
        <h4>Sin Datos de Agregación</h4>
        <p>Los datos de agregación se calculan automáticamente al procesar los KPIs.</p>
      </div>

    </div>

  </div>

  <!-- Empty State -->
  <div *ngIf="kpiData.length === 0 && !isLoading && !isCalculating" class="empty-state">
    <i class="bi bi-calculator-fill"></i>
    <h3>No hay datos calculados</h3>
    <p>Seleccione los filtros y presione "Calcular KPIs" para generar los resultados</p>
  </div>

</div>

<!-- Detail Modal -->
<div class="modal fade" [class.show]="showDetailModal" [style.display]="showDetailModal ? 'block' : 'none'">
  <div class="modal-dialog modal-xl">
    <div class="modal-content" *ngIf="selectedDayKPI">
      <div class="modal-header bg-gradient-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-info-circle-fill"></i> Detalles Completos KPI - {{ selectedDayKPI.date | date:'fullDate' }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeDetailModal()"></button>
      </div>
      <div class="modal-body">

        <!-- Climate KPIs Section -->
        <div class="detail-section mb-4">
          <h6 class="section-title">
            <i class="bi bi-cloud-sun text-primary"></i> KPIs Climáticos
          </h6>
          <div class="row">
            <div class="col-md-6">
              <div class="detail-group">
                <h6 class="detail-group-title">Evapotranspiración</h6>
                <div class="detail-item">
                  <span class="detail-label">ET Referencia (FAO-56):</span>
                  <span class="detail-value text-primary">{{ selectedDayKPI.climate.referenceET | number:'1.3-3' }}
                    mm/día</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Grados Día:</span>
                  <span class="detail-value">{{ selectedDayKPI.climate.degreesDay | number:'1.2-2' }} °C·día</span>
                </div>
              </div>

              <div class="detail-group">
                <h6 class="detail-group-title">Presión de Vapor</h6>
                <div class="detail-item">
                  <span class="detail-label">Presión Vapor Saturación:</span>
                  <span class="detail-value">{{ selectedDayKPI.climate.saturationVaporPressure | number:'1.3-3' }}
                    kPa</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Presión Vapor Real:</span>
                  <span class="detail-value">{{ selectedDayKPI.climate.realVaporPressure | number:'1.3-3' }} kPa</span>
                </div>
                <div class="detail-item highlight">
                  <span class="detail-label">Déficit Presión Vapor (VPD):</span>
                  <span class="detail-value text-danger">{{ selectedDayKPI.climate.vaporPressureDeficit | number:'1.3-3'
                    }} kPa</span>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="detail-group">
                <h6 class="detail-group-title">Radiación Solar</h6>
                <div class="detail-item">
                  <span class="detail-label">Radiación Extraterrestre:</span>
                  <span class="detail-value">{{ selectedDayKPI.climate.extraterrestrialRadiation | number:'1.2-2' }}
                    MJ/m²/día</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Radiación Cielo Claro:</span>
                  <span class="detail-value">{{ selectedDayKPI.climate.clearSkySolarRadiation | number:'1.2-2' }}
                    MJ/m²/día</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Radiación Solar Neta:</span>
                  <span class="detail-value">{{ selectedDayKPI.climate.netSolarRadiation | number:'1.2-2' }}
                    MJ/m²/día</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Radiación Longwave Neta:</span>
                  <span class="detail-value">{{ selectedDayKPI.climate.netLongwaveRadiation | number:'1.2-2' }}
                    MJ/m²/día</span>
                </div>
                <div class="detail-item highlight">
                  <span class="detail-label">Radiación Neta Total:</span>
                  <span class="detail-value text-success">{{ selectedDayKPI.climate.netRadiation | number:'1.2-2' }}
                    MJ/m²/día</span>
                </div>
              </div>

              <div class="detail-group">
                <h6 class="detail-group-title">Constantes Atmosféricas</h6>
                <div class="detail-item">
                  <span class="detail-label">Constante Psicrométrica:</span>
                  <span class="detail-value">{{ selectedDayKPI.climate.psychrometricConstant | number:'1.4-4' }}
                    kPa/°C</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Pendiente Curva Presión Vapor:</span>
                  <span class="detail-value">{{ selectedDayKPI.climate.slopeVaporPressureCurve | number:'1.4-4' }}
                    kPa/°C</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <hr>

        <!-- Irrigation KPIs Section -->
        <div class="detail-section mb-4">
          <h6 class="section-title">
            <i class="bi bi-droplet-fill text-info"></i> KPIs de Riego
          </h6>
          <div class="row">
            <div class="col-md-4">
              <div class="detail-group">
                <h6 class="detail-group-title">Volúmenes</h6>
                <div class="detail-item">
                  <span class="detail-label">Volumen Total Aplicado:</span>
                  <span class="detail-value text-info">{{ selectedDayKPI.irrigation.totalVolume | number:'1.1-1' }}
                    L</span>
                </div>
                <div class="detail-item" *ngIf="selectedDayKPI.cropEvapoTranspiration">
                  <span class="detail-label">ET Cultivo:</span>
                  <span class="detail-value">{{ selectedDayKPI.cropEvapoTranspiration | number:'1.2-2' }} mm/día</span>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="detail-group">
                <h6 class="detail-group-title">Duración</h6>
                <div class="detail-item">
                  <span class="detail-label">Tiempo Total Riego:</span>
                  <span class="detail-value">{{ selectedDayKPI.irrigation.totalDuration | number:'1.0-0' }}
                    minutos</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Eventos de Riego:</span>
                  <span class="detail-value">{{ selectedDayKPI.irrigation.metrics.length }}</span>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="detail-group">
                <h6 class="detail-group-title">Eficiencia</h6>
                <div class="detail-item">
                  <span class="detail-label">% Drenaje Promedio:</span>
                  <span class="detail-value"
                    [class.text-success]="selectedDayKPI.irrigation.averageDrainPercentage < 20"
                    [class.text-warning]="selectedDayKPI.irrigation.averageDrainPercentage >= 20 && selectedDayKPI.irrigation.averageDrainPercentage < 30"
                    [class.text-danger]="selectedDayKPI.irrigation.averageDrainPercentage >= 30">
                    {{ selectedDayKPI.irrigation.averageDrainPercentage | number:'1.1-1' }}%
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <hr>

        <!-- Crop Production KPIs Section -->
        <div class="detail-section mb-4">
          <h6 class="section-title">
            <i class="bi bi-flower1 text-success"></i> Información del Cultivo
          </h6>
          <div class="row">
            <div class="col-md-6">
              <div class="detail-group">
                <h6 class="detail-group-title">Dimensiones</h6>
                <div class="detail-item">
                  <span class="detail-label">Área Total:</span>
                  <span class="detail-value">{{ selectedDayKPI.crop.area | number:'1.2-2' }} m²</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Número de Hileras:</span>
                  <span class="detail-value">{{ selectedDayKPI.crop.numberOfRows }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Coordenadas:</span>
                  <span class="detail-value">{{ selectedDayKPI.crop.latitudeGrades }}° {{
                    selectedDayKPI.crop.latitudeMinutes }}'</span>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="detail-group">
                <h6 class="detail-group-title">Densidades y Plantas</h6>
                <div class="detail-item">
                  <span class="detail-label">Densidad Plantas:</span>
                  <span class="detail-value">{{ selectedDayKPI.crop.densityPlant | number:'1.2-2' }} plantas/m²</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Densidad Contenedores:</span>
                  <span class="detail-value">{{ selectedDayKPI.crop.densityContainer | number:'1.2-2' }} cont/m²</span>
                </div>
                <div class="detail-item highlight">
                  <span class="detail-label">Total Plantas:</span>
                  <span class="detail-value text-success">{{ selectedDayKPI.crop.totalPlants | number:'1.0-0' }}</span>
                </div>
                <div class="detail-item" *ngIf="selectedDayKPI.crop.containerVolume">
                  <span class="detail-label">Volumen Contenedor:</span>
                  <span class="detail-value">{{ selectedDayKPI.crop.containerVolume.value | number:'1.2-2' }} L</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <hr>

        <!-- Growing Medium KPIs Section -->
        <div class="detail-section">
          <h6 class="section-title">
            <i class="bi bi-moisture text-warning"></i> Medio de Crecimiento - Balance Hídrico
          </h6>
          <div class="row">
            <div class="col-md-4">
              <div class="water-gauge">
                <div class="gauge-label">Agua Total Disponible</div>
                <div class="gauge-value">{{ selectedDayKPI.growingMedium.totalAvailableWaterPercentage | number:'1.1-1'
                  }}%</div>
                <div class="gauge-bar">
                  <div class="gauge-fill bg-info"
                    [style.width.%]="selectedDayKPI.growingMedium.totalAvailableWaterPercentage"></div>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="water-gauge">
                <div class="gauge-label">Agua Fácilmente Disponible</div>
                <div class="gauge-value">{{ selectedDayKPI.growingMedium.easelyAvailableWaterPercentage | number:'1.1-1'
                  }}%</div>
                <div class="gauge-bar">
                  <div class="gauge-fill bg-success"
                    [style.width.%]="selectedDayKPI.growingMedium.easelyAvailableWaterPercentage"></div>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="water-gauge">
                <div class="gauge-label">Agua de Reserva</div>
                <div class="gauge-value">{{ selectedDayKPI.growingMedium.reserveWaterPercentage | number:'1.1-1' }}%
                </div>
                <div class="gauge-bar">
                  <div class="gauge-fill bg-warning"
                    [style.width.%]="selectedDayKPI.growingMedium.reserveWaterPercentage"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Water Balance Explanation -->
          <div class="alert alert-info mt-3" role="alert">
            <small>
              <strong>Balance Hídrico:</strong>
              El agua total disponible es la diferencia entre la capacidad del contenedor y el punto de marchitez
              permanente.
              El agua fácilmente disponible es la que las plantas pueden absorber sin estrés.
              El agua de reserva requiere mayor esfuerzo de las plantas para ser absorbida.
            </small>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeDetailModal()">
          <i class="bi bi-x-circle"></i> Cerrar
        </button>
        <button type="button" class="btn btn-primary" (click)="exportDayToJSON(selectedDayKPI)">
          <i class="bi bi-download"></i> Exportar JSON
        </button>
      </div>
    </div>
  </div>


</div>
<div class="modal-backdrop fade" [class.show]="showDetailModal" *ngIf="showDetailModal"></div>