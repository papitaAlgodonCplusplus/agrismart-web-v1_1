<!-- src/app/features/irrigation/on-demand-irrigation.component.html -->
<div class="on-demand-irrigation-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1><i class="fas fa-tint"></i> Riego Bajo Demanda</h1>
      <p class="lead">Ejecute planes de riego inmediatamente o programe para horarios específicos</p>
    </div>
    <div class="header-actions">
      <button 
        class="btn btn-primary"
        (click)="showExecutionDialog()"
        [disabled]="isLoading || !onDemandMode">
        <i class="fas fa-play"></i> Ejecutar Riego
      </button>
      <button 
        class="btn btn-secondary"
        (click)="loadOnDemandEntries()"
        [disabled]="isLoading">
        <i class="fas fa-sync-alt"></i> Actualizar
      </button>
    </div>
  </div>

  <!-- Messages -->
  <div class="messages" *ngIf="errorMessage || successMessage">
    <div class="alert alert-success" *ngIf="successMessage">
      <i class="fas fa-check-circle"></i>
      {{ successMessage }}
    </div>
    <div class="alert alert-danger" *ngIf="errorMessage">
      <i class="fas fa-exclamation-circle"></i>
      {{ errorMessage }}
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Cargando datos de riego bajo demanda...</p>
  </div>

  <!-- Main Content -->
  <div class="content-wrapper" *ngIf="!isLoading">
    
    <!-- Statistics Cards -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-icon blue">
          <i class="fas fa-clipboard-list"></i>
        </div>
        <div class="stat-content">
          <h3>{{ onDemandEntries.length }}</h3>
          <p>Total de Ejecuciones</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon green">
          <i class="fas fa-play-circle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getActiveExecutions().length }}</h3>
          <p>Activas Ahora</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon orange">
          <i class="fas fa-calendar-day"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getTodayExecutionCount() }}</h3>
          <p>Ejecuciones de Hoy</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon purple">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <h3>{{ formatDuration(getTodayTotalDuration()) }}</h3>
          <p>Duración Total Hoy</p>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card quick-actions-card">
      <div class="card-header">
        <h5><i class="fas fa-bolt"></i> Acciones Rápidas</h5>
      </div>
      <div class="card-body">
        <p class="text-muted mb-3">Seleccione un plan de riego e inicie inmediatamente:</p>
        <div class="quick-action-buttons">
          <div class="plan-quick-actions" *ngFor="let plan of irrigationPlans">
            <div class="plan-name">{{ plan.name }}</div>
            <div class="duration-buttons">
              <button 
                class="btn btn-sm btn-outline-primary"
                (click)="quickExecute(plan.id, 15)"
                [disabled]="isExecuting">
                15 min
              </button>
              <button 
                class="btn btn-sm btn-outline-primary"
                (click)="quickExecute(plan.id, 30)"
                [disabled]="isExecuting">
                30 min
              </button>
              <button 
                class="btn btn-sm btn-outline-primary"
                (click)="quickExecute(plan.id, 60)"
                [disabled]="isExecuting">
                1 hora
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Active Executions -->
    <div class="card active-executions-card" *ngIf="getActiveExecutions().length > 0">
      <div class="card-header bg-success text-white">
        <h5><i class="fas fa-water"></i> Riegos Activos</h5>
      </div>
      <div class="card-body">
        <div class="active-execution-list">
          <div class="active-execution-item" *ngFor="let entry of getActiveExecutions()">
            <div class="execution-info">
              <h6>{{ getIrrigationPlanName(entry.irrigationPlanId) }}</h6>
              <p class="mb-1">
                <i class="fas fa-clock"></i> Iniciado: {{ formatTime(entry.startTime) }}
              </p>
              <p class="mb-0">
                <i class="fas fa-hourglass-half"></i> {{ getEntryStatus(entry) }}
              </p>
            </div>
            <div class="execution-badge">
              <span class="badge badge-success">
                <i class="fas fa-play"></i> En Ejecución
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Execution History -->
    <div class="card history-card">
      <div class="card-header">
        <h5><i class="fas fa-history"></i> Historial de Ejecuciones</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive" *ngIf="onDemandEntries.length > 0; else noEntries">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Plan de Riego</th>
                <th>Hora de Inicio</th>
                <th>Duración</th>
                <th>Ejecutado En</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let entry of onDemandEntries">
                <td>
                  <strong>{{ getIrrigationPlanName(entry.irrigationPlanId) }}</strong>
                </td>
                <td>
                  <i class="fas fa-clock"></i> {{ formatTime(entry.startTime) }}
                </td>
                <td>
                  <span class="badge badge-info">{{ formatDuration(entry.duration) }}</span>
                </td>
                <td>{{ formatDateTime(entry.dateCreated) }}</td>
                <td>
                  <span class="badge" [ngClass]="getStatusClass(entry)">
                    {{ getEntryStatus(entry) }}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    <button 
                      class="btn btn-sm btn-outline-info"
                      (click)="viewEntryDetails(entry)"
                      title="Ver Detalles">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button 
                      class="btn btn-sm btn-outline-danger"
                      (click)="deleteEntry(entry)"
                      [disabled]="getEntryStatus(entry).includes('Active')"
                      title="Eliminar">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <ng-template #noEntries>
          <div class="no-data">
            <i class="fas fa-inbox"></i>
            <p>No hay historial de ejecuciones disponible</p>
            <button class="btn btn-primary" (click)="showExecutionDialog()">
              <i class="fas fa-play"></i> Ejecutar Primer Riego
            </button>
          </div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Execution Form Modal -->
  <div class="modal-backdrop" *ngIf="showExecutionForm" (click)="cancelExecution()"></div>
  <div class="modal-dialog" *ngIf="showExecutionForm">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-play-circle"></i> Ejecutar Riego Bajo Demanda
        </h5>
        <button type="button" class="close-btn" (click)="cancelExecution()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form [formGroup]="executionForm" (ngSubmit)="executeOnDemandIrrigation()">
        <div class="modal-body">
          
          <!-- Irrigation Plan Selection -->
          <div class="form-group">
            <label for="irrigationPlanId">
              <i class="fas fa-clipboard-list"></i> Plan de Riego *
            </label>
            <select 
              class="form-control"
              id="irrigationPlanId"
              formControlName="irrigationPlanId"
              required>
              <option value="">Seleccione un plan de riego</option>
              <option *ngFor="let plan of irrigationPlans" [value]="plan.id">
                {{ plan.name }}
              </option>
            </select>
            <div class="invalid-feedback" *ngIf="executionForm.get('irrigationPlanId')?.invalid && executionForm.get('irrigationPlanId')?.touched">
              Por favor seleccione un plan de riego
            </div>
          </div>

          <!-- Farm Filter (Optional) -->
          <div class="form-group">
            <label for="farmId">
              <i class="fas fa-map-marked-alt"></i> Finca (Filtro Opcional)
            </label>
            <select 
              class="form-control"
              id="farmId"
              formControlName="farmId"
              (change)="onFarmChange($any($event.target).value)">
              <option [value]="null">Todas las Fincas</option>
              <option *ngFor="let farm of farms" [value]="farm.id">
                {{ farm.name }}
              </option>
            </select>
          </div>

          <!-- Crop Production Filter (Optional) -->
          <div class="form-group">
            <label for="cropProductionId">
              <i class="fas fa-seedling"></i> Producción de Cultivo (Filtro Opcional)
            </label>
            <select 
              class="form-control"
              id="cropProductionId"
              formControlName="cropProductionId">
              <option [value]="null">Todas las Producciones</option>
              <option *ngFor="let production of filteredCropProductions" [value]="production.id">
                {{ production.name || 'Producción #' + production.id }}
              </option>
            </select>
          </div>

          <!-- Start Time -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="startHours">
                  <i class="fas fa-clock"></i> Hora de Inicio *
                </label>
                <input 
                  type="number"
                  class="form-control"
                  id="startHours"
                  formControlName="startHours"
                  min="0"
                  max="23"
                  placeholder="0-23">
                <div class="invalid-feedback" *ngIf="executionForm.get('startHours')?.invalid && executionForm.get('startHours')?.touched">
                  La hora debe estar entre 0 y 23
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="startMinutes">
                  <i class="fas fa-clock"></i> Minuto de Inicio *
                </label>
                <input 
                  type="number"
                  class="form-control"
                  id="startMinutes"
                  formControlName="startMinutes"
                  min="0"
                  max="59"
                  placeholder="0-59">
                <div class="invalid-feedback" *ngIf="executionForm.get('startMinutes')?.invalid && executionForm.get('startMinutes')?.touched">
                  El minuto debe estar entre 0 y 59
                </div>
              </div>
            </div>
          </div>

          <!-- Duration -->
          <div class="form-group">
            <label for="duration">
              <i class="fas fa-hourglass-half"></i> Duración (minutos) *
            </label>
            <input 
              type="number"
              class="form-control"
              id="duration"
              formControlName="duration"
              min="1"
              max="240"
              placeholder="Ingrese la duración en minutos">
            <small class="form-text text-muted">
              Actual: {{ formatDuration(executionForm.get('duration')?.value || 0) }}
            </small>
            <div class="invalid-feedback" *ngIf="executionForm.get('duration')?.invalid && executionForm.get('duration')?.touched">
              La duración debe estar entre 1 y 240 minutos
            </div>
          </div>

          <!-- Sequence -->
          <div class="form-group">
            <label for="sequence">
              <i class="fas fa-sort-numeric-up"></i> Secuencia *
            </label>
            <input 
              type="number"
              class="form-control"
              id="sequence"
              formControlName="sequence"
              min="1"
              placeholder="Secuencia de ejecución">
            <small class="form-text text-muted">
              Orden de ejecución si existen múltiples entradas
            </small>
          </div>

          <!-- Notes -->
          <div class="form-group">
            <label for="notes">
              <i class="fas fa-sticky-note"></i> Notas (Opcional)
            </label>
            <textarea 
              class="form-control"
              id="notes"
              formControlName="notes"
              rows="3"
              placeholder="Agregue cualquier nota sobre esta ejecución..."></textarea>
          </div>

        </div>

        <div class="modal-footer">
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="cancelExecution()"
            [disabled]="isExecuting">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="executionForm.invalid || isExecuting">
            <i class="fas fa-spinner fa-spin" *ngIf="isExecuting"></i>
            <i class="fas fa-play" *ngIf="!isExecuting"></i>
            {{ isExecuting ? 'Ejecutando...' : 'Ejecutar Ahora' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Entry Details Modal -->
  <div class="modal-backdrop" *ngIf="selectedEntry" (click)="closeEntryDetails()"></div>
  <div class="modal-dialog" *ngIf="selectedEntry">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-info-circle"></i> Detalles de Ejecución
        </h5>
        <button type="button" class="close-btn" (click)="closeEntryDetails()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="detail-grid">
          <div class="detail-item">
            <label><i class="fas fa-clipboard-list"></i> Plan de Riego:</label>
            <span>{{ getIrrigationPlanName(selectedEntry.irrigationPlanId) }}</span>
          </div>

          <div class="detail-item">
            <label><i class="fas fa-clock"></i> Hora de Inicio:</label>
            <span>{{ formatTime(selectedEntry.startTime) }}</span>
          </div>

          <div class="detail-item">
            <label><i class="fas fa-hourglass-half"></i> Duración:</label>
            <span>{{ formatDuration(selectedEntry.duration) }}</span>
          </div>

          <div class="detail-item">
            <label><i class="fas fa-calendar-alt"></i> Ejecutado En:</label>
            <span>{{ formatDateTime(selectedEntry.dateCreated) }}</span>
          </div>

          <div class="detail-item">
            <label><i class="fas fa-info-circle"></i> Estado:</label>
            <span class="badge" [ngClass]="getStatusClass(selectedEntry)">
              {{ getEntryStatus(selectedEntry) }}
            </span>
          </div>

          <div class="detail-item">
            <label><i class="fas fa-sort-numeric-up"></i> Secuencia:</label>
            <span>{{ selectedEntry.sequence }}</span>
          </div>

          <div class="detail-item">
            <label><i class="fas fa-toggle-on"></i> Activo:</label>
            <span>
              <span class="badge" [class.badge-success]="selectedEntry.active" [class.badge-secondary]="!selectedEntry.active">
                {{ selectedEntry.active ? 'Sí' : 'No' }}
              </span>
            </span>
          </div>

          <div class="detail-item" *ngIf="selectedEntry.dateUpdated">
            <label><i class="fas fa-calendar-check"></i> Última Actualización:</label>
            <span>{{ formatDateTime(selectedEntry.dateUpdated) }}</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn-secondary"
          (click)="closeEntryDetails()">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
    </div>
  </div>

</div>