<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1>Irrigation System Dashboard</h1>
    <div class="header-controls">
      <button class="chart-toggle-btn" (click)="toggleCharts()">
        {{ showCharts ? 'Hide Charts' : 'Show Charts' }}
      </button>
      <button class="refresh-btn" (click)="refreshData()" [disabled]="isLoading">
        {{ isLoading ? 'Loading...' : 'Refresh Data' }}
      </button>
    </div>
  </div>

  <!-- System Overview -->
  <div *ngIf="!isLoading && !error" class="system-overview">
    <div class="overview-card">
      <h3>Flow Meters</h3>
      <div class="status-summary">
        <span class="status-item online">{{ getDeviceTypeSummary(flowDevices).online }} Online</span>
        <span class="status-item warning">{{ getDeviceTypeSummary(flowDevices).warning }} Warning</span>
        <span class="status-item offline">{{ getDeviceTypeSummary(flowDevices).offline }} Offline</span>
      </div>
    </div>
    <div class="overview-card">
      <h3>Soil Sensors</h3>
      <div class="status-summary">
        <span class="status-item online">{{ getDeviceTypeSummary(soilDevices).online }} Online</span>
        <span class="status-item warning">{{ getDeviceTypeSummary(soilDevices).warning }} Warning</span>
        <span class="status-item offline">{{ getDeviceTypeSummary(soilDevices).offline }} Offline</span>
      </div>
    </div>
    <div class="overview-card">
      <h3>Climate Stations</h3>
      <div class="status-summary">
        <span class="status-item online">{{ getDeviceTypeSummary(climateDevices).online }} Online</span>
        <span class="status-item warning">{{ getDeviceTypeSummary(climateDevices).warning }} Warning</span>
        <span class="status-item offline">{{ getDeviceTypeSummary(climateDevices).offline }} Offline</span>
      </div>
    </div>
    <div class="overview-card">
      <h3>Pressure Sensors</h3>
      <div class="status-summary">
        <span class="status-item online">{{ getDeviceTypeSummary(pressureDevices).online }} Online</span>
        <span class="status-item warning">{{ getDeviceTypeSummary(pressureDevices).warning }} Warning</span>
        <span class="status-item offline">{{ getDeviceTypeSummary(pressureDevices).offline }} Offline</span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading device data...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-state">
    <p class="error-message">{{ error }}</p>
    <button class="retry-btn" (click)="refreshData()">Retry</button>
  </div>

  <!-- Charts Section -->
  <div *ngIf="showCharts && !isLoading && !error" class="charts-section">
    <div class="charts-header">
      <h2>Historical Data Charts</h2>
      <div class="chart-type-selector">
        <button 
          *ngFor="let type of getAvailableChartTypes()" 
          [class]="'chart-type-btn ' + (selectedChartType === type ? 'active' : '')"
          (click)="selectChartType(type)">
          {{ getChartTypeLabel(type) }}
        </button>
      </div>
    </div>
    
    <div class="charts-grid">
      <div *ngFor="let chartType of getChartsForType(selectedChartType)" class="chart-container">
        <div class="chart-header">
          <h3>{{ chartType }} {{ getSensorUnit(chartType) ? '(' + getSensorUnit(chartType) + ')' : '' }}</h3>
        </div>
        <div class="chart-content">
          <canvas class="mini-chart" [id]="'chart-' + selectedChartType + '-' + chartType"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!isLoading && !error" class="dashboard-content">
    
    <!-- Flow Meters Section -->
    <div class="dashboard-section">
      <h2>Flow Meters</h2>
      <div class="devices-grid">
        <div *ngFor="let device of flowDevices" class="device-card" [class]="getStatusClass(getDeviceStatus(device))">
          <div class="device-header">
            <h3>{{ device.deviceId }}</h3>
            <span class="status-indicator"></span>
          </div>
          <div class="device-content">
            <div class="reading" *ngIf="hasNumericReading(device, 'Water_flow_value')">
              <span class="label">Flow Value:</span>
              <span class="value">{{ getReadingValue(device, 'Water_flow_value') }}</span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'MOD')">
              <span class="label">Flow Rate:</span>
              <span class="value">{{ getReadingValue(device, 'MOD') }}</span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'Total_pulse')">
              <span class="label">Total Pulse:</span>
              <span class="value">{{ getReadingValue(device, 'Total_pulse') }}</span>
            </div>
            <div class="reading">
              <span class="label">Alarm:</span>
              <span class="value alarm-status" [class]="getRawReadingValue(device, 'Alarm') === 'FALSE' ? 'alarm-ok' : 'alarm-active'">
                {{ getRawReadingValue(device, 'Alarm') }}
              </span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'Calculate_flag')">
              <span class="label">Calculate Flag:</span>
              <span class="value">{{ getReadingValue(device, 'Calculate_flag') }}</span>
            </div>
            <div class="reading">
              <span class="label">Last Update:</span>
              <span class="value">{{ formatDate(device.lastUpdate) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Soil Sensors Section -->
    <div class="dashboard-section">
      <h2>Soil Sensors</h2>
      <div class="devices-grid">
        <div *ngFor="let device of soilDevices" class="device-card" [class]="getStatusClass(getDeviceStatus(device))">
          <div class="device-header">
            <h3>{{ device.deviceId }}</h3>
            <span class="status-indicator"></span>
          </div>
          <div class="device-content">
            <div class="reading" *ngIf="hasNumericReading(device, 'water_SOIL')">
              <span class="label">Soil Moisture:</span>
              <span class="value">{{ getReadingValue(device, 'water_SOIL') }}</span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'conduct_SOIL')">
              <span class="label">Conductivity:</span>
              <span class="value">{{ getReadingValue(device, 'conduct_SOIL') }}</span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'temp_DS18B20')">
              <span class="label">Temperature:</span>
              <span class="value">{{ getReadingValue(device, 'temp_DS18B20') }}</span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'TEMP_SOIL')">
              <span class="label">Soil Temperature:</span>
              <span class="value">{{ getReadingValue(device, 'TEMP_SOIL') }}</span>
            </div>
            <div class="reading">
              <span class="label">Last Update:</span>
              <span class="value">{{ formatDate(device.lastUpdate) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- pH Sensors Section -->
    <div class="dashboard-section">
      <h2>pH Sensors</h2>
      <div class="devices-grid">
        <div *ngFor="let device of phDevices" class="device-card" [class]="getStatusClass(getDeviceStatus(device))">
          <div class="device-header">
            <h3>{{ device.deviceId }}</h3>
            <span class="status-indicator"></span>
          </div>
          <div class="device-content">
            <div class="reading" *ngIf="hasNumericReading(device, 'PH1_SOIL')">
              <span class="label">pH Level:</span>
              <span class="value ph-value" [class]="getPhClass(device.readings['PH1_SOIL'] && device.readings['PH1_SOIL'].value != null ? device.readings['PH1_SOIL'].value : null)">
                {{ getReadingValue(device, 'PH1_SOIL') }}
              </span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'PH_SOIL')">
              <span class="label">pH Level:</span>
              <span class="value ph-value" [class]="getPhClass(device.readings['PH1_SOIL'] && device.readings['PH1_SOIL'].value != null ? device.readings['PH1_SOIL'].value : null)">
                {{ getReadingValue(device, 'PH_SOIL') }}
              </span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'TEMP_SOIL')">
              <span class="label">Soil Temperature:</span>
              <span class="value">{{ getReadingValue(device, 'TEMP_SOIL') }}</span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'Bat')">
              <span class="label">Battery:</span>
              <span class="value battery-level" [class]="getBatteryClass(device.readings['Bat'] && device.readings['Bat'].value != undefined ? device.readings['Bat'].value : null)">
                {{ getReadingValue(device, 'Bat') }}
              </span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'Message_type')">
              <span class="label">Message Type:</span>
              <span class="value">{{ getReadingValue(device, 'Message_type') }}</span>
            </div>
            <div class="reading">
              <span class="label">Last Update:</span>
              <span class="value">{{ formatDate(device.lastUpdate) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pressure Sensors Section -->
    <div class="dashboard-section">
      <h2>Pressure Sensors</h2>
      <div class="devices-grid">
        <div *ngFor="let device of pressureDevices" class="device-card" [class]="getStatusClass(getDeviceStatus(device))">
          <div class="device-header">
            <h3>{{ device.deviceId }}</h3>
            <span class="status-indicator"></span>
          </div>
          <div class="device-content">
            <div class="reading" *ngIf="hasNumericReading(device, 'IDC_intput_mA')">
              <span class="label">Current Input:</span>
              <span class="value">{{ getReadingValue(device, 'IDC_intput_mA') }}</span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'VDC_intput_V')">
              <span class="label">Voltage Input:</span>
              <span class="value">{{ getReadingValue(device, 'VDC_intput_V') }}</span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'Water_pressure_MPa')">
              <span class="label">Water Pressure:</span>
              <span class="value">{{ getReadingValue(device, 'Water_pressure_MPa') }}</span>
            </div>
            <div class="reading">
              <span class="label">External Status:</span>
              <span class="value status-value" [class]="getRawReadingValue(device, 'Exti_status') === 'False' ? 'status-inactive' : 'status-active'">
                {{ getRawReadingValue(device, 'Exti_status') }}
              </span>
            </div>
            <div class="reading">
              <span class="label">Input Pin Level:</span>
              <span class="value">{{ getRawReadingValue(device, 'IN2_pin_level') }}</span>
            </div>
            <div class="reading">
              <span class="label">External Pin Level:</span>
              <span class="value">{{ getRawReadingValue(device, 'Exti_pin_level') }}</span>
            </div>
            <div class="reading" *ngIf="hasNumericReading(device, 'Probe_mod')">
              <span class="label">Probe Mode:</span>
              <span class="value">{{ getReadingValue(device, 'Probe_mod') }}</span>
            </div>
            <div class="reading">
              <span class="label">Last Update:</span>
              <span class="value">{{ formatDate(device.lastUpdate) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Climate Station Section -->
    <div class="dashboard-section">
      <h2>Climate Station</h2>
      <div class="devices-grid">
        <div *ngFor="let device of climateDevices" class="device-card climate-card" [class]="getStatusClass(getDeviceStatus(device))">
          <div class="device-header">
            <h3>{{ device.deviceId }}</h3>
            <span class="status-indicator"></span>
          </div>
          <div class="device-content">
            <div class="reading-grid">
              <div class="reading" *ngIf="hasNumericReading(device, 'TEM')">
                <span class="label">Temperature:</span>
                <span class="value temp-value" [class]="getTempClass(device.readings['TEM'] && device.readings['TEM'].value != undefined ? device.readings['TEM'].value : null)">
                  {{ getReadingValue(device, 'TEM') }}
                </span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'HUM')">
                <span class="label">Humidity:</span>
                <span class="value humidity-value" [class]="getHumidityClass(device.readings['HUM'] && device.readings['HUM'].value != undefined ? device.readings['HUM'].value : null)">
                  {{ getReadingValue(device, 'HUM') }}
                </span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'wind_direction_angle')">
                <span class="label">Wind Direction:</span>
                <span class="value">{{ getReadingValue(device, 'wind_direction_angle') }}</span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'wind_speed')">
                <span class="label">Wind Speed:</span>
                <span class="value wind-value" [class]="getWindClass(device.readings['wind_speed'] && device.readings['wind_speed'].value != undefined ? device.readings['wind_speed'].value : null)">
                  {{ getReadingValue(device, 'wind_speed') }}
                </span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'pressure')">
                <span class="label">Atmospheric Pressure:</span>
                <span class="value">{{ getReadingValue(device, 'pressure') }}</span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'rain_gauge')">
                <span class="label">Rainfall:</span>
                <span class="value rain-value" [class]="getRainClass(device.readings['rain_gauge'] && device.readings['rain_gauge'].value != undefined ? device.readings['rain_gauge'].value : null)">
                  {{ getReadingValue(device, 'rain_gauge') }}
                </span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'PAR')">
                <span class="label">PAR (Photosynthetic Active Radiation):</span>
                <span class="value">{{ getReadingValue(device, 'PAR') }}</span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'illumination')">
                <span class="label">Illumination:</span>
                <span class="value">{{ getReadingValue(device, 'illumination') }}</span>
              </div>
            </div>
            <div class="reading">
              <span class="label">Last Update:</span>
              <span class="value">{{ formatDate(device.lastUpdate) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>