<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1>Panel de Control del Sistema de Riego</h1>
    <div class="header-controls">
      <button class="btn btn-secondary me-2" (click)="goToDashboard()">
        <i class="bi bi-arrow-left"></i>
        Regresar al Dashboard
      </button>
      <button class="chart-toggle-btn" (click)="toggleCharts()">
        {{ showCharts ? 'Ocultar Gr√°ficos' : 'Mostrar Gr√°ficos' }}
      </button>
      <button class="refresh-btn" (click)="refreshData()" [disabled]="isLoading">
        {{ isLoading ? 'Cargando...' : 'Actualizar Datos' }}
      </button>
    </div>
  </div>

  <!-- Device Activity Summary -->
  <div *ngIf="!isLoading && !error" class="device-activity-summary">
    <div class="activity-overview">
      <div class="activity-card total">
        <h3>Total de Dispositivos</h3>
        <div class="activity-number">{{ getTotalRegisteredDevices() }}</div>
      </div>
      <div class="activity-card active">
        <h3>Dispositivos Activos</h3>
        <div class="activity-number">{{ getTotalActiveDevices() }}</div>
        <div class="activity-percentage">{{ getDeviceActivityPercentage().toFixed(1) }}% del total</div>
      </div>
      <div class="activity-card inactive">
        <h3>Dispositivos Inactivos</h3>
        <div class="activity-number">{{ getTotalInactiveDevices() }}</div>
        <div class="activity-percentage">{{ (100 - getDeviceActivityPercentage()).toFixed(1) }}% del total</div>
      </div>
    </div>
  </div>

  <!-- System Overview -->
  <div *ngIf="!isLoading && !error" class="system-overview">
    <div class="overview-card">
      <h3>Medidores de Flujo</h3>
      <div class="status-summary">
        <span class="status-item online">{{ getDeviceTypeSummary(flowDevices).online }} En L√≠nea</span>
        <span class="status-item warning">{{ getDeviceTypeSummary(flowDevices).warning }} Advertencia</span>
        <span class="status-item offline">{{ getDeviceTypeSummary(flowDevices).offline }} Desconectado</span>
        <span class="status-item inactive">{{ getDeviceTypeSummary(flowDevices).inactive }} Inactivo</span>
      </div>
    </div>
    <div class="overview-card">
      <h3>Sensores de Suelo</h3>
      <div class="status-summary">
        <span class="status-item online">{{ getDeviceTypeSummary(soilDevices).online }} En L√≠nea</span>
        <span class="status-item warning">{{ getDeviceTypeSummary(soilDevices).warning }} Advertencia</span>
        <span class="status-item offline">{{ getDeviceTypeSummary(soilDevices).offline }} Desconectado</span>
        <span class="status-item inactive">{{ getDeviceTypeSummary(soilDevices).inactive }} Inactivo</span>
      </div>
    </div>
    <div class="overview-card">
      <h3>Estaciones Clim√°ticas</h3>
      <div class="status-summary">
        <span class="status-item online">{{ getDeviceTypeSummary(climateDevices).online }} En L√≠nea</span>
        <span class="status-item warning">{{ getDeviceTypeSummary(climateDevices).warning }} Advertencia</span>
        <span class="status-item offline">{{ getDeviceTypeSummary(climateDevices).offline }} Desconectado</span>
        <span class="status-item inactive">{{ getDeviceTypeSummary(climateDevices).inactive }} Inactivo</span>
      </div>
    </div>
    <div class="overview-card">
      <h3>Sensores de Presi√≥n</h3>
      <div class="status-summary">
        <span class="status-item online">{{ getDeviceTypeSummary(pressureDevices).online }} En L√≠nea</span>
        <span class="status-item warning">{{ getDeviceTypeSummary(pressureDevices).warning }} Advertencia</span>
        <span class="status-item offline">{{ getDeviceTypeSummary(pressureDevices).offline }} Desconectado</span>
        <span class="status-item inactive">{{ getDeviceTypeSummary(pressureDevices).inactive }} Inactivo</span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando datos de dispositivos...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-state">
    <p class="error-message">{{ error }}</p>
    <button class="retry-btn" (click)="refreshData()">Reintentar</button>
  </div>

  <!-- Charts Section -->
  <div *ngIf="showCharts && !isLoading && !error" class="card mb-4">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-graph-up"></i> Gr√°ficos de Datos Hist√≥ricos
        </h5>
        <button class="btn btn-sm btn-light" (click)="toggleHistoricalCharts()">
          <i class="bi" [class.bi-chevron-down]="isChartsCollapsed"
             [class.bi-chevron-up]="!isChartsCollapsed"></i>
          {{ isChartsCollapsed ? 'Expandir' : 'Contraer' }}
        </button>
      </div>
    </div>
    <div class="card-body" *ngIf="!isChartsCollapsed">
      <div class="charts-section">
        <div class="chart-type-selector">
          <button *ngFor="let type of getAvailableChartTypes()"
            [class]="'chart-type-btn ' + (selectedChartType === type ? 'active' : '')" (click)="selectChartType(type)">
            {{ getChartTypeLabel(type) }}
          </button>
        </div>

        <div class="charts-grid">
          <div *ngFor="let chartType of getChartsForType(selectedChartType)" class="chart-container">
            <div class="chart-header">
              <h3>{{ chartType }} {{ getSensorUnit(chartType) ? '(' + getSensorUnit(chartType) + ')' : '' }}</h3>
            </div>
            <div class="chart-content">
              <canvas class="mini-chart" [id]="'chart-' + selectedChartType + '-' + chartType"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showCharts && !isLoading && !error">

    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-wind"></i> Rosa de Vientos
          </h5>
          <button class="btn btn-sm btn-light" (click)="toggleWindRose()">
            <i class="bi" [class.bi-chevron-down]="isWindRoseCollapsed"
               [class.bi-chevron-up]="!isWindRoseCollapsed"></i>
            {{ isWindRoseCollapsed ? 'Expandir' : 'Contraer' }}
          </button>
        </div>
      </div>
      <div class="card-body" *ngIf="!isWindRoseCollapsed">
        <div class="chart-card wind-rose-card">
          <div class="chart-info">
            <small>Distribuci√≥n de velocidad y direcci√≥n del viento</small>
          </div>

      <div class="chart-content custom-wind-rose-container" *ngIf="windRoseSegments.length > 0">
        <svg [attr.width]="windRoseConfig.size" [attr.height]="windRoseConfig.size"
          [attr.viewBox]="'0 0 ' + windRoseConfig.size + ' ' + windRoseConfig.size" class="wind-rose-svg">

          <!-- Gradients definitions -->
          <defs>
            <radialGradient id="centerGradient" cx="50%" cy="50%" r="50%">
              <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#e8eaf6;stop-opacity:1" />
            </radialGradient>
            <filter id="glow">
              <feGaussianBlur stdDeviation="3" result="coloredBlur" />
              <feMerge>
                <feMergeNode in="coloredBlur" />
                <feMergeNode in="SourceGraphic" />
              </feMerge>
            </filter>
          </defs>

          <!-- Grid circles -->
          <g class="grid-circles">
            <ng-container *ngFor="let circle of getGridCircles(); trackBy: trackByCircleRadius">
              <circle [attr.cx]="windRoseConfig.center" [attr.cy]="windRoseConfig.center" [attr.r]="circle.radius"
                fill="none" stroke="rgba(102, 126, 234, 0.3)" stroke-width="1.5" stroke-dasharray="5 5" />
              <text [attr.x]="windRoseConfig.center + 5" [attr.y]="windRoseConfig.center - circle.radius" font-size="12"
                fill="#667eea" font-weight="600">
                {{circle.percentage}}%
              </text>
            </ng-container>
          </g>

          <!-- Wind segments -->
          <g class="wind-segments">
            <path *ngFor="let segment of windRoseSegments; trackBy: trackBySegmentId" [attr.d]="segment.path"
              [attr.fill]="segment.color" [attr.stroke]="hoveredSegment === segment.segmentId ? '#ffffff' : 'white'"
              [attr.stroke-width]="hoveredSegment === segment.segmentId ? 3 : 2"
              [class.hovered]="hoveredSegment === segment.segmentId" (mouseenter)="onSegmentHover(segment.segmentId)"
              (mouseleave)="onSegmentHover(null)" class="wind-segment">
              <title>{{segment.direction}}: {{segment.speedRange}} - {{segment.frequency | number:'1.1-1'}}%</title>
            </path>
          </g>

          <!-- Center circle -->
          <circle [attr.cx]="windRoseConfig.center" [attr.cy]="windRoseConfig.center"
            [attr.r]="windRoseConfig.innerRadius" fill="url(#centerGradient)" stroke="#667eea" stroke-width="3"
            filter="url(#glow)" />

          <!-- Direction labels -->
          <g class="direction-labels">
            <text *ngFor="let direction of directions; let i = index; trackBy: trackByDirection"
              [attr.x]="getDirectionLabelPosition(direction).x" [attr.y]="getDirectionLabelPosition(direction).y"
              text-anchor="middle" dominant-baseline="middle" fill="#2c3e50" font-size="16" font-weight="700">
              {{direction}}
            </text>
          </g>

          <!-- North indicator arrow -->
          <line [attr.x1]="windRoseConfig.center"
            [attr.y1]="windRoseConfig.center - windRoseConfig.maxRadius - windRoseConfig.innerRadius - 15"
            [attr.x2]="windRoseConfig.center"
            [attr.y2]="windRoseConfig.center - windRoseConfig.maxRadius - windRoseConfig.innerRadius - 25"
            stroke="#e74c3c" stroke-width="4" filter="url(#glow)" />
        </svg>
      </div>

      <!-- No data message -->
      <div class="no-data-message" *ngIf="windRoseSegments.length === 0">
        <i class="fas fa-wind"></i>
        <p>No hay datos de viento disponibles</p>
        <small>Esperando lecturas de los sensores de viento</small>
      </div>
        </div>
      </div>
    </div>

    <!-- THERMOSTAT TEMPERATURE CARD -->
    <div class="card mb-4">
      <div class="card-header bg-warning text-dark">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-thermometer-half"></i> Monitoreo de Temperatura
          </h5>
          <button class="btn btn-sm btn-light" (click)="toggleThermostat()">
            <i class="bi" [class.bi-chevron-down]="isThermostatCollapsed"
               [class.bi-chevron-up]="!isThermostatCollapsed"></i>
            {{ isThermostatCollapsed ? 'Expandir' : 'Contraer' }}
          </button>
        </div>
      </div>
      <div class="card-body" *ngIf="!isThermostatCollapsed">
        <div class="chart-card thermostat-card">
          <div class="chart-info mb-3">
            <small>Lecturas en tiempo real con rangos √≥ptimos y normales para Costa Rica</small>
          </div>

      <div class="chart-content thermostat-container" *ngIf="thermostatData.length > 0">
        <!-- Main Thermostats Grid -->
        <div class="thermostats-grid">
          <div *ngFor="let reading of thermostatData; trackBy: trackByThermostatId" class="thermostat-gauge"
            [class]="getTempStatusClass(reading)">

            <!-- SVG Gauge -->
            <svg [attr.width]="thermostatConfig.size" [attr.height]="thermostatConfig.size"
              [attr.viewBox]="'0 0 ' + thermostatConfig.size + ' ' + thermostatConfig.size" class="thermostat-svg">

              <!-- Gradient Definitions -->
              <defs>
                <linearGradient id="tempGradient-{{reading.deviceId}}" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:#4facfe;stop-opacity:1" />
                  <stop offset="50%" style="stop-color:#43e97b;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#fa709a;stop-opacity:1" />
                </linearGradient>

                <radialGradient id="centerGlow-{{reading.deviceId}}" cx="50%" cy="50%" r="50%">
                  <stop offset="0%" [style.stop-color]="reading.color" style="stop-opacity:0.3" />
                  <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0" />
                </radialGradient>

                <filter id="glow-{{reading.deviceId}}">
                  <feGaussianBlur stdDeviation="4" result="coloredBlur" />
                  <feMerge>
                    <feMergeNode in="coloredBlur" />
                    <feMergeNode in="SourceGraphic" />
                  </feMerge>
                </filter>
              </defs>

              <!-- Background Circle -->
              <circle [attr.cx]="thermostatConfig.center" [attr.cy]="thermostatConfig.center"
                [attr.r]="thermostatConfig.outerRadius + 10" fill="none" stroke="#e9ecef" stroke-width="2" />

              <!-- Temperature Scale Arc (Background) -->
              <path [attr.d]="getThermostatArcPath(reading)" [attr.fill]="'url(#tempGradient-' + reading.deviceId + ')'"
                opacity="0.2" />

              <!-- Current Temperature Arc -->
              <path [attr.d]="getThermostatArcPath(reading)" [attr.fill]="reading.color"
                [attr.filter]="'url(#glow-' + reading.deviceId + ')'" class="temp-arc" />

              <!-- Normal Range Indicator -->
              <path [attr.d]="getThermostatRangeIndicator(reading.normalRange.min, reading.normalRange.max, '#27ae60')"
                stroke="#27ae60" stroke-width="6" fill="none" stroke-linecap="round" opacity="0.6"
                class="normal-range-indicator" />

              <!-- Optimal Range Indicator -->
              <path [attr.d]="getThermostatRangeIndicator(reading.tMinOpt, reading.tMaxOpt, '#667eea')" stroke="#667eea"
                stroke-width="6" fill="none" stroke-linecap="round" opacity="0.6" class="optimal-range-indicator" />

              <!-- Tick Marks -->
              <g class="tick-marks">
                <g *ngFor="let tick of getThermostatTickMarks(); trackBy: trackByTickIndex">
                  <line [attr.x1]="tick.x1" [attr.y1]="tick.y1" [attr.x2]="tick.x2" [attr.y2]="tick.y2" stroke="#95a5a6"
                    stroke-width="2" />
                  <text [attr.x]="tick.x1 - 25" [attr.y]="tick.y1 + 5" fill="#7f8c8d" font-size="12"
                    font-weight="600">{{tick.label}}</text>
                </g>
              </g>

              <!-- Center Display Circle -->
              <circle [attr.cx]="thermostatConfig.center" [attr.cy]="thermostatConfig.center"
                [attr.r]="thermostatConfig.innerRadius - 20" fill="#ffffff" stroke="#e9ecef" stroke-width="3"
                [attr.filter]="'url(#glow-' + reading.deviceId + ')'" />

              <!-- Glow Effect Behind Text -->
              <circle [attr.cx]="thermostatConfig.center" [attr.cy]="thermostatConfig.center"
                [attr.r]="thermostatConfig.innerRadius" [attr.fill]="'url(#centerGlow-' + reading.deviceId + ')'" />

              <!-- Current Temperature Text -->
              <text [attr.x]="thermostatConfig.center" [attr.y]="thermostatConfig.center - 20" text-anchor="middle"
                font-size="48" font-weight="700" [attr.fill]="reading.color"
                class="current-temp">{{reading.currentTemp}}¬∞</text>

              <!-- Sensor Type Label -->
              <text [attr.x]="thermostatConfig.center" [attr.y]="thermostatConfig.center + 20" text-anchor="middle"
                font-size="14" fill="#7f8c8d" font-weight="500">{{reading.sensorType}}</text>

              <!-- Device ID Label -->
              <text [attr.x]="thermostatConfig.center" [attr.y]="thermostatConfig.center + 40" text-anchor="middle"
                font-size="11" fill="#95a5a6">{{reading.deviceId}}</text>

              <!-- Needle/Pointer -->
              <g
                [attr.transform]="'rotate(' + getThermostatNeedlePosition(reading.currentTemp).angle + ' ' + thermostatConfig.center + ' ' + thermostatConfig.center + ')'">
                <line [attr.x1]="thermostatConfig.center" [attr.y1]="thermostatConfig.center"
                  [attr.x2]="getThermostatNeedlePosition(reading.currentTemp).x"
                  [attr.y2]="getThermostatNeedlePosition(reading.currentTemp).y" [attr.stroke]="reading.color"
                  stroke-width="4" stroke-linecap="round" class="temp-needle" />
                <circle [attr.cx]="thermostatConfig.center" [attr.cy]="thermostatConfig.center" r="10"
                  [attr.fill]="reading.color" class="needle-center" />
              </g>
            </svg>

            <!-- Statistics Panel -->
            <div class="thermostat-stats">
              <div class="stat-row">
                <div class="stat-item">
                  <i class="fas fa-arrow-up"></i>
                  <span class="stat-label">M√°xima</span>
                  <span class="stat-value">{{reading.max}}¬∞C</span>
                </div>
                <div class="stat-item">
                  <i class="fas fa-arrow-down"></i>
                  <span class="stat-label">M√≠nima</span>
                  <span class="stat-value">{{reading.min}}¬∞C</span>
                </div>
              </div>

              <div class="stat-row">
                <div class="stat-item">
                  <i class="fas fa-chart-line"></i>
                  <span class="stat-label">Promedio</span>
                  <span class="stat-value">{{reading.mean}}¬∞C</span>
                </div>
                <div class="stat-item">
                  <i class="fas fa-seedling"></i>
                  <span class="stat-label">T Min √ìpt</span>
                  <span class="stat-value">{{reading.tMinOpt}}¬∞C</span>
                </div>
              </div>

              <div class="stat-row">
                <div class="stat-item full-width">
                  <i class="fas fa-leaf"></i>
                  <span class="stat-label">T Max √ìpt</span>
                  <span class="stat-value">{{reading.tMaxOpt}}¬∞C</span>
                </div>
              </div>

              <!-- Status Indicator -->
              <div class="status-badge" [class]="getTempStatusClass(reading)">
                <i class="fas" [class.fa-check-circle]="reading.isWithinNormal"
                  [class.fa-exclamation-triangle]="!reading.isWithinNormal"></i>
                <span>{{getTempStatusText(reading)}}</span>
              </div>

              <!-- Normal Range Info -->
              <div class="range-info">
                <div class="range-item">
                  <span class="range-label">
                    <i class="fas fa-map-marker-alt"></i> Rango Normal CR ({{getCurrentMonthName()}})
                  </span>
                  <span class="range-value">{{reading.normalRange.min}}¬∞C - {{reading.normalRange.max}}¬∞C</span>
                </div>
                <div class="range-item optimal">
                  <span class="range-label">
                    <i class="fas fa-bullseye"></i> Rango √ìptimo Cultivo
                  </span>
                  <span class="range-value">{{reading.tMinOpt}}¬∞C - {{reading.tMaxOpt}}¬∞C</span>
                </div>
              </div>

              <!-- Last Update -->
              <div class="last-update">
                <i class="fas fa-clock"></i>
                <small>√öltima actualizaci√≥n: {{reading.lastUpdate | date:'short'}}</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- No data message -->
      <div class="no-data-message" *ngIf="thermostatData.length === 0">
        <i class="fas fa-thermometer-half"></i>
        <p>No hay datos de temperatura disponibles</p>
        <small>Esperando lecturas de los sensores de temperatura</small>
      </div>
        </div>
      </div>
    </div>

    <!-- TSR DLIg CHART CARD -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-sun"></i> Radiaci√≥n Solar Total (TSR) - DLIg
          </h5>
          <button class="btn btn-sm btn-light" (click)="toggleTSRChart()">
            <i class="bi" [class.bi-chevron-down]="isTSRChartCollapsed"
               [class.bi-chevron-up]="!isTSRChartCollapsed"></i>
            {{ isTSRChartCollapsed ? 'Expandir' : 'Contraer' }}
          </button>
        </div>
      </div>
      <div class="card-body" *ngIf="!isTSRChartCollapsed">
        <div class="chart-card tsr-dlig-card">
          <div class="chart-info mb-3">
            <small>Daily Light Integral - Global | Per√≠odo: {{ tsrChartData.dataPoints.length }} horas</small>
          </div>

      <!-- DLIg Summary Cards -->
      <div class="dlig-summary-cards">
        <div class="dlig-card dlig-max">
          <div class="dlig-card-header">
            <span class="dlig-icon">üî•</span>
            <span class="dlig-label">DLIg M√°ximo</span>
          </div>
          <div class="dlig-value">
            {{ tsrChartData.dligMax.toFixed(2) }}
            <span class="dlig-unit">MJ/m¬≤</span>
          </div>
        </div>

        <div class="dlig-card dlig-mean">
          <div class="dlig-card-header">
            <span class="dlig-icon">‚òÄÔ∏è</span>
            <span class="dlig-label">DLIg Promedio</span>
          </div>
          <div class="dlig-value">
            {{ tsrChartData.dligMean.toFixed(2) }}
            <span class="dlig-unit">MJ/m¬≤</span>
          </div>
        </div>

        <div class="dlig-card dlig-min">
          <div class="dlig-card-header">
            <span class="dlig-icon">üå§Ô∏è</span>
            <span class="dlig-label">DLIg M√≠nimo</span>
          </div>
          <div class="dlig-value">
            {{ tsrChartData.dligMin.toFixed(2) }}
            <span class="dlig-unit">MJ/m¬≤</span>
          </div>
        </div>
      </div>

      <!-- Chart Container -->
      <div class="tsr-chart-container" *ngIf="tsrChartData.dataPoints.length > 0">
        <svg #tsrChartSvg [attr.width]="tsrChartConfig.width" [attr.height]="tsrChartConfig.height"
          [attr.viewBox]="'0 0 ' + tsrChartConfig.width + ' ' + tsrChartConfig.height" class="tsr-chart-svg"
          (mousemove)="onTSRChartHover($event, $any(tsrChartSvg))" (mouseleave)="onTSRChartLeave()">

          <!-- Definitions -->
          <defs>
            <!-- Gradients for areas -->
            <linearGradient id="tsrGradientMax" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" [attr.stop-color]="tsrChartConfig.flameColors.max.start" stop-opacity="0.8" />
              <stop offset="100%" [attr.stop-color]="tsrChartConfig.flameColors.max.start" stop-opacity="0.1" />
            </linearGradient>

            <linearGradient id="tsrGradientMean" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" [attr.stop-color]="tsrChartConfig.flameColors.mean.start" stop-opacity="0.7" />
              <stop offset="100%" [attr.stop-color]="tsrChartConfig.flameColors.mean.start" stop-opacity="0.1" />
            </linearGradient>

            <linearGradient id="tsrGradientMin" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" [attr.stop-color]="tsrChartConfig.flameColors.min.start" stop-opacity="0.6" />
              <stop offset="100%" [attr.stop-color]="tsrChartConfig.flameColors.min.start" stop-opacity="0.1" />
            </linearGradient>

            <!-- Glow filter -->
            <filter id="tsrGlow">
              <feGaussianBlur stdDeviation="4" result="coloredBlur" />
              <feMerge>
                <feMergeNode in="coloredBlur" />
                <feMergeNode in="SourceGraphic" />
              </feMerge>
            </filter>
          </defs>

          <!-- Grid lines -->
          <g class="tsr-grid-lines" opacity="0.2">
            <line *ngFor="let gridLine of getTSRGridLines(); trackBy: trackByTSRIndex"
              [attr.x1]="tsrChartConfig.padding.left" [attr.y1]="gridLine.y"
              [attr.x2]="tsrChartConfig.padding.left + getTSRChartDimensions().chartWidth" [attr.y2]="gridLine.y"
              stroke="rgba(255, 255, 255, 0.3)" stroke-width="1" stroke-dasharray="5,5" />
          </g>

          <!-- Y-axis labels -->
          <g class="tsr-y-axis-labels">
            <text *ngFor="let gridLine of getTSRGridLines(); trackBy: trackByTSRIndex"
              [attr.x]="tsrChartConfig.padding.left - 15" [attr.y]="gridLine.y + 5" text-anchor="end"
              fill="rgba(255, 255, 255, 0.7)" font-size="12" font-weight="500">
              {{ gridLine.label }} W/m¬≤
            </text>
          </g>

          <!-- Area charts - stacked from bottom to top -->

          <!-- Min area -->
          <path [attr.d]="generateTSRAreaPath('tsrMin')" fill="url(#tsrGradientMin)" opacity="0.9"
            class="tsr-area tsr-area-min" />
          <path [attr.d]="generateTSRLinePath('tsrMin')" fill="none" [attr.stroke]="tsrChartConfig.flameColors.min.end"
            stroke-width="2" filter="url(#tsrGlow)" class="tsr-line tsr-line-min" />

          <!-- Mean area -->
          <path [attr.d]="generateTSRAreaPath('tsrMean')" fill="url(#tsrGradientMean)" opacity="0.8"
            class="tsr-area tsr-area-mean" />
          <path [attr.d]="generateTSRLinePath('tsrMean')" fill="none"
            [attr.stroke]="tsrChartConfig.flameColors.mean.end" stroke-width="2" filter="url(#tsrGlow)"
            class="tsr-line tsr-line-mean" />

          <!-- Max area -->
          <path [attr.d]="generateTSRAreaPath('tsrMax')" fill="url(#tsrGradientMax)" opacity="0.7"
            class="tsr-area tsr-area-max" />
          <path [attr.d]="generateTSRLinePath('tsrMax')" fill="none" [attr.stroke]="tsrChartConfig.flameColors.max.end"
            stroke-width="3" filter="url(#tsrGlow)" class="tsr-line tsr-line-max" />

          <!-- X-axis labels -->
          <g class="tsr-x-axis-labels">
            <text *ngFor="let label of getTSRXAxisLabels(); trackBy: trackByTSRIndex" [attr.x]="label.x"
              [attr.y]="tsrChartConfig.height - tsrChartConfig.padding.bottom + 25" text-anchor="middle"
              fill="rgba(255, 255, 255, 0.7)" font-size="11" font-weight="500">
              {{ label.label }}
            </text>
          </g>

          <!-- Hover indicator and tooltip -->
          <g *ngIf="hoveredTSRPoint && hoveredTSRIndex >= 0" class="tsr-hover-group">
            <!-- Vertical indicator line -->
            <line [attr.x1]="tsrChartConfig.padding.left + getTSRXScale(hoveredTSRIndex)"
              [attr.y1]="tsrChartConfig.padding.top"
              [attr.x2]="tsrChartConfig.padding.left + getTSRXScale(hoveredTSRIndex)"
              [attr.y2]="tsrChartConfig.padding.top + getTSRChartDimensions().chartHeight"
              stroke="rgba(255, 255, 255, 0.5)" stroke-width="2" stroke-dasharray="5,5" filter="url(#tsrGlow)" />

            <!-- Tooltip background -->
            <rect [attr.x]="getTSRTooltipX()" [attr.y]="getTSRTooltipY()" width="180" height="120"
              fill="rgba(0, 0, 0, 0.9)" rx="8" stroke="rgba(255, 140, 0, 0.5)" stroke-width="2" filter="url(#tsrGlow)"
              class="tsr-tooltip-bg" />

            <!-- Tooltip content -->
            <text [attr.x]="getTSRTooltipX() + 10" [attr.y]="getTSRTooltipY() + 25" fill="rgba(255, 255, 255, 0.9)"
              font-size="12" font-weight="600">
              {{ formatTSRTime(hoveredTSRPoint.timestamp) }}
            </text>

            <text [attr.x]="getTSRTooltipX() + 10" [attr.y]="getTSRTooltipY() + 45" fill="rgba(255, 255, 255, 0.6)"
              font-size="10">
              {{ formatTSRDate(hoveredTSRPoint.timestamp) }}
            </text>

            <text [attr.x]="getTSRTooltipX() + 10" [attr.y]="getTSRTooltipY() + 65"
              [attr.fill]="tsrChartConfig.flameColors.max.start" font-size="11" font-weight="500">
              üî• Max: {{ hoveredTSRPoint.tsrMax.toFixed(1) }} W/m¬≤
            </text>

            <text [attr.x]="getTSRTooltipX() + 10" [attr.y]="getTSRTooltipY() + 85"
              [attr.fill]="tsrChartConfig.flameColors.mean.start" font-size="11" font-weight="500">
              ‚òÄÔ∏è Mean: {{ hoveredTSRPoint.tsrMean.toFixed(1) }} W/m¬≤
            </text>

            <text [attr.x]="getTSRTooltipX() + 10" [attr.y]="getTSRTooltipY() + 105"
              [attr.fill]="tsrChartConfig.flameColors.min.start" font-size="11" font-weight="500">
              üå§Ô∏è Min: {{ hoveredTSRPoint.tsrMin.toFixed(1) }} W/m¬≤
            </text>
          </g>
        </svg>

        <!-- Legend -->
        <div class="tsr-legend">
          <div class="tsr-legend-item tsr-legend-max">
            <span class="tsr-legend-icon">üî•</span>
            <div class="tsr-legend-color"></div>
            <span class="tsr-legend-label">TSR M√°ximo</span>
          </div>
          <div class="tsr-legend-item tsr-legend-mean">
            <span class="tsr-legend-icon">‚òÄÔ∏è</span>
            <div class="tsr-legend-color"></div>
            <span class="tsr-legend-label">TSR Promedio</span>
          </div>
          <div class="tsr-legend-item tsr-legend-min">
            <span class="tsr-legend-icon">üå§Ô∏è</span>
            <div class="tsr-legend-color"></div>
            <span class="tsr-legend-label">TSR M√≠nimo</span>
          </div>
        </div>
      </div>

      <!-- No data message -->
      <div class="no-data-message" *ngIf="tsrChartData.dataPoints.length === 0">
        <i class="fas fa-sun"></i>
        <p>No hay datos de radiaci√≥n solar disponibles</p>
        <small>Esperando lecturas del sensor TSR</small>
      </div>

      <!-- Footer -->
      <div class="chart-footer tsr-footer">
        <small>
          <i class="fas fa-calculator"></i>
          F√≥rmula DLIg: (Œ£ radiaci√≥n horaria W/m¬≤) / 1000 √ó 3.6 = MJ/m¬≤
          <span class="tsr-footer-badge">Rango t√≠pico: 10-50 MJ/m¬≤/d√≠a</span>
        </small>
      </div>
        </div>
      </div>
    </div>

    <!-- PAR DLIp CHART CARD -->
    <div class="card mb-4">
      <div class="card-header bg-dark text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-lightbulb"></i> PAR & DLIp - Radiaci√≥n Fotosint√©tica Activa
          </h5>
          <button class="btn btn-sm btn-light" (click)="togglePARChart()">
            <i class="bi" [class.bi-chevron-down]="isPARChartCollapsed"
               [class.bi-chevron-up]="!isPARChartCollapsed"></i>
            {{ isPARChartCollapsed ? 'Expandir' : 'Contraer' }}
          </button>
        </div>
      </div>
      <div class="card-body" *ngIf="!isPARChartCollapsed">
        <div class="chart-card par-dlip-card">
          <div class="chart-info mb-3">
            <small>Daily Light Integral - PAR | Per√≠odo: {{ parChartData.dataPoints.length }} horas</small>
          </div>

      <!-- DLIp Summary Cards -->
      <div class="dlip-summary-cards">
        <div class="dlip-card dlip-total">
          <div class="dlip-card-header">
            <span class="dlip-icon">üí°</span>
            <span class="dlip-label">DLIp Total</span>
          </div>
          <div class="dlip-value">
            {{ parChartData.dlipTotal.toFixed(2) }}
            <span class="dlip-unit">mol/m¬≤</span>
          </div>
        </div>

        <div class="dlip-card dlip-max">
          <div class="dlip-card-header">
            <span class="dlip-icon">‚ö°</span>
            <span class="dlip-label">PAR M√°ximo</span>
          </div>
          <div class="dlip-value">
            {{ parChartData.parMax.toFixed(0) }}
            <span class="dlip-unit">Œºmol/m¬≤/s</span>
          </div>
        </div>

        <div class="dlip-card dlip-mean">
          <div class="dlip-card-header">
            <span class="dlip-icon">‚òÄÔ∏è</span>
            <span class="dlip-label">PAR Promedio</span>
          </div>
          <div class="dlip-value">
            {{ parChartData.parMean.toFixed(0) }}
            <span class="dlip-unit">Œºmol/m¬≤/s</span>
          </div>
        </div>
      </div>

      <!-- PAR Chart Container -->
      <div class="par-chart-container" *ngIf="parChartData.dataPoints.length > 0">
        <svg [attr.width]="parChartConfig.width" [attr.height]="parChartConfig.height" class="par-chart-svg">
          <!-- Gradients and Filters -->
          <defs>
            <!-- Visible Light Spectrum Gradient -->
            <linearGradient id="visibleSpectrumGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#8b00ff" />
              <stop offset="16.67%" stop-color="#0000ff" />
              <stop offset="33.33%" stop-color="#00ff00" />
              <stop offset="50%" stop-color="#ffff00" />
              <stop offset="66.67%" stop-color="#ff7f00" />
              <stop offset="100%" stop-color="#ff0000" />
            </linearGradient>

            <!-- PAR Area Gradient -->
            <linearGradient id="parGradient" x1="0%" y1="100%" x2="0%" y2="0%">
              <stop offset="0%" stop-color="rgba(139, 0, 255, 0.1)" />
              <stop offset="50%" stop-color="rgba(0, 255, 0, 0.3)" />
              <stop offset="100%" stop-color="rgba(255, 255, 0, 0.5)" />
            </linearGradient>

            <!-- DLIp Gradient -->
            <linearGradient id="dlipGradient" x1="0%" y1="100%" x2="0%" y2="0%">
              <stop offset="0%" stop-color="rgba(0, 191, 255, 0.1)" />
              <stop offset="100%" stop-color="rgba(0, 191, 255, 0.4)" />
            </linearGradient>

            <!-- Neon Glow Filter -->
            <filter id="neonGlow">
              <feGaussianBlur stdDeviation="3" result="coloredBlur" />
              <feMerge>
                <feMergeNode in="coloredBlur" />
                <feMergeNode in="SourceGraphic" />
              </feMerge>
            </filter>
          </defs>

          <!-- Background -->
          <rect [attr.x]="parChartConfig.padding.left" [attr.y]="parChartConfig.padding.top"
            [attr.width]="getPARChartDimensions().chartWidth" [attr.height]="getPARChartDimensions().chartHeight"
            fill="rgba(0, 0, 0, 0.2)" rx="8" />

          <!-- PAR Grid Lines (left axis) -->
          <g class="par-grid-lines">
            <g *ngFor="let line of getPARGridLines(); trackBy: trackByPARIndex">
              <line [attr.x1]="parChartConfig.padding.left" [attr.y1]="line.y"
                [attr.x2]="parChartConfig.padding.left + getPARChartDimensions().chartWidth" [attr.y2]="line.y"
                stroke="rgba(139, 0, 255, 0.2)" stroke-width="1" stroke-dasharray="5,5" />
              <text [attr.x]="parChartConfig.padding.left - 10" [attr.y]="line.y" text-anchor="end"
                dominant-baseline="middle" fill="rgba(255, 255, 255, 0.8)" font-size="11" font-weight="500">
                {{ line.label }}
              </text>
            </g>
          </g>

          <!-- DLIp Grid Labels (right axis) -->
          <g class="dlip-grid-lines">
            <text *ngFor="let line of getDLIpGridLines(); trackBy: trackByPARIndex"
              [attr.x]="parChartConfig.padding.left + getPARChartDimensions().chartWidth + 10" [attr.y]="line.y"
              text-anchor="start" dominant-baseline="middle" fill="rgba(0, 191, 255, 0.9)" font-size="11"
              font-weight="500">
              {{ line.label }}
            </text>
          </g>

          <!-- PAR Area -->
          <path [attr.d]="generatePARAreaPath()" fill="url(#parGradient)" opacity="0.6" class="par-area" />

          <!-- PAR Line -->
          <path [attr.d]="generatePARLinePath()" fill="none" stroke="url(#visibleSpectrumGradient)" stroke-width="3"
            filter="url(#neonGlow)" class="par-line" />

          <!-- DLIp Line -->
          <path [attr.d]="generateDLIpLinePath()" fill="none" stroke="#00bfff" stroke-width="3" filter="url(#neonGlow)"
            stroke-dasharray="8,4" class="dlip-line" />

          <!-- X-axis labels -->
          <g class="par-x-axis-labels">
            <text *ngFor="let label of getPARXAxisLabels(); trackBy: trackByPARIndex" [attr.x]="label.x"
              [attr.y]="parChartConfig.height - parChartConfig.padding.bottom + 25" text-anchor="middle"
              fill="rgba(255, 255, 255, 0.7)" font-size="11" font-weight="500">
              {{ label.label }}
            </text>
          </g>
 
          <!-- Interactive overlay -->
          <rect [attr.x]="parChartConfig.padding.left" [attr.y]="parChartConfig.padding.top"
            [attr.width]="getPARChartDimensions().chartWidth" [attr.height]="getPARChartDimensions().chartHeight"
            fill="transparent" (mousemove)="onPARChartHover($event)" (mouseleave)="onPARChartLeave()"
            style="cursor: crosshair;" />

          <!-- Hover indicator and tooltip -->
          <g *ngIf="hoveredPARPoint && hoveredPARIndex >= 0" class="par-hover-group">
            <!-- Vertical indicator line -->
            <line [attr.x1]="parChartConfig.padding.left + getPARXScale(hoveredPARIndex)"
              [attr.y1]="parChartConfig.padding.top"
              [attr.x2]="parChartConfig.padding.left + getPARXScale(hoveredPARIndex)"
              [attr.y2]="parChartConfig.padding.top + getPARChartDimensions().chartHeight"
              stroke="rgba(255, 255, 255, 0.6)" stroke-width="2" stroke-dasharray="5,5" filter="url(#neonGlow)" />

            <!-- PAR point indicator -->
            <circle [attr.cx]="parChartConfig.padding.left + getPARXScale(hoveredPARIndex)"
              [attr.cy]="parChartConfig.padding.top + getPARYScale(hoveredPARPoint.parInstantaneous)" r="6"
              fill="#ffff00" stroke="#fff" stroke-width="2" filter="url(#neonGlow)" />

            <!-- DLIp point indicator -->
            <circle [attr.cx]="parChartConfig.padding.left + getPARXScale(hoveredPARIndex)"
              [attr.cy]="parChartConfig.padding.top + getDLIpYScale(hoveredPARPoint.dlipAccumulated)" r="6"
              fill="#00bfff" stroke="#fff" stroke-width="2" filter="url(#neonGlow)" />

            <!-- Tooltip background -->
            <rect [attr.x]="getPARTooltipX()" [attr.y]="getPARTooltipY()" width="200" height="140"
              fill="rgba(0, 0, 0, 0.95)" rx="8" stroke="url(#visibleSpectrumGradient)" stroke-width="2"
              filter="url(#neonGlow)" class="par-tooltip-bg" />

            <!-- Tooltip content -->
            <text [attr.x]="getPARTooltipX() + 10" [attr.y]="getPARTooltipY() + 25" fill="rgba(255, 255, 255, 0.9)"
              font-size="13" font-weight="600">
              {{ formatPARTime(hoveredPARPoint.timestamp) }}
            </text>

            <text [attr.x]="getPARTooltipX() + 10" [attr.y]="getPARTooltipY() + 45" fill="rgba(255, 255, 255, 0.6)"
              font-size="10">
              {{ formatPARDate(hoveredPARPoint.timestamp) }}
            </text>

            <text [attr.x]="getPARTooltipX() + 10" [attr.y]="getPARTooltipY() + 70" fill="#ffff00" font-size="12"
              font-weight="500">
              üí° PAR: {{ hoveredPARPoint.parInstantaneous.toFixed(1) }} Œºmol/m¬≤/s
            </text>

            <text [attr.x]="getPARTooltipX() + 10" [attr.y]="getPARTooltipY() + 95" fill="#00bfff" font-size="12"
              font-weight="500">
              üìä DLIp: {{ hoveredPARPoint.dlipAccumulated.toFixed(2) }} mol/m¬≤
            </text>

            <text [attr.x]="getPARTooltipX() + 10" [attr.y]="getPARTooltipY() + 120" fill="rgba(255, 255, 255, 0.5)"
              font-size="10">
              Œî: {{ (hoveredPARPoint.parInstantaneous * 3600 / 1000000).toFixed(3) }} mol/m¬≤/h
            </text>
          </g>
        </svg>

        <!-- Legend -->
        <div class="par-legend">
          <div class="par-legend-item par-legend-par">
            <span class="par-legend-icon">üí°</span>
            <div class="par-legend-color"></div>
            <span class="par-legend-label">PAR Instant√°neo</span>
          </div>
          <div class="par-legend-item par-legend-dlip">
            <span class="par-legend-icon">üìä</span>
            <div class="par-legend-color"></div>
            <span class="par-legend-label">DLIp Acumulado</span>
          </div>
        </div>
      </div>

      <!-- No data message -->
      <div class="no-data-message" *ngIf="parChartData.dataPoints.length === 0">
        <i class="fas fa-lightbulb"></i>
        <p>No hay datos de PAR disponibles</p>
        <small>Esperando lecturas del sensor PAR</small>
      </div>

      <!-- Footer -->
      <div class="chart-footer par-footer">
        <small>
          <i class="fas fa-calculator"></i>
          F√≥rmula DLIp: Œ£(PAR Œºmol/m¬≤/s √ó 3600s) / 1,000,000 = mol/m¬≤/per√≠odo
          <span class="par-footer-badge">Rango √≥ptimo: 20-60 mol/m¬≤/d√≠a</span>
        </small>
      </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!isLoading && !error" class="dashboard-content">

    <!-- Flow Meters Section -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-droplet"></i> Medidores de Flujo
          </h5>
          <button class="btn btn-sm btn-light" (click)="toggleFlowDevices()">
            <i class="bi" [class.bi-chevron-down]="isFlowDevicesCollapsed"
               [class.bi-chevron-up]="!isFlowDevicesCollapsed"></i>
            {{ isFlowDevicesCollapsed ? 'Expandir' : 'Contraer' }}
          </button>
        </div>
      </div>
      <div class="card-body" *ngIf="!isFlowDevicesCollapsed">
        <div class="dashboard-section">
          <div class="devices-grid">
        <div *ngFor="let device of flowDevices" class="device-card" [class]="getStatusClass(getDeviceStatus(device))">
          <div class="device-header">
            <h3>{{ device.deviceId }}</h3>
            <span class="status-indicator"></span>
            <div class="device-status-badge">
              <span *ngIf="!device.isActive" class="inactive-badge">INACTIVO</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'online'" class="online-badge">EN L√çNEA</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'warning'"
                class="warning-badge">ADVERTENCIA</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'offline'"
                class="offline-badge">DESCONECTADO</span>
            </div>
          </div>
          <div class="device-content">
            <div *ngIf="!device.isActive" class="inactive-message">
              <p>Este dispositivo est√° registrado pero no est√° enviando datos.</p>
              <p><small>ID de Registro: {{ device.registeredDevice?.id }}</small></p>
            </div>
            <div *ngIf="device.isActive">
              <div class="reading" *ngIf="hasNumericReading(device, 'Water_flow_value')">
                <span class="label">Valor de Flujo:</span>
                <span class="value">{{ getReadingValue(device, 'Water_flow_value') }}</span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'MOD')">
                <span class="label">Tasa de Flujo:</span>
                <span class="value">{{ getReadingValue(device, 'MOD') }}</span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'Total_pulse')">
                <span class="label">Pulsos Totales:</span>
                <span class="value">{{ getReadingValue(device, 'Total_pulse') }}</span>
              </div>
              <div class="reading">
                <span class="label">Alarma:</span>
                <span class="value alarm-status"
                  [class]="getRawReadingValue(device, 'Alarm') === 'FALSE' ? 'alarm-ok' : 'alarm-active'">
                  {{ getRawReadingValue(device, 'Alarm') }}
                </span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'Calculate_flag')">
                <span class="label">Bandera de C√°lculo:</span>
                <span class="value">{{ getReadingValue(device, 'Calculate_flag') }}</span>
              </div>
              <div class="reading">
                <span class="label">√öltima Actualizaci√≥n:</span>
                <span class="value">{{ formatDate(device.lastUpdate) }}</span>
              </div>
            </div>
          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Soil Sensors Section -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-moisture"></i> Sensores de Suelo
          </h5>
          <button class="btn btn-sm btn-light" (click)="toggleSoilDevices()">
            <i class="bi" [class.bi-chevron-down]="isSoilDevicesCollapsed"
               [class.bi-chevron-up]="!isSoilDevicesCollapsed"></i>
            {{ isSoilDevicesCollapsed ? 'Expandir' : 'Contraer' }}
          </button>
        </div>
      </div>
      <div class="card-body" *ngIf="!isSoilDevicesCollapsed">
        <div class="dashboard-section">
          <div class="devices-grid">
        <div *ngFor="let device of soilDevices" class="device-card" [class]="getStatusClass(getDeviceStatus(device))">
          <div class="device-header">
            <h3>{{ device.deviceId }}</h3>
            <span class="status-indicator"></span>
            <div class="device-status-badge">
              <span *ngIf="!device.isActive" class="inactive-badge">INACTIVO</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'online'" class="online-badge">EN L√çNEA</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'warning'"
                class="warning-badge">ADVERTENCIA</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'offline'"
                class="offline-badge">DESCONECTADO</span>
            </div>
          </div>
          <div class="device-content">
            <div *ngIf="!device.isActive" class="inactive-message">
              <p>Este dispositivo est√° registrado pero no est√° enviando datos.</p>
              <p><small>ID de Registro: {{ device.registeredDevice?.id }}</small></p>
            </div>
            <div *ngIf="device.isActive">
              <div class="reading" *ngIf="hasNumericReading(device, 'water_SOIL')">
                <span class="label">Humedad del Suelo:</span>
                <span class="value">{{ getReadingValue(device, 'water_SOIL') }}</span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'conduct_SOIL')">
                <span class="label">Conductividad:</span>
                <span class="value">{{ getReadingValue(device, 'conduct_SOIL') }}</span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'temp_DS18B20')">
                <span class="label">Temperatura:</span>
                <span class="value">{{ getReadingValue(device, 'temp_DS18B20') }}</span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'TEMP_SOIL')">
                <span class="label">Temperatura del Suelo:</span>
                <span class="value">{{ getReadingValue(device, 'TEMP_SOIL') }}</span>
              </div>
              <div class="reading">
                <span class="label">√öltima Actualizaci√≥n:</span>
                <span class="value">{{ formatDate(device.lastUpdate) }}</span>
              </div>
            </div>
          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <!-- pH Sensors Section -->
    <div class="card mb-4">
      <div class="card-header bg-warning text-dark">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-vial"></i> Sensores de pH
          </h5>
          <button class="btn btn-sm btn-light" (click)="togglePhDevices()">
            <i class="bi" [class.bi-chevron-down]="isPhDevicesCollapsed"
               [class.bi-chevron-up]="!isPhDevicesCollapsed"></i>
            {{ isPhDevicesCollapsed ? 'Expandir' : 'Contraer' }}
          </button>
        </div>
      </div>
      <div class="card-body" *ngIf="!isPhDevicesCollapsed">
        <div class="dashboard-section">
          <div class="devices-grid">
        <div *ngFor="let device of phDevices" class="device-card" [class]="getStatusClass(getDeviceStatus(device))">
          <div class="device-header">
            <h3>{{ device.deviceId }}</h3>
            <span class="status-indicator"></span>
            <div class="device-status-badge">
              <span *ngIf="!device.isActive" class="inactive-badge">INACTIVO</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'online'" class="online-badge">EN L√çNEA</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'warning'"
                class="warning-badge">ADVERTENCIA</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'offline'"
                class="offline-badge">DESCONECTADO</span>
            </div>
          </div>
          <div class="device-content">
            <div *ngIf="!device.isActive" class="inactive-message">
              <p>Este dispositivo est√° registrado pero no est√° enviando datos.</p>
              <p><small>ID de Registro: {{ device.registeredDevice?.id }}</small></p>
            </div>
            <div *ngIf="device.isActive">
              <div class="reading" *ngIf="hasNumericReading(device, 'PH1_SOIL')">
                <span class="label">Nivel de pH:</span>
                <span class="value ph-value"
                  [class]="getPhClass(device.readings['PH1_SOIL'] && device.readings['PH1_SOIL'].value != null ? device.readings['PH1_SOIL'].value : null)">
                  {{ getReadingValue(device, 'PH1_SOIL') }}
                </span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'PH_SOIL')">
                <span class="label">Nivel de pH:</span>
                <span class="value ph-value"
                  [class]="getPhClass(device.readings['PH_SOIL'] && device.readings['PH_SOIL'].value != null ? device.readings['PH_SOIL'].value : null)">
                  {{ getReadingValue(device, 'PH_SOIL') }}
                </span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'TEMP_SOIL')">
                <span class="label">Temperatura del Suelo:</span>
                <span class="value">{{ getReadingValue(device, 'TEMP_SOIL') }}</span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'Bat')">
                <span class="label">Bater√≠a:</span>
                <span class="value battery-level"
                  [class]="getBatteryClass(device.readings['Bat'] && device.readings['Bat'].value != undefined ? device.readings['Bat'].value : null)">
                  {{ getReadingValue(device, 'Bat') }}
                </span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'Message_type')">
                <span class="label">Tipo de Mensaje:</span>
                <span class="value">{{ getReadingValue(device, 'Message_type') }}</span>
              </div>
              <div class="reading">
                <span class="label">√öltima Actualizaci√≥n:</span>
                <span class="value">{{ formatDate(device.lastUpdate) }}</span>
              </div>
            </div>
          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pressure Sensors Section -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-speedometer"></i> Sensores de Presi√≥n
          </h5>
          <button class="btn btn-sm btn-light" (click)="togglePressureDevices()">
            <i class="bi" [class.bi-chevron-down]="isPressureDevicesCollapsed"
               [class.bi-chevron-up]="!isPressureDevicesCollapsed"></i>
            {{ isPressureDevicesCollapsed ? 'Expandir' : 'Contraer' }}
          </button>
        </div>
      </div>
      <div class="card-body" *ngIf="!isPressureDevicesCollapsed">
        <div class="dashboard-section">
          <div class="devices-grid">
        <div *ngFor="let device of pressureDevices" class="device-card"
          [class]="getStatusClass(getDeviceStatus(device))">
          <div class="device-header">
            <h3>{{ device.deviceId }}</h3>
            <span class="status-indicator"></span>
            <div class="device-status-badge">
              <span *ngIf="!device.isActive" class="inactive-badge">INACTIVO</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'online'" class="online-badge">EN L√çNEA</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'warning'"
                class="warning-badge">ADVERTENCIA</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'offline'"
                class="offline-badge">DESCONECTADO</span>
            </div>
          </div>
          <div class="device-content">
            <div *ngIf="!device.isActive" class="inactive-message">
              <p>Este dispositivo est√° registrado pero no est√° enviando datos.</p>
              <p><small>ID de Registro: {{ device.registeredDevice?.id }}</small></p>
            </div>
            <div *ngIf="device.isActive">
              <div class="reading" *ngIf="hasNumericReading(device, 'IDC_intput_mA')">
                <span class="label">Entrada de Corriente:</span>
                <span class="value">{{ getReadingValue(device, 'IDC_intput_mA') }}</span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'VDC_intput_V')">
                <span class="label">Entrada de Voltaje:</span>
                <span class="value">{{ getReadingValue(device, 'VDC_intput_V') }}</span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'Water_pressure_MPa')">
                <span class="label">Presi√≥n del Agua:</span>
                <span class="value">{{ getReadingValue(device, 'Water_pressure_MPa') }}</span>
              </div>
              <div class="reading">
                <span class="label">Estado Externo:</span>
                <span class="value status-value"
                  [class]="getRawReadingValue(device, 'Exti_status') === 'False' ? 'status-inactive' : 'status-active'">
                  {{ getRawReadingValue(device, 'Exti_status') }}
                </span>
              </div>
              <div class="reading">
                <span class="label">Nivel de Pin de Entrada:</span>
                <span class="value">{{ getRawReadingValue(device, 'IN2_pin_level') }}</span>
              </div>
              <div class="reading">
                <span class="label">Nivel de Pin Externo:</span>
                <span class="value">{{ getRawReadingValue(device, 'Exti_pin_level') }}</span>
              </div>
              <div class="reading" *ngIf="hasNumericReading(device, 'Probe_mod')">
                <span class="label">Modo de Sonda:</span>
                <span class="value">{{ getReadingValue(device, 'Probe_mod') }}</span>
              </div>
              <div class="reading">
                <span class="label">√öltima Actualizaci√≥n:</span>
                <span class="value">{{ formatDate(device.lastUpdate) }}</span>
              </div>
            </div>
          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Climate Station Section -->
    <div class="card mb-4">
      <div class="card-header bg-secondary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-cloud-sun"></i> Estaci√≥n Clim√°tica
          </h5>
          <button class="btn btn-sm btn-light" (click)="toggleClimateDevices()">
            <i class="bi" [class.bi-chevron-down]="isClimateDevicesCollapsed"
               [class.bi-chevron-up]="!isClimateDevicesCollapsed"></i>
            {{ isClimateDevicesCollapsed ? 'Expandir' : 'Contraer' }}
          </button>
        </div>
      </div>
      <div class="card-body" *ngIf="!isClimateDevicesCollapsed">
        <div class="dashboard-section">
          <div class="devices-grid">
        <div *ngFor="let device of climateDevices" class="device-card climate-card"
          [class]="getStatusClass(getDeviceStatus(device))">
          <div class="device-header">
            <h3>{{ device.deviceId }}</h3>
            <span class="status-indicator"></span>
            <div class="device-status-badge">
              <span *ngIf="!device.isActive" class="inactive-badge">INACTIVO</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'online'" class="online-badge">EN L√çNEA</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'warning'"
                class="warning-badge">ADVERTENCIA</span>
              <span *ngIf="device.isActive && getDeviceStatus(device) === 'offline'"
                class="offline-badge">DESCONECTADO</span>
            </div>
          </div>
          <div class="device-content">
            <div *ngIf="!device.isActive" class="inactive-message">
              <p>Este dispositivo est√° registrado pero no est√° enviando datos.</p>
              <p><small>ID de Registro: {{ device.registeredDevice?.id }}</small></p>
            </div>
            <div *ngIf="device.isActive">
              <div class="reading-grid">
                <div class="reading" *ngIf="hasNumericReading(device, 'TEM')">
                  <span class="label">Temperatura:</span>
                  <span class="value temp-value"
                    [class]="getTempClass(device.readings['TEM'] && device.readings['TEM'].value != undefined ? device.readings['TEM'].value : null)">
                    {{ getReadingValue(device, 'TEM') }}
                  </span>
                </div>
                <div class="reading" *ngIf="hasNumericReading(device, 'HUM')">
                  <span class="label">Humedad:</span>
                  <span class="value humidity-value"
                    [class]="getHumidityClass(device.readings['HUM'] && device.readings['HUM'].value != undefined ? device.readings['HUM'].value : null)">
                    {{ getReadingValue(device, 'HUM') }}
                  </span>
                </div>
                <div class="reading" *ngIf="hasNumericReading(device, 'wind_direction_angle')">
                  <span class="label">Direcci√≥n del Viento:</span>
                  <span class="value">{{ getReadingValue(device, 'wind_direction_angle') }}</span>
                </div>
                <div class="reading" *ngIf="hasNumericReading(device, 'wind_speed')">
                  <span class="label">Velocidad del Viento:</span>
                  <span class="value wind-value"
                    [class]="getWindClass(device.readings['wind_speed'] && device.readings['wind_speed'].value != undefined ? device.readings['wind_speed'].value : null)">
                    {{ getReadingValue(device, 'wind_speed') }}
                  </span>
                </div>
                <div class="reading" *ngIf="hasNumericReading(device, 'pressure')">
                  <span class="label">Presi√≥n Atmosf√©rica:</span>
                  <span class="value">{{ getReadingValue(device, 'pressure') }}</span>
                </div>
                <div class="reading" *ngIf="hasNumericReading(device, 'rain_gauge')">
                  <span class="label">Precipitaci√≥n:</span>
                  <span class="value rain-value"
                    [class]="getRainClass(device.readings['rain_gauge'] && device.readings['rain_gauge'].value != undefined ? device.readings['rain_gauge'].value : null)">
                    {{ getReadingValue(device, 'rain_gauge') }}
                  </span>
                </div>
                <div class="reading" *ngIf="hasNumericReading(device, 'PAR')">
                  <span class="label">PAR (Radiaci√≥n Fotosint√©tica Activa):</span>
                  <span class="value">{{ getReadingValue(device, 'PAR') }}</span>
                </div>
                <div class="reading" *ngIf="hasNumericReading(device, 'illumination')">
                  <span class="label">Iluminaci√≥n:</span>
                  <span class="value">{{ getReadingValue(device, 'illumination') }}</span>
                </div>
              </div>
              <div class="reading">
                <span class="label">√öltima Actualizaci√≥n:</span>
                <span class="value">{{ formatDate(device.lastUpdate) }}</span>
              </div>
            </div>
          </div>
        </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>