<!-- src/app/features/dashboard/dashboard.component.html -->
<div class="dashboard">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="welcome-card">
        <h1 class="display-6 mb-2">Dashboard - AgriSmart</h1>
        <p class="lead text-muted mb-0">
          Bienvenido, <strong>{{ 'Usuario' }}</strong>
        </p>
      </div>
    </div>
  </div>

  <!-- Statistics Cards with Animations -->
  <div class="row mb-4" *ngIf="stats && !isLoading">
    <!-- Farms Card -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="stats-card card-success">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-8">
              <h6 class="card-category text-uppercase text-muted mb-0">Fincas</h6>
              <h2 class="card-title mb-0 counter">{{ stats.totalFarms }}</h2>
            </div>
            <div class="col-4 text-end">
              <div class="icon-shape bg-gradient-success text-white rounded-circle">
                <i class="bi bi-geo-alt fs-4"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Crops Card -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="stats-card card-warning">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-8">
              <h6 class="card-category text-uppercase text-muted mb-0">Cultivos</h6>
              <h2 class="card-title mb-0 counter">{{ stats.totalCrops }}</h2>
            </div>
            <div class="col-4 text-end">
              <div class="icon-shape bg-gradient-warning text-white rounded-circle">
                <i class="bi bi-flower1 fs-4"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Devices Card -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="stats-card card-info">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-8">
              <h6 class="card-category text-uppercase text-muted mb-0">Dispositivos</h6>
              <h2 class="card-title mb-0 counter">{{ stats.totalDevices }}</h2>
            </div>
            <div class="col-4 text-end">
              <div class="icon-shape bg-gradient-info text-white rounded-circle">
                <i class="bi bi-cpu fs-4"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts and Activities Section -->
  <div class="row mb-4" *ngIf="!isLoading">
    <!-- Quick Actions -->
    <div class="col-lg-8 mb-4">
      <div class="card action-card">
        <div class="card-header bg-white border-0">
          <h5 class="mb-0">
            <i class="bi bi-lightning me-2 text-warning"></i>
            Acciones Rápidas
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- Management Section -->
            <div class="col-12 mb-3">
              <h6 class="text-muted text-uppercase small">Gestión Principal</h6>
            </div>

            <!-- Farms Management -->
            <div class="col-md-3 col-6 mb-3">
              <div class="quick-action-card" (click)="navigateToFarms()">
                <div class="quick-action-icon">
                  <i class="bi bi-geo-alt-fill text-success"></i>
                </div>
                <div class="quick-action-content">
                  <h6 class="quick-action-title">Fincas</h6>
                  <p class="quick-action-description">Gestionar fincas y propiedades</p>
                </div>
                <div class="quick-action-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </div>

            <!-- Crops Management -->
            <div class="col-md-3 col-6 mb-3">
              <div class="quick-action-card" (click)="navigateToCrops()">
                <div class="quick-action-icon">
                  <i class="bi bi-flower1 text-warning"></i>
                </div>
                <div class="quick-action-content">
                  <h6 class="quick-action-title">Catálogo de Cultivos</h6>
                  <p class="quick-action-description">Gestionar tipos de cultivos</p>
                </div>
                <div class="quick-action-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </div>

            <!-- Devices Management -->
            <div class="col-md-3 col-6 mb-3">
              <div class="quick-action-card" (click)="navigateToDevices()">
                <div class="quick-action-icon">
                  <i class="bi bi-cpu text-info"></i>
                </div>
                <div class="quick-action-content">
                  <h6 class="quick-action-title">Dispositivos</h6>
                  <p class="quick-action-description">Gestionar dispositivos IoT</p>
                </div>
                <div class="quick-action-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </div>

            <!-- Crop Production Section -->
            <div class="col-12 mb-3 mt-3">
              <h6 class="text-muted text-uppercase small">Producción de Cultivos</h6>
            </div>

            <!-- Crop Phases -->
            <div class="col-md-3 col-6 mb-3">
              <div class="quick-action-card" (click)="navigateToCropPhases()">
                <div class="quick-action-icon">
                  <i class="bi bi-diagram-3 text-success"></i>
                </div>
                <div class="quick-action-content">
                  <h6 class="quick-action-title">Fases de Cultivo</h6>
                  <p class="quick-action-description">Definir etapas de crecimiento</p>
                </div>
                <div class="quick-action-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </div>

            <!-- Phase Requirements -->
            <div class="col-md-3 col-6 mb-3">
              <div class="quick-action-card" (click)="navigateToPhaseRequirements()">
                <div class="quick-action-icon">
                  <i class="bi bi-list-check text-warning"></i>
                </div>
                <div class="quick-action-content">
                  <h6 class="quick-action-title">Requerimientos por Fase</h6>
                  <p class="quick-action-description">Configurar necesidades por etapa</p>
                </div>
                <div class="quick-action-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </div>


            <!-- Technical Tools Section -->
            <div class="col-12 mb-3 mt-3">
              <h6 class="text-muted text-uppercase small">Herramientas Técnicas</h6>
            </div>

            <!-- Nutrient Solution Formulation -->
            <div class="col-md-3 col-6 mb-3">
              <div class="quick-action-card" (click)="navigateToNutrientFormulation()">
                <div class="quick-action-icon">
                  <i class="bi bi-search-heart text-primary"></i>
                </div>
                <div class="quick-action-content">
                  <h6 class="quick-action-title">Formulación Nutritiva</h6>
                  <p class="quick-action-description">Crear recetas de soluciones nutritivas</p>
                </div>
                <div class="quick-action-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </div>

            <!-- Water Analysis -->
            <div class="col-md-3 col-6 mb-3">
              <div class="quick-action-card" (click)="navigateToWaterAnalysis()">
                <div class="quick-action-icon">
                  <i class="bi bi-water text-info"></i>
                </div>
                <div class="quick-action-content">
                  <h6 class="quick-action-title">Análisis de Agua</h6>
                  <p class="quick-action-description">Gestionar fuentes de agua y química</p>
                </div>
                <div class="quick-action-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </div>

            <!-- Fertilizer Management -->
            <div class="col-md-3 col-6 mb-3">
              <div class="quick-action-card" (click)="navigateToFertilizers()">
                <div class="quick-action-icon">
                  <i class="bi bi-bag text-success"></i>
                </div>
                <div class="quick-action-content">
                  <h6 class="quick-action-title">Fertilizantes</h6>
                  <p class="quick-action-description">Gestionar catálogo de fertilizantes</p>
                </div>
                <div class="quick-action-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </div>

            <!-- Irrigation Engineering Design -->
            <div class="col-md-3 col-6 mb-3">
              <div class="quick-action-card" (click)="navigateToIrrigationDesignRequirements()">
                <div class="quick-action-icon">
                  <i class="bi bi-wrench-adjustable-circle text-info"></i>
                </div>
                <div class="quick-action-content">
                  <h6 class="quick-action-title">Diseño de Riego</h6>
                  <p class="quick-action-description">Calcular requerimientos de diseño</p>
                </div>
                <div class="quick-action-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </div>

            <!-- On Demand Irrigation Requirements -->
            <div class="col-md-3 col-6 mb-3">
              <div class="quick-action-card" (click)="navigateToIrrigationRequirements()">
                <div class="quick-action-icon">
                  <i class="bi bi-droplet text-danger"></i>
                </div>
                <div class="quick-action-content">
                  <h6 class="quick-action-title">Riego Bajo Demanda</h6>
                  <p class="quick-action-description">Calcular necesidades hídricas</p>
                </div>
                <div class="quick-action-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </div>

            <!-- Analytics Section -->
            <div class="col-12 mb-3 mt-3">
              <h6 class="text-muted text-uppercase small">Análisis y Reportes</h6>
            </div>

            <!-- Shiny Dashboard -->
            <div class="col-md-3 col-6 mb-3">
              <div class="quick-action-card" (click)="navigateToShinyDashboard()">
                <div class="quick-action-icon">
                  <i class="bi bi-speedometer2 text-secondary"></i>
                </div>
                <div class="quick-action-content">
                  <h6 class="quick-action-title">Dashboard Avanzado</h6>
                  <p class="quick-action-description">Visualizaciones interactivas</p>
                </div>
                <div class="quick-action-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-lg-4 mb-4">
      <div class="card">
        <div class="card-header bg-white border-0">
          <h5 class="mb-0">
            <i class="bi bi-clock me-2 text-info"></i>
            Actividad Reciente
          </h5>
        </div>
        <div class="card-body">
          <div class="timeline">
            <div class="timeline-item" *ngFor="let activity of recentActivities; trackBy: trackByIndex">
              <div class="timeline-marker {{ getActivityTypeClass(activity.type) }} text-white">
                <i class="{{ activity.icon }}"></i>
              </div>
              <div class="timeline-content">
                <div class="timeline-title fw-semibold">{{ activity.message }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State with Skeletons -->
  <div class="row" *ngIf="isLoading">
    <div class="col-12">
      <div class="d-flex justify-content-center align-items-center py-5">
        <div class="loading-animation">
          <div class="spinner-grow text-primary me-3" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <div>
            <h5>Cargando estadísticas...</h5>
            <p class="text-muted mb-0">Obteniendo datos del sistema AgriSmart</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State with Action -->
  <div class="row" *ngIf="errorMessage">
    <div class="col-12">
      <div class="alert alert-danger border-0 shadow-sm" role="alert">
        <div class="d-flex align-items-center">
          <i class="bi bi-exclamation-triangle fs-4 me-3"></i>
          <div class="flex-grow-1">
            <h6 class="alert-heading mb-1">Error en la carga de datos</h6>
            <p class="mb-2">{{ errorMessage }}</p>
            <button class="btn btn-danger btn-sm" (click)="refreshStats()">
              <i class="bi bi-arrow-clockwise me-1"></i>
              Intentar nuevamente
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Climate KPIs Section -->
  <div class="row mt-4" *ngIf="climateKPIs.length > 0">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-cloud-sun"></i> Indicadores Climáticos y Evapotranspiración
          </h5>
        </div>
        <div class="card-body">
          <!-- Latest KPIs Summary -->
          <div class="row mb-3">
            <div class="col-md-3">
              <div class="stat-box">
                <i class="bi bi-thermometer-half text-danger"></i>
                <h6>Temperatura Actual</h6>
                <h3>{{ climateKPIs[climateKPIs.length - 1].tempAvg | number:'1.1-1' }}°C</h3>
                <small class="text-muted">
                  Min: {{ climateKPIs[climateKPIs.length - 1].tempMin | number:'1.1-1' }}°C |
                  Max: {{ climateKPIs[climateKPIs.length - 1].tempMax | number:'1.1-1' }}°C
                </small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-box">
                <i class="bi bi-wind text-info"></i>
                <h6>Velocidad del Viento</h6>
                <h3>{{ climateKPIs[climateKPIs.length - 1].windSpeed | number:'1.1-1' }} m/s</h3>
                <small class="text-muted">Promedio actual</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-box">
                <i class="bi bi-brightness-high text-warning"></i>
                <h6>Radiación Solar</h6>
                <h3>{{ climateKPIs[climateKPIs.length - 1].solarRadiation | number:'1.0-0' }} W/m²</h3>
                <small class="text-muted">PAR actual</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-box bg-primary text-white">
                <i class="bi bi-droplet"></i>
                <h6>Evapotranspiración</h6>
                <h3>{{ climateKPIs[climateKPIs.length - 1].cropET | number:'1.2-2' }} mm/día</h3>
                <small>ET de referencia: {{ climateKPIs[climateKPIs.length - 1].referenceET | number:'1.2-2' }}</small>
              </div>
            </div>
          </div>

          <!-- ET Trend Table -->
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Temp (°C)</th>
                  <th>Viento (m/s)</th>
                  <th>Radiación (W/m²)</th>
                  <th>ET Referencia</th>
                  <th>ET Cultivo</th>
                  <th>Déficit Vapor</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let kpi of climateKPIs.slice(-10)">
                  <td>{{ kpi.date | date:'short' }}</td>
                  <td>{{ kpi.tempAvg | number:'1.1-1' }}</td>
                  <td>{{ kpi.windSpeed | number:'1.1-1' }}</td>
                  <td>{{ kpi.solarRadiation | number:'1.0-0' }}</td>
                  <td>{{ kpi.referenceET | number:'1.2-2' }} mm/día</td>
                  <td><strong>{{ kpi.cropET | number:'1.2-2' }} mm/día</strong></td>
                  <td>{{ kpi.vaporPressureDeficit | number:'1.2-2' }} kPa</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Irrigation Metrics Section -->
  <div class="row mt-4" *ngIf="irrigationMetrics.length > 0">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-water"></i> Métricas de Riego
          </h5>
        </div>
        <div class="card-body">
          <!-- Irrigation Summary -->
          <div class="row mb-3">
            <div class="col-md-3">
              <div class="stat-box">
                <i class="bi bi-droplet-fill text-primary"></i>
                <h6>Agua Total Aplicada</h6>
                <h3>{{ stats.totalWaterUsed | number:'1.0-0' }} L</h3>
                <small class="text-muted">Últimos eventos</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-box">
                <i class="bi bi-moisture text-info"></i>
                <h6>Drenaje Promedio</h6>
                <h3>{{ stats.avgDrainPercentage | number:'1.1-1' }}%</h3>
                <small class="text-muted">
                  <span
                    [class]="stats.avgDrainPercentage > 30 ? 'text-danger' : stats.avgDrainPercentage < 15 ? 'text-warning' : 'text-success'">
                    {{ stats.avgDrainPercentage > 30 ? 'Alto' : stats.avgDrainPercentage < 15 ? 'Bajo' : 'Óptimo' }}
                      </span>
                </small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-box">
                <i class="bi bi-speedometer2 text-success"></i>
                <h6>Eficiencia de Agua</h6>
                <h3>{{ stats.waterEfficiency | number:'1.1-1' }}%</h3>
                <small class="text-muted">Agua absorbida</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-box">
                <i class="bi bi-calendar-event text-secondary"></i>
                <h6>Eventos de Riego</h6>
                <h3>{{ irrigationMetrics.length }}</h3>
                <small class="text-muted">Detectados</small>
              </div>
            </div>
          </div>

          <!-- Irrigation Events Table -->
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Fecha/Hora</th>
                  <th>Intervalo (hr)</th>
                  <th>Duración (min)</th>
                  <th>Vol. por m²</th>
                  <th>Vol. por Planta</th>
                  <th>Volumen Total</th>
                  <th>Drenaje %</th>
                  <th>Caudal (L/h)</th>
                  <th>Precipitación</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let metric of irrigationMetrics.slice(-10)">
                  <td>{{ metric.date | date:'short' }}</td>
                  <td>{{ metric.intervalHours | number:'1.1-1' }}</td>
                  <td>{{ metric.lengthMinutes | number:'1.0-0' }}</td>
                  <td>{{ metric.volumePerM2 | number:'1.2-2' }} L/m²</td>
                  <td>{{ metric.volumePerPlant | number:'1.2-2' }} L</td>
                  <td><strong>{{ metric.totalVolume | number:'1.0-0' }} L</strong></td>
                  <td>
                    <span
                      [class]="metric.drainPercentage > 30 ? 'badge bg-danger' : metric.drainPercentage < 15 ? 'badge bg-warning' : 'badge bg-success'">
                      {{ metric.drainPercentage | number:'1.1-1' }}%
                    </span>
                  </td>
                  <td>{{ metric.flowRate | number:'1.0-0' }} L/h</td>
                  <td>{{ metric.precipitationRate | number:'1.2-2' }} L/m²/h</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fertilizer Recommendations Section -->
  <div class="row mt-4" *ngIf="fertilizerDosages.length > 0">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-trophy"></i> Recomendaciones de Fertilización
          </h5>
        </div>
        <div class="card-body">
          <!-- Fertilizer Summary -->
          <div class="row mb-3">
            <div class="col-md-4">
              <div class="stat-box">
                <i class="bi bi-cash-coin text-success"></i>
                <h6>Costo Total Fertilizantes</h6>
                <h3>${{ stats.fertilizerCost | number:'1.2-2' }}</h3>
                <small class="text-muted">Por aplicación</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat-box">
                <i class="bi bi-beaker text-primary"></i>
                <h6>Fertilizantes Activos</h6>
                <h3>{{ fertilizerDosages.length }}</h3>
                <small class="text-muted">Recomendados</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat-box">
                <i class="bi bi-graph-up text-info"></i>
                <h6>Eficiencia Nutricional</h6>
                <h3>{{ stats.waterEfficiency | number:'1.0-0' }}%</h3>
                <small class="text-muted">Basado en drenaje</small>
              </div>
            </div>
          </div>

          <!-- Fertilizer Dosage Table -->
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Fertilizante</th>
                  <th>Dosis (g/L)</th>
                  <th>Dosis (ml/L)</th>
                  <th>Costo por Aplicación</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let dosage of fertilizerDosages">
                  <td><strong>{{ dosage.fertilizer }}</strong></td>
                  <td>{{ dosage.dosageGramsPerLiter | number:'1.3-3' }} g/L</td>
                  <td>{{ dosage.dosageGramsPerLiter | number:'1.3-3' }} ml/L</td>
                  <td>${{ dosage.cost | number:'1.2-2' }}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" title="Ver detalles">
                      <i class="bi bi-eye"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="table-active">
                  <td colspan="3"><strong>TOTAL</strong></td>
                  <td><strong>${{ stats.fertilizerCost | number:'1.2-2' }}</strong></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Nutrient Balance Info -->
          <div class="alert alert-info mt-3" *ngIf="cropPhaseRequirements.length > 0">
            <i class="bi bi-info-circle"></i>
            <strong>Información:</strong> Los cálculos se basan en los requerimientos nutricionales de la fase de
            cultivo actual
            y la evapotranspiración calculada. Las dosis se ajustan automáticamente según las condiciones climáticas.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>