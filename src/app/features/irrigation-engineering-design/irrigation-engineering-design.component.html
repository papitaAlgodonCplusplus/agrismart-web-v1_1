<!-- src/app/features/irrigation/irrigation-engineering-design/irrigation-engineering-design.component.html -->

<div class="irrigation-engineering-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <h1>
        <i class="bi bi-diagram-3-fill text-primary"></i>
        Irrigation Engineering Design
      </h1>
      <p class="lead">Complete agronomic-hydraulic design system for irrigation infrastructure</p>
    </div>
    
    <div class="header-actions">
      <div class="btn-group" role="group">
        <button class="btn btn-outline-primary" (click)="saveDesign()" [disabled]="isSaving">
          <i class="bi" [class.bi-check-circle]="!isSaving" [class.bi-arrow-clockwise]="isSaving" 
             [class.spinner-border]="isSaving"></i>
          {{ isSaving ? 'Saving...' : 'Save Design' }}
        </button>
        
        <button class="btn btn-outline-secondary" (click)="exportDesign()" [disabled]="!currentDesign">
          <i class="bi bi-download"></i>
          Export
        </button>
        
        <button class="btn btn-outline-warning" (click)="resetDesign()">
          <i class="bi bi-arrow-counterclockwise"></i>
          Reset
        </button>
      </div>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="calculation-progress" *ngIf="isCalculating || isOptimizing">
    <div class="progress">
      <div class="progress-bar progress-bar-striped progress-bar-animated" 
           [style.width.%]="calculationProgress">
        {{ calculationProgress }}%
      </div>
    </div>
    <p class="text-center mt-2">
      {{ isCalculating ? 'Performing hydraulic calculations...' : 'Optimizing design parameters...' }}
    </p>
  </div>

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'design'" (click)="setActiveTab('design')">
        <i class="bi bi-gear-fill"></i>
        System Design
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'hydraulic'" (click)="setActiveTab('hydraulic')">
        <i class="bi bi-water"></i>
        Hydraulic Parameters
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'results'" (click)="setActiveTab('results')">
        <i class="bi bi-calculator-fill"></i>
        Calculation Results
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'optimization'" (click)="setActiveTab('optimization')">
        <i class="bi bi-graph-up"></i>
        Optimization
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'saved'" (click)="setActiveTab('saved')">
        <i class="bi bi-folder-fill"></i>
        Saved Designs ({{ savedDesigns.length }})
      </a>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    
    <!-- SYSTEM DESIGN TAB -->
    <div class="tab-pane" [class.active]="activeTab === 'design'">
      <form [formGroup]="designForm" class="design-form">
        
        <!-- Basic Information -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-info-circle"></i> Basic Information</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Design Name *</label>
                  <input type="text" class="form-control" formControlName="name" 
                         placeholder="Enter design name">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Design Type *</label>
                  <select class="form-select" formControlName="designType">
                    <option value="drip">Drip Irrigation</option>
                    <option value="sprinkler">Sprinkler System</option>
                    <option value="micro-sprinkler">Micro-Sprinkler</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-12">
                <div class="form-group">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" formControlName="description" rows="3"
                           placeholder="Enter design description"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Production Configuration -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-boxes"></i> Production Configuration</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Crop Production *</label>
                  <select class="form-select" formControlName="cropProductionId" 
                          (change)="onCropProductionChange()">
                    <option value="">Select crop production</option>
                    <option *ngFor="let crop of cropProductions" [value]="crop.id">
                      {{ crop.name }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Total Area (m²) *</label>
                  <input type="number" class="form-control" formControlName="totalArea" 
                         min="0.1" step="0.1" placeholder="0.0">
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Container Type *</label>
                  <select class="form-select" formControlName="containerId">
                    <option value="">Select container</option>
                    <option *ngFor="let container of containers" [value]="container.id">
                      {{ container.name }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Dropper Type *</label>
                  <select class="form-select" formControlName="dropperId">
                    <option value="">Select dropper</option>
                    <option *ngFor="let dropper of droppers" [value]="dropper.id">
                      {{ dropper.name }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Growing Medium *</label>
                  <select class="form-select" formControlName="growingMediumId">
                    <option value="">Select growing medium</option>
                    <option *ngFor="let medium of growingMediums" [value]="medium.id">
                      {{ medium.name }}
                    </option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Number of Sectors</label>
                  <input type="number" class="form-control" formControlName="numberOfSectors" 
                         min="1" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Container Density (cont/m²)</label>
                  <input type="number" class="form-control" formControlName="containerDensity" 
                         min="0.01" step="0.01">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Plant Density (plants/m²)</label>
                  <input type="number" class="form-control" formControlName="plantDensity" 
                         min="0.01" step="0.01">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Daily Water Req. (L/day/plant)</label>
                  <input type="number" class="form-control" formControlName="dailyWaterRequirement" 
                         min="0.1" step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Environmental Parameters -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-cloud-sun"></i> Environmental Parameters</h4>
          </div>
          <div class="card-body" formGroupName="climate">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Avg Temperature (°C)</label>
                  <input type="number" class="form-control" formControlName="averageTemperature" 
                         min="0" step="0.1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Avg Humidity (%)</label>
                  <input type="number" class="form-control" formControlName="averageHumidity" 
                         min="0" max="100" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Wind Speed (m/s)</label>
                  <input type="number" class="form-control" formControlName="windSpeed" 
                         min="0" step="0.1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Solar Radiation (MJ/m²/day)</label>
                  <input type="number" class="form-control" formControlName="solarRadiation" 
                         min="0" step="0.1">
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Elevation (m.a.s.l.)</label>
                  <input type="number" class="form-control" formControlName="elevation" 
                         min="0" step="1">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Irrigation Frequency (times/day)</label>
                  <input type="number" class="form-control" formControlName="irrigationFrequency" 
                         min="0.1" step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Water Source Configuration -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-droplet"></i> Water Source & Quality</h4>
          </div>
          <div class="card-body" formGroupName="waterSource">
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Source Type</label>
                  <select class="form-select" formControlName="sourceType">
                    <option value="well">Well</option>
                    <option value="reservoir">Reservoir</option>
                    <option value="municipal">Municipal</option>
                    <option value="river">River</option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Water Pressure (bar)</label>
                  <input type="number" class="form-control" formControlName="waterPressure" 
                         min="0" step="0.1">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Available Flow (L/min)</label>
                  <input type="number" class="form-control" formControlName="waterFlow" 
                         min="0" step="1">
                </div>
              </div>
            </div>

            <!-- Water Quality Parameters -->
            <div class="mt-3" formGroupName="waterQuality">
              <h6>Water Quality Parameters</h6>
              <div class="row">
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">pH</label>
                    <input type="number" class="form-control" formControlName="ph" 
                           min="4" max="9" step="0.1">
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">EC (dS/m)</label>
                    <input type="number" class="form-control" formControlName="electricalConductivity" 
                           min="0" step="0.1">
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">TDS (ppm)</label>
                    <input type="number" class="form-control" formControlName="totalDissolvedSolids" 
                           min="0" step="1">
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">NO₃ (ppm)</label>
                    <input type="number" class="form-control" formControlName="nitrates" 
                           min="0" step="0.1">
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">P (ppm)</label>
                    <input type="number" class="form-control" formControlName="phosphorus" 
                           min="0" step="0.1">
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">K (ppm)</label>
                    <input type="number" class="form-control" formControlName="potassium" 
                           min="0" step="0.1">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pipeline Configuration -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-pipe"></i> Pipeline Configuration</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Main Pipe Diameter (mm)</label>
                  <input type="number" class="form-control" formControlName="mainPipeDiameter" 
                         min="20" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Secondary Pipe Diameter (mm)</label>
                  <input type="number" class="form-control" formControlName="secondaryPipeDiameter" 
                         min="16" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Lateral Pipe Diameter (mm)</label>
                  <input type="number" class="form-control" formControlName="lateralPipeDiameter" 
                         min="12" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Pipeline Material</label>
                  <select class="form-select" formControlName="pipelineMaterial">
                    <option value="PE">Polyethylene (PE)</option>
                    <option value="PVC">PVC</option>
                    <option value="HDPE">HDPE</option>
                    <option value="STEEL">Steel</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- System Components -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-gear-wide-connected"></i> System Components</h4>
          </div>
          <div class="card-body" formGroupName="components">
            <div class="row">
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" formControlName="hasFiltration" id="hasFiltration">
                  <label class="form-check-label" for="hasFiltration">
                    <i class="bi bi-funnel"></i> Filtration System
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" formControlName="hasAutomation" id="hasAutomation">
                  <label class="form-check-label" for="hasAutomation">
                    <i class="bi bi-robot"></i> Automation System
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" formControlName="hasFertigation" id="hasFertigation">
                  <label class="form-check-label" for="hasFertigation">
                    <i class="bi bi-moisture"></i> Fertigation System
                  </label>
                </div>
              </div>
            </div>
            
            <div class="row mt-3">
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" formControlName="hasBackflowPrevention" id="hasBackflowPrevention">
                  <label class="form-check-label" for="hasBackflowPrevention">
                    <i class="bi bi-shield-check"></i> Backflow Prevention
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" formControlName="hasPressureRegulation" id="hasPressureRegulation">
                  <label class="form-check-label" for="hasPressureRegulation">
                    <i class="bi bi-speedometer2"></i> Pressure Regulation
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" formControlName="hasFlowMeter" id="hasFlowMeter">
                  <label class="form-check-label" for="hasFlowMeter">
                    <i class="bi bi-speedometer"></i> Flow Meter
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary" (click)="setActiveTab('hydraulic')">
            <i class="bi bi-arrow-right"></i>
            Continue to Hydraulic Parameters
          </button>
          
          <div>
            <button type="button" class="btn btn-secondary me-2" (click)="toggleAdvancedOptions()">
              <i class="bi" [class.bi-chevron-down]="!showAdvancedOptions" [class.bi-chevron-up]="showAdvancedOptions"></i>
              {{ showAdvancedOptions ? 'Hide' : 'Show' }} Advanced Options
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- HYDRAULIC PARAMETERS TAB -->
    <div class="tab-pane" [class.active]="activeTab === 'hydraulic'">
      <form [formGroup]="hydraulicForm" class="hydraulic-form">
        
        <!-- Operating Parameters -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-speedometer2"></i> Operating Parameters</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Operating Pressure (bar) *</label>
                  <input type="number" class="form-control" formControlName="operatingPressure" 
                         min="0.5" step="0.1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Max Flow Rate (L/min) *</label>
                  <input type="number" class="form-control" formControlName="maxFlowRate" 
                         min="0.1" step="0.1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Design Velocity (m/s) *</label>
                  <input type="number" class="form-control" formControlName="designVelocity" 
                         min="0.5" max="3" step="0.1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Elevation Change (m)</label>
                  <input type="number" class="form-control" formControlName="elevationChange" 
                         step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Emitter Configuration -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-droplet-half"></i> Emitter Configuration</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Emitter Flow Rate (L/h) *</label>
                  <input type="number" class="form-control" formControlName="emitterFlowRate" 
                         min="0.1" step="0.1">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Emitter Spacing (m) *</label>
                  <input type="number" class="form-control" formControlName="emitterSpacing" 
                         min="0.1" step="0.1">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Emitter Pressure (bar) *</label>
                  <input type="number" class="form-control" formControlName="emitterPressure" 
                         min="0.5" step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pressure Loss Parameters -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-graph-down"></i> Pressure Loss Parameters</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Friction Loss Coefficient</label>
                  <input type="number" class="form-control" formControlName="frictionLossCoefficient" 
                         min="0" step="0.01">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Minor Loss Coefficient</label>
                  <input type="number" class="form-control" formControlName="minorLossCoefficient" 
                         min="0" step="0.01">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Uniformity Requirements -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-bullseye"></i> Uniformity Requirements</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Target Uniformity (%) *</label>
                  <input type="number" class="form-control" formControlName="targetUniformity" 
                         min="80" max="98" step="1">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Max Pressure Variation (%) *</label>
                  <input type="number" class="form-control" formControlName="pressureVariation" 
                         min="5" max="20" step="1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Real-time Calculations Display -->
        <div class="card mb-4" *ngIf="realTimeCalculations$ | async as calculations">
          <div class="card-header">
            <h4><i class="bi bi-calculator"></i> Real-time Calculations</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="metric-card">
                  <div class="metric-value">{{ formatNumber(calculations.recommendedFlowRate) }}</div>
                  <div class="metric-label">Recommended Flow Rate (L/min)</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card">
                  <div class="metric-value">{{ formatNumber(calculations.pressureLoss) }}</div>
                  <div class="metric-label">Estimated Pressure Loss (bar)</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card">
                  <div class="metric-value">{{ formatNumber(calculations.systemEfficiency) }}</div>
                  <div class="metric-label">System Efficiency (%)</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card">
                  <div class="metric-value">{{ formatNumber(calculations.waterVelocity) }}</div>
                  <div class="metric-label">Water Velocity (m/s)</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary" (click)="setActiveTab('design')">
            <i class="bi bi-arrow-left"></i>
            Back to Design
          </button>
          
          <button type="button" class="btn btn-primary" (click)="performHydraulicCalculations()" 
                  [disabled]="!designForm.valid || !hydraulicForm.valid || isCalculating">
            <i class="bi" [class.bi-calculator]="!isCalculating" [class.bi-arrow-clockwise]="isCalculating"
               [class.spinner-border]="isCalculating"></i>
            {{ isCalculating ? 'Calculating...' : 'Perform Hydraulic Calculations' }}
          </button>
        </div>
      </form>
    </div>

    <!-- CALCULATION RESULTS TAB -->
    <div class="tab-pane" [class.active]="activeTab === 'results'">
      
      <!-- Hydraulic Results -->
      <div class="card mb-4" *ngIf="hydraulicResults">
        <div class="card-header">
          <h4><i class="bi bi-graph-up"></i> Hydraulic Calculation Results</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <div class="metric-card success">
                <div class="metric-value">{{ formatNumber(hydraulicResults.totalPressureLoss) }}</div>
                <div class="metric-label">Total Pressure Loss (bar)</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card info">
                <div class="metric-value">{{ formatNumber(hydraulicResults.systemFlowRate) }}</div>
                <div class="metric-label">System Flow Rate (L/min)</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card warning">
                <div class="metric-value">{{ formatPercentage(hydraulicResults.distributionUniformity) }}</div>
                <div class="metric-label">Distribution Uniformity</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card primary">
                <div class="metric-value">{{ formatPercentage(hydraulicResults.applicationEfficiency) }}</div>
                <div class="metric-label">Application Efficiency</div>
              </div>
            </div>
          </div>

          <!-- Detailed Results -->
          <div class="row mt-4">
            <div class="col-md-6">
              <h6>Pressure Analysis</h6>
              <table class="table table-sm">
                <tbody>
                  <tr>
                    <td>Main Line Pressure Loss</td>
                    <td>{{ formatNumber(hydraulicResults.mainLinePressureLoss) }} bar</td>
                  </tr>
                  <tr>
                    <td>Secondary Line Pressure Loss</td>
                    <td>{{ formatNumber(hydraulicResults.secondaryLinePressureLoss) }} bar</td>
                  </tr>
                  <tr>
                    <td>Lateral Line Pressure Loss</td>
                    <td>{{ formatNumber(hydraulicResults.lateralLinePressureLoss) }} bar</td>
                  </tr>
                  <tr>
                    <td>Minor Losses</td>
                    <td>{{ formatNumber(hydraulicResults.minorLosses) }} bar</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div class="col-md-6">
              <h6>Flow Analysis</h6>
              <table class="table table-sm">
                <tbody>
                  <tr>
                    <td>Design Flow Rate</td>
                    <td>{{ formatNumber(hydraulicResults.designFlowRate) }} L/min</td>
                  </tr>
                  <tr>
                    <td>Peak Flow Rate</td>
                    <td>{{ formatNumber(hydraulicResults.peakFlowRate) }} L/min</td>
                  </tr>
                  <tr>
                    <td>Average Velocity</td>
                    <td>{{ formatNumber(hydraulicResults.averageVelocity) }} m/s</td>
                  </tr>
                  <tr>
                    <td>Reynolds Number</td>
                    <td>{{ formatNumber(hydraulicResults.reynoldsNumber, 0) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Validation Results -->
      <div class="card mb-4" *ngIf="validationResults">
        <div class="card-header">
          <h4>
            <i class="bi" [class.bi-check-circle-fill]="validationResults.isValid" 
               [class.bi-exclamation-triangle-fill]="!validationResults.isValid"></i>
            System Validation Results
          </h4>
        </div>
        <div class="card-body">
          <div class="alert" [class.alert-success]="validationResults.isValid" 
               [class.alert-warning]="!validationResults.isValid">
            <strong>Validation Status:</strong> {{ validationResults.isValid ? 'PASSED' : 'ISSUES FOUND' }}
          </div>

          <!-- Validation Issues -->
          <div *ngIf="validationResults.issues && validationResults.issues.length > 0">
            <h6>Issues Found:</h6>
            <div class="alert" *ngFor="let issue of validationResults.issues" 
                 [class]="'alert-' + getValidationSeverity(issue)">
              <strong>{{ issue.category }}:</strong> {{ issue.message }}
              <div *ngIf="issue.recommendation" class="mt-2">
                <small><strong>Recommendation:</strong> {{ issue.recommendation }}</small>
              </div>
            </div>
          </div>

          <!-- Validation Metrics -->
          <div class="row mt-3">
            <div class="col-md-4">
              <div class="metric-card" [class.success]="validationResults.pressureValidation.isValid"
                   [class.danger]="!validationResults.pressureValidation.isValid">
                <div class="metric-value">{{ validationResults.pressureValidation.isValid ? 'PASS' : 'FAIL' }}</div>
                <div class="metric-label">Pressure Validation</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="metric-card" [class.success]="validationResults.flowValidation.isValid"
                   [class.danger]="!validationResults.flowValidation.isValid">
                <div class="metric-value">{{ validationResults.flowValidation.isValid ? 'PASS' : 'FAIL' }}</div>
                <div class="metric-label">Flow Validation</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="metric-card" [class.success]="validationResults.uniformityValidation.isValid"
                   [class.danger]="!validationResults.uniformityValidation.isValid">
                <div class="metric-value">{{ validationResults.uniformityValidation.isValid ? 'PASS' : 'FAIL' }}</div>
                <div class="metric-label">Uniformity Validation</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Economic Analysis -->
      <div class="card mb-4" *ngIf="economicAnalysis">
        <div class="card-header">
          <h4><i class="bi bi-currency-dollar"></i> Economic Analysis</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <div class="metric-card primary">
                <div class="metric-value">{{ formatCurrency(economicAnalysis.totalInvestment) }}</div>
                <div class="metric-label">Total Investment</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card info">
                <div class="metric-value">{{ formatCurrency(economicAnalysis.annualOperatingCost) }}</div>
                <div class="metric-label">Annual Operating Cost</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card success">
                <div class="metric-value">{{ formatNumber(economicAnalysis.paybackPeriod, 1) }}</div>
                <div class="metric-label">Payback Period (years)</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card warning">
                <div class="metric-value">{{ formatPercentage(economicAnalysis.roi) }}</div>
                <div class="metric-label">ROI</div>
              </div>
            </div>
          </div>

          <!-- Cost Breakdown -->
          <div class="row mt-4">
            <div class="col-md-6">
              <h6>Investment Breakdown</h6>
              <table class="table table-sm">
                <tbody>
                  <tr>
                    <td>Pipeline & Fittings</td>
                    <td>{{ formatCurrency(economicAnalysis.pipelineCost) }}</td>
                  </tr>
                  <tr>
                    <td>Emitters & Drippers</td>
                    <td>{{ formatCurrency(economicAnalysis.emitterCost) }}</td>
                  </tr>
                  <tr>
                    <td>Pumping System</td>
                    <td>{{ formatCurrency(economicAnalysis.pumpingCost) }}</td>
                  </tr>
                  <tr>
                    <td>Control & Automation</td>
                    <td>{{ formatCurrency(economicAnalysis.controlCost) }}</td>
                  </tr>
                  <tr>
                    <td>Installation & Labor</td>
                    <td>{{ formatCurrency(economicAnalysis.installationCost) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div class="col-md-6">
              <h6>Annual Operating Costs</h6>
              <table class="table table-sm">
                <tbody>
                  <tr>
                    <td>Energy Costs</td>
                    <td>{{ formatCurrency(economicAnalysis.energyCost) }}</td>
                  </tr>
                  <tr>
                    <td>Water Costs</td>
                    <td>{{ formatCurrency(economicAnalysis.waterCost) }}</td>
                  </tr>
                  <tr>
                    <td>Maintenance</td>
                    <td>{{ formatCurrency(economicAnalysis.maintenanceCost) }}</td>
                  </tr>
                  <tr>
                    <td>Labor</td>
                    <td>{{ formatCurrency(economicAnalysis.laborCost) }}</td>
                  </tr>
                  <tr>
                    <td>Replacement Parts</td>
                    <td>{{ formatCurrency(economicAnalysis.replacementCost) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" (click)="setActiveTab('hydraulic')">
          <i class="bi bi-arrow-left"></i>
          Back to Hydraulic Parameters
        </button>
        
        <div>
          <button type="button" class="btn btn-info me-2" (click)="performEconomicAnalysis()" 
                  [disabled]="!hydraulicResults">
            <i class="bi bi-currency-dollar"></i>
            Economic Analysis
          </button>
          
          <button type="button" class="btn btn-primary" (click)="setActiveTab('optimization')" 
                  [disabled]="!validationResults || !validationResults.isValid">
            <i class="bi bi-arrow-right"></i>
            Continue to Optimization
          </button>
        </div>
      </div>
    </div>

    <!-- OPTIMIZATION TAB -->
    <div class="tab-pane" [class.active]="activeTab === 'optimization'">
      <form [formGroup]="optimizationForm" class="optimization-form">
        
        <!-- Optimization Objectives -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-target"></i> Optimization Objectives</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Primary Objective</label>
                  <select class="form-select" formControlName="primaryObjective">
                    <option value="efficiency">Maximum Efficiency</option>
                    <option value="cost">Minimum Cost</option>
                    <option value="uniformity">Best Uniformity</option>
                    <option value="sustainability">Sustainability</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Optimization Method</label>
                  <select class="form-select" formControlName="optimizationMethod">
                    <option value="genetic">Genetic Algorithm</option>
                    <option value="gradient">Gradient Descent</option>
                    <option value="hybrid">Hybrid Approach</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Weighting Factors -->
            <div class="mt-3" formGroupName="weightingFactors">
              <h6>Weighting Factors (%)</h6>
              <div class="row">
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Efficiency</label>
                    <input type="range" class="form-range" formControlName="efficiency" 
                           min="0" max="100" step="5">
                    <div class="text-center">{{ optimizationForm.get('weightingFactors.efficiency')?.value }}%</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Cost</label>
                    <input type="range" class="form-range" formControlName="cost" 
                           min="0" max="100" step="5">
                    <div class="text-center">{{ optimizationForm.get('weightingFactors.cost')?.value }}%</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Uniformity</label>
                    <input type="range" class="form-range" formControlName="uniformity" 
                           min="0" max="100" step="5">
                    <div class="text-center">{{ optimizationForm.get('weightingFactors.uniformity')?.value }}%</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Sustainability</label>
                    <input type="range" class="form-range" formControlName="sustainability" 
                           min="0" max="100" step="5">
                    <div class="text-center">{{ optimizationForm.get('weightingFactors.sustainability')?.value }}%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Constraints -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-lock"></i> Optimization Constraints</h4>
          </div>
          <div class="card-body" formGroupName="constraints">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Max Investment ($)</label>
                  <input type="number" class="form-control" formControlName="maxInvestment" 
                         min="0" step="100">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Min Efficiency (%)</label>
                  <input type="number" class="form-control" formControlName="minEfficiency" 
                         min="70" max="98" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Max Water Consumption (L/day)</label>
                  <input type="number" class="form-control" formControlName="maxWaterConsumption" 
                         min="0" step="10">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Available Area (m²)</label>
                  <input type="number" class="form-control" formControlName="availableArea" 
                         min="0" step="1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Advanced Optimization Parameters -->
        <div class="card mb-4" *ngIf="showAdvancedOptions">
          <div class="card-header">
            <h4><i class="bi bi-gear"></i> Advanced Parameters</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Max Iterations</label>
                  <input type="number" class="form-control" formControlName="maxIterations" 
                         min="100" max="10000" step="100">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Convergence Tolerance</label>
                  <input type="number" class="form-control" formControlName="convergenceTolerance" 
                         min="0.0001" max="0.1" step="0.001">
                </div>
              </div>
            </div>

            <!-- Scenario Planning -->
            <div class="mt-3" formGroupName="includeScenarios">
              <h6>Scenario Planning</h6>
              <div class="row">
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" formControlName="climateChange" id="climateChange">
                    <label class="form-check-label" for="climateChange">
                      Climate Change Impact
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" formControlName="waterScarcity" id="waterScarcity">
                    <label class="form-check-label" for="waterScarcity">
                      Water Scarcity Scenarios
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" formControlName="expansionPlanning" id="expansionPlanning">
                    <label class="form-check-label" for="expansionPlanning">
                      Future Expansion
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" formControlName="maintenanceScheduling" id="maintenanceScheduling">
                    <label class="form-check-label" for="maintenanceScheduling">
                      Maintenance Scheduling
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Optimization Results -->
        <div class="card mb-4" *ngIf="optimizationResults">
          <div class="card-header">
            <h4><i class="bi bi-graph-up-arrow"></i> Optimization Results</h4>
          </div>
          <div class="card-body">
            <div class="alert alert-success">
              <strong>Optimization Completed!</strong> 
              Found optimal solution in {{ optimizationResults.iterations }} iterations.
            </div>

            <!-- Performance Metrics -->
            <div class="row">
              <div class="col-md-3">
                <div class="metric-card success">
                  <div class="metric-value">{{ formatPercentage(optimizationResults.achievedEfficiency) }}</div>
                  <div class="metric-label">Achieved Efficiency</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card info">
                  <div class="metric-value">{{ formatCurrency(optimizationResults.optimizedCost) }}</div>
                  <div class="metric-label">Optimized Cost</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card warning">
                  <div class="metric-value">{{ formatPercentage(optimizationResults.uniformityImprovement) }}</div>
                  <div class="metric-label">Uniformity Improvement</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card primary">
                  <div class="metric-value">{{ formatNumber(optimizationResults.overallScore) }}</div>
                  <div class="metric-label">Overall Score</div>
                </div>
              </div>
            </div>

            <!-- Optimized Parameters -->
            <div class="row mt-4">
              <div class="col-md-6">
                <h6>Optimized Design Parameters</h6>
                <table class="table table-sm">
                  <tbody>
                    <tr>
                      <td>Emitter Flow Rate</td>
                      <td>{{ formatNumber(optimizationResults.optimizedParameters?.emitterFlowRate) }} L/h</td>
                    </tr>
                    <tr>
                      <td>Operating Pressure</td>
                      <td>{{ formatNumber(optimizationResults.optimizedParameters?.operatingPressure) }} bar</td>
                    </tr>
                    <tr>
                      <td>Emitter Spacing</td>
                      <td>{{ formatNumber(optimizationResults.optimizedParameters?.emitterSpacing) }} m</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div class="col-md-6">
                <h6>Performance Comparison</h6>
                <table class="table table-sm">
                  <tbody>
                    <tr>
                      <td>Cost Reduction</td>
                      <td class="text-success">{{ formatPercentage(optimizationResults.costReduction) }}</td>
                    </tr>
                    <tr>
                      <td>Efficiency Gain</td>
                      <td class="text-success">{{ formatPercentage(optimizationResults.efficiencyGain) }}</td>
                    </tr>
                    <tr>
                      <td>Water Savings</td>
                      <td class="text-success">{{ formatPercentage(optimizationResults.waterSavings) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Apply Optimization -->
            <div class="text-center mt-3">
              <button type="button" class="btn btn-success" (click)="applyOptimizedParameters(optimizationResults.optimizedParameters)">
                <i class="bi bi-check-circle"></i>
                Apply Optimized Parameters
              </button>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary" (click)="setActiveTab('results')">
            <i class="bi bi-arrow-left"></i>
            Back to Results
          </button>
          
          <button type="button" class="btn btn-primary" (click)="performDesignOptimization()" 
                  [disabled]="!validationResults?.isValid || isOptimizing">
            <i class="bi" [class.bi-graph-up-arrow]="!isOptimizing" [class.bi-arrow-clockwise]="isOptimizing"
               [class.spinner-border]="isOptimizing"></i>
            {{ isOptimizing ? 'Optimizing...' : 'Perform Design Optimization' }}
          </button>
        </div>
      </form>
    </div>

    <!-- SAVED DESIGNS TAB -->
    <div class="tab-pane" [class.active]="activeTab === 'saved'">
      <div class="saved-designs-container">
        
        <!-- Current Design Info -->
        <div class="card mb-4" *ngIf="currentDesign">
          <div class="card-header">
            <h4><i class="bi bi-file-earmark-check"></i> Current Design</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <h5>{{ currentDesign.name }}</h5>
                <p class="text-muted">{{ currentDesign.description }}</p>
                <small class="text-muted">
                  Created: {{ currentDesign.createdAt | date:'medium' }} | 
                  Updated: {{ currentDesign.updatedAt | date:'medium' }}
                </small>
              </div>
              <div class="col-md-4 text-end">
                <span class="badge" [class.badge-success]="currentDesign.status === 'validated'"
                      [class.badge-warning]="currentDesign.status === 'draft'">
                  {{ currentDesign.status | titlecase }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Saved Designs List -->
        <div class="card">
          <div class="card-header">
            <h4><i class="bi bi-folder-open"></i> Saved Designs Library</h4>
          </div>
          <div class="card-body">
            
            <div *ngIf="savedDesigns.length === 0" class="text-center text-muted py-4">
              <i class="bi bi-folder-x display-4"></i>
              <p class="mt-3">No saved designs found. Create and save your first irrigation design!</p>
            </div>

            <div class="row" *ngIf="savedDesigns.length > 0">
              <div class="col-md-6 col-lg-4 mb-3" *ngFor="let design of savedDesigns">
                <div class="card design-card h-100" 
                     [class.border-primary]="currentDesign?.id === design.id">
                  
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">{{ design.name }}</h6>
                    <span class="badge" [class.badge-success]="design.status === 'validated'"
                          [class.badge-warning]="design.status === 'draft'">
                      {{ design.status }}
                    </span>
                  </div>
                  
                  <div class="card-body">
                    <p class="card-text text-muted small">{{ design.description || 'No description' }}</p>
                    
                    <!-- Quick Stats -->
                    <div class="quick-stats" *ngIf="design.calculationResults">
                      <div class="stat-item">
                        <small class="text-muted">Efficiency:</small>
                        <strong>{{ formatPercentage(design.calculationResults.hydraulic?.applicationEfficiency || 0) }}</strong>
                      </div>
                      <div class="stat-item">
                        <small class="text-muted">Investment:</small>
                        <strong>{{ formatCurrency(design.calculationResults.economic?.totalInvestment || 0) }}</strong>
                      </div>
                    </div>
                    
                    <small class="text-muted d-block mt-2">
                      {{ design.updatedAt | date:'short' }}
                    </small>
                  </div>
                  
                  <div class="card-footer">
                    <div class="btn-group w-100" role="group">
                      <button class="btn btn-outline-primary btn-sm" (click)="loadDesign(design)">
                        <i class="bi bi-folder-open"></i>
                        Load
                      </button>
                      <button class="btn btn-outline-info btn-sm" (click)="exportDesign()" 
                              [disabled]="currentDesign?.id !== design.id">
                        <i class="bi bi-download"></i>
                        Export
                      </button>
                      <button class="btn btn-outline-danger btn-sm" (click)="deleteDesign(design)">
                        <i class="bi bi-trash"></i>
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>