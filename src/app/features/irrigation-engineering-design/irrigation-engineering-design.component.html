<!-- src/app/features/irrigation/irrigation-engineering-design/irrigation-engineering-design.component.html -->

<div class="irrigation-engineering-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <h1>
        <i class="bi bi-diagram-3-fill text-primary"></i>
        Diseño de Ingeniería de Riego
      </h1>
      <p class="lead">Sistema completo de diseño agronómico-hidráulico para infraestructura de riego</p>
    </div>

    <div class="header-actions">
      <div class="btn-group" role="group">
        <button class="btn btn-outline-primary" (click)="saveDesign()" [disabled]="isSaving">
          <i class="bi" [class.bi-check-circle]="!isSaving" [class.bi-arrow-clockwise]="isSaving"
            [class.spinner-border]="isSaving"></i>
          {{ isSaving ? 'Guardando...' : 'Guardar Diseño' }}
        </button>

        <button class="btn btn-outline-secondary" (click)="exportDesign()" [disabled]="!currentDesign">
          <i class="bi bi-download"></i>
          Exportar
        </button>

        <button class="btn btn-outline-warning" (click)="resetDesign()">
          <i class="bi bi-arrow-counterclockwise"></i>
          Restablecer
        </button>
      </div>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="calculation-progress" *ngIf="isCalculating || isOptimizing">
    <div class="progress">
      <div class="progress-bar progress-bar-striped progress-bar-animated" [style.width.%]="calculationProgress">
        {{ calculationProgress }}%
      </div>
    </div>
    <p class="text-center mt-2">
      {{ isCalculating ? 'Realizando cálculos hidráulicos...' : 'Optimizando parámetros de diseño...' }}
    </p>
  </div>

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'design'" (click)="setActiveTab('design')">
        <i class="bi bi-gear-fill"></i>
        Diseño del Sistema
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'hydraulic'" (click)="setActiveTab('hydraulic')">
        <i class="bi bi-water"></i>
        Parámetros Hidráulicos
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'results'" (click)="setActiveTab('results')">
        <i class="bi bi-calculator-fill"></i>
        Resultados de Cálculos
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'optimization'" (click)="setActiveTab('optimization')">
        <i class="bi bi-graph-up"></i>
        Optimización
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'saved'" (click)="setActiveTab('saved')">
        <i class="bi bi-folder-fill"></i>
        Diseños Guardados ({{ savedDesigns.length }})
      </a>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">

    <!-- SYSTEM DESIGN TAB -->
    <div class="tab-pane" [class.active]="activeTab === 'design'">
      <form [formGroup]="designForm" class="design-form">

        <!-- Basic Information -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-info-circle"></i> Información Básica</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Nombre del Diseño *</label>
                  <input type="text" class="form-control" formControlName="name"
                    placeholder="Ingrese el nombre del diseño">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Tipo de Diseño *</label>
                  <select class="form-select" formControlName="designType">
                    <option value="drip">Riego por Goteo</option>
                    <option value="sprinkler">Sistema de Aspersión</option>
                    <option value="micro-sprinkler">Micro-Aspersión</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
                <div class="form-group">
                  <label class="form-label">Descripción</label>
                  <textarea class="form-control" formControlName="description" rows="3"
                    placeholder="Ingrese la descripción del diseño"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Production Configuration -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-boxes"></i> Configuración de Producción</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Producción de Cultivo *</label>
                  <select class="form-select" formControlName="cropProductionId" (change)="onCropProductionChange()">
                    <option value="">Seleccionar producción de cultivo</option>
                    <option *ngFor="let crop of cropProductions" [value]="crop.id">
                      {{ crop.name }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Área Total (m²) *</label>
                  <input type="number" class="form-control" formControlName="totalArea" min="0.1" step="0.1"
                    placeholder="0.0">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Tipo de Contenedor *</label>
                  <select class="form-select" formControlName="containerId">
                    <option value="">Seleccionar contenedor</option>
                    <option *ngFor="let container of containers" [value]="container.id">
                      {{ container.name }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Tipo de Gotero *</label>
                  <select class="form-select" formControlName="dropperId">
                    <option value="">Seleccionar gotero</option>
                    <option *ngFor="let dropper of droppers" [value]="dropper.id">
                      {{ dropper.name }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Medio de Cultivo *</label>
                  <select class="form-select" formControlName="growingMediumId">
                    <option value="">Seleccionar medio de cultivo</option>
                    <option *ngFor="let medium of growingMediums" [value]="medium.id">
                      {{ medium.name }}
                    </option>
                  </select>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Número de Sectores</label>
                  <input type="number" class="form-control" formControlName="numberOfSectors" min="1" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Densidad de Contenedores (cont/m²)</label>
                  <input type="number" class="form-control" formControlName="containerDensity" min="0.01" step="0.01">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Densidad de Plantas (plantas/m²)</label>
                  <input type="number" class="form-control" formControlName="plantDensity" min="0.01" step="0.01">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Req. Diario de Agua (L/día/planta)</label>
                  <input type="number" class="form-control" formControlName="dailyWaterRequirement" min="0.1"
                    step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Environmental Parameters -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-cloud-sun"></i> Parámetros Ambientales</h4>
          </div>
          <div class="card-body" formGroupName="climate">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Temperatura Promedio (°C)</label>
                  <input type="number" class="form-control" formControlName="averageTemperature" min="0" step="0.1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Humedad Promedio (%)</label>
                  <input type="number" class="form-control" formControlName="averageHumidity" min="0" max="100"
                    step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Velocidad del Viento (m/s)</label>
                  <input type="number" class="form-control" formControlName="windSpeed" min="0" step="0.1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Radiación Solar (MJ/m²/día)</label>
                  <input type="number" class="form-control" formControlName="solarRadiation" min="0" step="0.1">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Elevación (m.s.n.m.)</label>
                  <input type="number" class="form-control" formControlName="elevation" min="0" step="1">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Frecuencia de Riego (veces/día)</label>
                  <input type="number" class="form-control" formControlName="irrigationFrequency" min="0.1" step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Water Source Configuration -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-droplet"></i> Fuente de Agua y Calidad</h4>
          </div>
          <div class="card-body" formGroupName="waterSource">
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Tipo de Fuente</label>
                  <select class="form-select" formControlName="sourceType">
                    <option value="well">Pozo</option>
                    <option value="reservoir">Embalse</option>
                    <option value="municipal">Municipal</option>
                    <option value="river">Río</option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Presión del Agua (bar)</label>
                  <input type="number" class="form-control" formControlName="waterPressure" min="0" step="0.1">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Caudal Disponible (L/min)</label>
                  <input type="number" class="form-control" formControlName="waterFlow" min="0" step="1">
                </div>
              </div>
            </div>

            <!-- Water Quality Parameters -->
            <div class="mt-3" formGroupName="waterQuality">
              <h6>Parámetros de Calidad del Agua</h6>
              <div class="row">
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">pH</label>
                    <input type="number" class="form-control" formControlName="ph" min="4" max="9" step="0.1">
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">CE (dS/m)</label>
                    <input type="number" class="form-control" formControlName="electricalConductivity" min="0"
                      step="0.1">
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">SDT (ppm)</label>
                    <input type="number" class="form-control" formControlName="totalDissolvedSolids" min="0" step="1">
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">NO₃ (ppm)</label>
                    <input type="number" class="form-control" formControlName="nitrates" min="0" step="0.1">
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">P (ppm)</label>
                    <input type="number" class="form-control" formControlName="phosphorus" min="0" step="0.1">
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">K (ppm)</label>
                    <input type="number" class="form-control" formControlName="potassium" min="0" step="0.1">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pipeline Configuration -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-pipe"></i> Configuración de Tuberías</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Diámetro Tubería Principal (mm)</label>
                  <input type="number" class="form-control" formControlName="mainPipeDiameter" min="20" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Diámetro Tubería Secundaria (mm)</label>
                  <input type="number" class="form-control" formControlName="secondaryPipeDiameter" min="16" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Diámetro Tubería Lateral (mm)</label>
                  <input type="number" class="form-control" formControlName="lateralPipeDiameter" min="12" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Material de Tubería</label>
                  <select class="form-select" formControlName="pipelineMaterial">
                    <option value="PE">Polietileno (PE)</option>
                    <option value="PVC">PVC</option>
                    <option value="HDPE">HDPE</option>
                    <option value="STEEL">Acero</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- System Components -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-gear-wide-connected"></i> Componentes del Sistema</h4>
          </div>
          <div class="card-body" formGroupName="components">
            <div class="row">
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" formControlName="hasFiltration" id="hasFiltration">
                  <label class="form-check-label" for="hasFiltration">
                    <i class="bi bi-funnel"></i> Sistema de Filtración
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" formControlName="hasAutomation" id="hasAutomation">
                  <label class="form-check-label" for="hasAutomation">
                    <i class="bi bi-robot"></i> Sistema de Automatización
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" formControlName="hasFertigation" id="hasFertigation">
                  <label class="form-check-label" for="hasFertigation">
                    <i class="bi bi-moisture"></i> Sistema de Fertirriego
                  </label>
                </div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" formControlName="hasBackflowPrevention"
                    id="hasBackflowPrevention">
                  <label class="form-check-label" for="hasBackflowPrevention">
                    <i class="bi bi-shield-check"></i> Prevención de Reflujo
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" formControlName="hasPressureRegulation"
                    id="hasPressureRegulation">
                  <label class="form-check-label" for="hasPressureRegulation">
                    <i class="bi bi-speedometer2"></i> Regulación de Presión
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" formControlName="hasFlowMeter" id="hasFlowMeter">
                  <label class="form-check-label" for="hasFlowMeter">
                    <i class="bi bi-speedometer"></i> Medidor de Caudal
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary" (click)="setActiveTab('hydraulic')">
            <i class="bi bi-arrow-right"></i>
            Continuar a Parámetros Hidráulicos
          </button>

          <div>
            <button type="button" class="btn btn-secondary me-2" (click)="toggleAdvancedOptions()">
              <i class="bi" [class.bi-chevron-down]="!showAdvancedOptions"
                [class.bi-chevron-up]="showAdvancedOptions"></i>
              {{ showAdvancedOptions ? 'Ocultar' : 'Mostrar' }} Opciones Avanzadas
            </button>
          </div>
        </div>
      </form>
    </div>
    <!-- HYDRAULIC PARAMETERS TAB -->
    <div class="tab-pane" [class.active]="activeTab === 'hydraulic'">
      <form [formGroup]="hydraulicForm" class="hydraulic-form">

        <!-- Operating Parameters -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-speedometer2"></i> Parámetros de Operación</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Presión de Operación (bar) *</label>
                  <input type="number" class="form-control" formControlName="operatingPressure" min="0.5" step="0.1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Caudal Máximo (L/min) *</label>
                  <input type="number" class="form-control" formControlName="maxFlowRate" min="0.1" step="0.1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Velocidad de Diseño (m/s) *</label>
                  <input type="number" class="form-control" formControlName="designVelocity" min="0.5" max="3"
                    step="0.1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Cambio de Elevación (m)</label>
                  <input type="number" class="form-control" formControlName="elevationChange" step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Emitter Configuration -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-droplet-half"></i> Configuración de Emisores</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Caudal del Emisor (L/h) *</label>
                  <input type="number" class="form-control" formControlName="emitterFlowRate" min="0.1" step="0.1">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Espaciamiento de Emisores (m) *</label>
                  <input type="number" class="form-control" formControlName="emitterSpacing" min="0.1" step="0.1">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Presión del Emisor (bar) *</label>
                  <input type="number" class="form-control" formControlName="emitterPressure" min="0.5" step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pressure Loss Parameters -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-graph-down"></i> Parámetros de Pérdida de Presión</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Coeficiente de Pérdida por Fricción</label>
                  <input type="number" class="form-control" formControlName="frictionLossCoefficient" min="0"
                    step="0.01">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Coeficiente de Pérdidas Menores</label>
                  <input type="number" class="form-control" formControlName="minorLossCoefficient" min="0" step="0.01">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Uniformity Requirements -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-bullseye"></i> Requisitos de Uniformidad</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Uniformidad Objetivo (%) *</label>
                  <input type="number" class="form-control" formControlName="targetUniformity" min="80" max="98"
                    step="1">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Máx. Variación de Presión (%) *</label>
                  <input type="number" class="form-control" formControlName="pressureVariation" min="5" max="20"
                    step="1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Real-time Calculations Display -->
        <div class="card mb-4" *ngIf="realTimeCalculations$ | async as calculations">
          <div class="card-header">
            <h4><i class="bi bi-calculator"></i> Cálculos en Tiempo Real</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="metric-card">
                  <div class="metric-value">{{ formatNumber(calculations.recommendedFlowRate) }}</div>
                  <div class="metric-label">Caudal Recomendado (L/min)</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card">
                  <div class="metric-value">{{ formatNumber(calculations.pressureLoss) }}</div>
                  <div class="metric-label">Pérdida de Presión Estimada (bar)</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card">
                  <div class="metric-value">{{ formatNumber(calculations.systemEfficiency) }}</div>
                  <div class="metric-label">Eficiencia del Sistema (%)</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card">
                  <div class="metric-value">{{ formatNumber(calculations.waterVelocity) }}</div>
                  <div class="metric-label">Velocidad del Agua (m/s)</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary" (click)="setActiveTab('design')">
            <i class="bi bi-arrow-left"></i>
            Volver al Diseño
          </button>

          <button type="button" class="btn btn-primary" (click)="performHydraulicCalculations()"
            [disabled]="!designForm.valid || !hydraulicForm.valid || isCalculating">
            <i class="bi" [class.bi-calculator]="!isCalculating" [class.bi-arrow-clockwise]="isCalculating"
              [class.spinner-border]="isCalculating"></i>
            {{ isCalculating ? 'Calculando...' : 'Realizar Cálculos Hidráulicos' }}
          </button>
        </div>
      </form>
    </div>

    <!-- CALCULATION RESULTS TAB -->
    <div class="tab-pane" [class.active]="activeTab === 'results'">

      <!-- Hydraulic Results -->
      <div class="card mb-4" *ngIf="hydraulicResults">
        <div class="card-header">
          <h4><i class="bi bi-graph-up"></i> Resultados de Cálculos Hidráulicos</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <div class="metric-card success">
                <div class="metric-value">{{ formatNumber(hydraulicResults.totalPressureLoss) }}</div>
                <div class="metric-label">Pérdida Total de Presión (bar)</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card info">
                <div class="metric-value">{{ formatNumber(hydraulicResults.systemFlowRate) }}</div>
                <div class="metric-label">Caudal del Sistema (L/min)</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card warning">
                <div class="metric-value">{{ formatPercentage(hydraulicResults.distributionUniformity) }}</div>
                <div class="metric-label">Uniformidad de Distribución</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card primary">
                <div class="metric-value">{{ formatPercentage(hydraulicResults.applicationEfficiency) }}</div>
                <div class="metric-label">Eficiencia de Aplicación</div>
              </div>
            </div>
          </div>

          <!-- Detailed Results -->
          <div class="row mt-4">
            <div class="col-md-6">
              <h6>Análisis de Presión</h6>
              <table class="table table-sm">
                <tbody>
                  <tr>
                    <td>Pérdida de Presión Línea Principal</td>
                    <td>{{ formatNumber(hydraulicResults.mainLinePressureLoss) }} bar</td>
                  </tr>
                  <tr>
                    <td>Pérdida de Presión Línea Secundaria</td>
                    <td>{{ formatNumber(hydraulicResults.secondaryLinePressureLoss) }} bar</td>
                  </tr>
                  <tr>
                    <td>Pérdida de Presión Línea Lateral</td>
                    <td>{{ formatNumber(hydraulicResults.lateralLinePressureLoss) }} bar</td>
                  </tr>
                  <tr>
                    <td>Pérdidas Menores</td>
                    <td>{{ formatNumber(hydraulicResults.minorLosses) }} bar</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="col-md-6">
              <h6>Análisis de Caudal</h6>
              <table class="table table-sm">
                <tbody>
                  <tr>
                    <td>Caudal de Diseño</td>
                    <td>{{ formatNumber(hydraulicResults.designFlowRate) }} L/min</td>
                  </tr>
                  <tr>
                    <td>Caudal Pico</td>
                    <td>{{ formatNumber(hydraulicResults.peakFlowRate) }} L/min</td>
                  </tr>
                  <tr>
                    <td>Velocidad Promedio</td>
                    <td>{{ formatNumber(hydraulicResults.averageVelocity) }} m/s</td>
                  </tr>
                  <tr>
                    <td>Número de Reynolds</td>
                    <td>{{ formatNumber(hydraulicResults.reynoldsNumber, 0) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Validation Results -->
      <div class="card mb-4" *ngIf="validationResults">
        <div class="card-header">
          <h4>
            <i class="bi" [class.bi-check-circle-fill]="validationResults.isValid"
              [class.bi-exclamation-triangle-fill]="!validationResults.isValid"></i>
            Resultados de Validación del Sistema
          </h4>
        </div>
        <div class="card-body">
          <div class="alert" [class.alert-success]="validationResults.isValid"
            [class.alert-warning]="!validationResults.isValid">
            <strong>Estado de Validación:</strong> {{ validationResults.isValid ? 'APROBADO' : 'PROBLEMAS ENCONTRADOS'
            }}
          </div>

          <!-- Validation Issues -->
          <div *ngIf="validationResults.issues && validationResults.issues.length > 0">
            <h6>Problemas Encontrados:</h6>
            <div class="alert" *ngFor="let issue of validationResults.issues"
              [class]="'alert-' + getValidationSeverity(issue)">
              <strong>{{ issue.category }}:</strong> {{ issue.message }}
              <div *ngIf="issue.recommendation" class="mt-2">
                <small><strong>Recomendación:</strong> {{ issue.recommendation }}</small>
              </div>
            </div>
          </div>

          <!-- Validation Metrics -->
          <div class="row mt-3">
            <div class="col-md-4">
              <div class="metric-card" [class.success]="validationResults.pressureValidation.isValid"
                [class.danger]="!validationResults.pressureValidation.isValid">
                <div class="metric-value">{{ validationResults.pressureValidation.isValid ? 'APROBADO' : 'RECHAZADO' }}
                </div>
                <div class="metric-label">Validación de Presión</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="metric-card" [class.success]="validationResults.flowValidation.isValid"
                [class.danger]="!validationResults.flowValidation.isValid">
                <div class="metric-value">{{ validationResults.flowValidation.isValid ? 'APROBADO' : 'RECHAZADO' }}
                </div>
                <div class="metric-label">Validación de Caudal</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="metric-card" [class.success]="validationResults.uniformityValidation.isValid"
                [class.danger]="!validationResults.uniformityValidation.isValid">
                <div class="metric-value">{{ validationResults.uniformityValidation.isValid ? 'APROBADO' : 'RECHAZADO'
                  }}</div>
                <div class="metric-label">Validación de Uniformidad</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Economic Analysis -->
      <div class="card mb-4" *ngIf="economicAnalysis">
        <div class="card-header">
          <h4><i class="bi bi-currency-dollar"></i> Análisis Económico</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <div class="metric-card primary">
                <div class="metric-value">{{ formatCurrency(economicAnalysis.totalInvestment) }}</div>
                <div class="metric-label">Inversión Total</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card info">
                <div class="metric-value">{{ formatCurrency(economicAnalysis.annualOperatingCost) }}</div>
                <div class="metric-label">Costo Operativo Anual</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card success">
                <div class="metric-value">{{ formatNumber(economicAnalysis.paybackPeriod, 1) }}</div>
                <div class="metric-label">Período de Recuperación (años)</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card warning">
                <div class="metric-value">{{ formatPercentage(economicAnalysis.roi) }}</div>
                <div class="metric-label">ROI</div>
              </div>
            </div>
          </div>

          <!-- Cost Breakdown -->
          <div class="row mt-4">
            <div class="col-md-6">
              <h6>Desglose de Inversión</h6>
              <table class="table table-sm">
                <tbody>
                  <tr>
                    <td>Tuberías y Accesorios</td>
                    <td>{{ formatCurrency(economicAnalysis.pipelineCost) }}</td>
                  </tr>
                  <tr>
                    <td>Emisores y Goteros</td>
                    <td>{{ formatCurrency(economicAnalysis.emitterCost) }}</td>
                  </tr>
                  <tr>
                    <td>Sistema de Bombeo</td>
                    <td>{{ formatCurrency(economicAnalysis.pumpingCost) }}</td>
                  </tr>
                  <tr>
                    <td>Control y Automatización</td>
                    <td>{{ formatCurrency(economicAnalysis.controlCost) }}</td>
                  </tr>
                  <tr>
                    <td>Instalación y Mano de Obra</td>
                    <td>{{ formatCurrency(economicAnalysis.installationCost) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="col-md-6">
              <h6>Costos Operativos Anuales</h6>
              <table class="table table-sm">
                <tbody>
                  <tr>
                    <td>Costos de Energía</td>
                    <td>{{ formatCurrency(economicAnalysis.energyCost) }}</td>
                  </tr>
                  <tr>
                    <td>Costos de Agua</td>
                    <td>{{ formatCurrency(economicAnalysis.waterCost) }}</td>
                  </tr>
                  <tr>
                    <td>Mantenimiento</td>
                    <td>{{ formatCurrency(economicAnalysis.maintenanceCost) }}</td>
                  </tr>
                  <tr>
                    <td>Mano de Obra</td>
                    <td>{{ formatCurrency(economicAnalysis.laborCost) }}</td>
                  </tr>
                  <tr>
                    <td>Piezas de Repuesto</td>
                    <td>{{ formatCurrency(economicAnalysis.replacementCost) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" (click)="setActiveTab('hydraulic')">
          <i class="bi bi-arrow-left"></i>
          Volver a Parámetros Hidráulicos
        </button>

        <div>
          <button type="button" class="btn btn-info me-2" (click)="performEconomicAnalysis()"
            [disabled]="!hydraulicResults">
            <i class="bi bi-currency-dollar"></i>
            Análisis Económico
          </button>

          <button type="button" class="btn btn-primary" (click)="setActiveTab('optimization')"
            [disabled]="!validationResults || !validationResults.isValid">
            <i class="bi bi-arrow-right"></i>
            Continuar a Optimización
          </button>
        </div>
      </div>
    </div>
    <!-- OPTIMIZATION TAB -->
    <div class="tab-pane" [class.active]="activeTab === 'optimization'">
      <form [formGroup]="optimizationForm" class="optimization-form">

        <!-- Optimization Objectives -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-target"></i> Objetivos de Optimización</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Objetivo Principal</label>
                  <select class="form-select" formControlName="primaryObjective">
                    <option value="efficiency">Máxima Eficiencia</option>
                    <option value="cost">Mínimo Costo</option>
                    <option value="uniformity">Mejor Uniformidad</option>
                    <option value="sustainability">Sustentabilidad</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Método de Optimización</label>
                  <select class="form-select" formControlName="optimizationMethod">
                    <option value="genetic">Algoritmo Genético</option>
                    <option value="gradient">Descenso del Gradiente</option>
                    <option value="hybrid">Enfoque Híbrido</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Weighting Factors -->
            <div class="mt-3" formGroupName="weightingFactors">
              <h6>Factores de Ponderación (%)</h6>
              <div class="row">
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Eficiencia</label>
                    <input type="range" class="form-range" formControlName="efficiency" min="0" max="100" step="5">
                    <div class="text-center">{{ optimizationForm.get('weightingFactors.efficiency')?.value }}%</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Costo</label>
                    <input type="range" class="form-range" formControlName="cost" min="0" max="100" step="5">
                    <div class="text-center">{{ optimizationForm.get('weightingFactors.cost')?.value }}%</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Uniformidad</label>
                    <input type="range" class="form-range" formControlName="uniformity" min="0" max="100" step="5">
                    <div class="text-center">{{ optimizationForm.get('weightingFactors.uniformity')?.value }}%</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Sustentabilidad</label>
                    <input type="range" class="form-range" formControlName="sustainability" min="0" max="100" step="5">
                    <div class="text-center">{{ optimizationForm.get('weightingFactors.sustainability')?.value }}%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Constraints -->
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="bi bi-lock"></i> Restricciones de Optimización</h4>
          </div>
          <div class="card-body" formGroupName="constraints">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Inversión Máxima ($)</label>
                  <input type="number" class="form-control" formControlName="maxInvestment" min="0" step="100">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Eficiencia Mínima (%)</label>
                  <input type="number" class="form-control" formControlName="minEfficiency" min="70" max="98" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Máx. Consumo de Agua (L/día)</label>
                  <input type="number" class="form-control" formControlName="maxWaterConsumption" min="0" step="10">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="form-label">Área Disponible (m²)</label>
                  <input type="number" class="form-control" formControlName="availableArea" min="0" step="1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Advanced Optimization Parameters -->
        <div class="card mb-4" *ngIf="showAdvancedOptions">
          <div class="card-header">
            <h4><i class="bi bi-gear"></i> Parámetros Avanzados</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Máximo de Iteraciones</label>
                  <input type="number" class="form-control" formControlName="maxIterations" min="100" max="10000"
                    step="100">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Tolerancia de Convergencia</label>
                  <input type="number" class="form-control" formControlName="convergenceTolerance" min="0.0001"
                    max="0.1" step="0.001">
                </div>
              </div>
            </div>

            <!-- Scenario Planning -->
            <div class="mt-3" formGroupName="includeScenarios">
              <h6>Planificación de Escenarios</h6>
              <div class="row">
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" formControlName="climateChange" id="climateChange">
                    <label class="form-check-label" for="climateChange">
                      Impacto del Cambio Climático
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" formControlName="waterScarcity" id="waterScarcity">
                    <label class="form-check-label" for="waterScarcity">
                      Escenarios de Escasez de Agua
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" formControlName="expansionPlanning"
                      id="expansionPlanning">
                    <label class="form-check-label" for="expansionPlanning">
                      Expansión Futura
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" formControlName="maintenanceScheduling"
                      id="maintenanceScheduling">
                    <label class="form-check-label" for="maintenanceScheduling">
                      Programación de Mantenimiento
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Optimization Results -->
        <div class="card mb-4" *ngIf="optimizationResults">
          <div class="card-header">
            <h4><i class="bi bi-graph-up-arrow"></i> Resultados de Optimización</h4>
          </div>
          <div class="card-body">
            <div class="alert alert-success">
              <strong>¡Optimización Completada!</strong>
              Se encontró la solución óptima en {{ optimizationResults.iterations }} iteraciones.
            </div>

            <!-- Performance Metrics -->
            <div class="row">
              <div class="col-md-3">
                <div class="metric-card success">
                  <div class="metric-value">{{ formatPercentage(optimizationResults.achievedEfficiency) }}</div>
                  <div class="metric-label">Eficiencia Lograda</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card info">
                  <div class="metric-value">{{ formatCurrency(optimizationResults.optimizedCost) }}</div>
                  <div class="metric-label">Costo Optimizado</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card warning">
                  <div class="metric-value">{{ formatPercentage(optimizationResults.uniformityImprovement) }}</div>
                  <div class="metric-label">Mejora en Uniformidad</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="metric-card primary">
                  <div class="metric-value">{{ formatNumber(optimizationResults.overallScore) }}</div>
                  <div class="metric-label">Puntuación General</div>
                </div>
              </div>
            </div>

            <!-- Optimized Parameters -->
            <div class="row mt-4">
              <div class="col-md-6">
                <h6>Parámetros de Diseño Optimizados</h6>
                <table class="table table-sm">
                  <tbody>
                    <tr>
                      <td>Caudal del Emisor</td>
                      <td>{{ formatNumber(optimizationResults.optimizedParameters?.emitterFlowRate) }} L/h</td>
                    </tr>
                    <tr>
                      <td>Presión de Operación</td>
                      <td>{{ formatNumber(optimizationResults.optimizedParameters?.operatingPressure) }} bar</td>
                    </tr>
                    <tr>
                      <td>Espaciamiento de Emisores</td>
                      <td>{{ formatNumber(optimizationResults.optimizedParameters?.emitterSpacing) }} m</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="col-md-6">
                <h6>Comparación de Rendimiento</h6>
                <table class="table table-sm">
                  <tbody>
                    <tr>
                      <td>Reducción de Costos</td>
                      <td class="text-success">{{ formatPercentage(optimizationResults.costReduction) }}</td>
                    </tr>
                    <tr>
                      <td>Ganancia en Eficiencia</td>
                      <td class="text-success">{{ formatPercentage(optimizationResults.efficiencyGain) }}</td>
                    </tr>
                    <tr>
                      <td>Ahorro de Agua</td>
                      <td class="text-success">{{ formatPercentage(optimizationResults.waterSavings) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Apply Optimization -->
            <div class="text-center mt-3">
              <button type="button" class="btn btn-success"
                (click)="applyOptimizedParameters(optimizationResults.optimizedParameters)">
                <i class="bi bi-check-circle"></i>
                Aplicar Parámetros Optimizados
              </button>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary" (click)="setActiveTab('results')">
            <i class="bi bi-arrow-left"></i>
            Volver a Resultados
          </button>

          <button type="button" class="btn btn-primary" (click)="performDesignOptimization()"
            [disabled]="!validationResults?.isValid || isOptimizing">
            <i class="bi" [class.bi-graph-up-arrow]="!isOptimizing" [class.bi-arrow-clockwise]="isOptimizing"
              [class.spinner-border]="isOptimizing"></i>
            {{ isOptimizing ? 'Optimizando...' : 'Realizar Optimización de Diseño' }}
          </button>
        </div>
      </form>
    </div>

    <!-- SAVED DESIGNS TAB -->
    <div class="tab-pane" [class.active]="activeTab === 'saved'">
      <div class="saved-designs-container">

        <!-- Current Design Info -->
        <div class="card mb-4" *ngIf="currentDesign">
          <div class="card-header">
            <h4><i class="bi bi-file-earmark-check"></i> Diseño Actual</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <h5>{{ currentDesign.name }}</h5>
                <p class="text-muted">{{ currentDesign.description }}</p>
                <small class="text-muted">
                  Creado: {{ currentDesign.createdAt | date:'medium' }} |
                  Actualizado: {{ currentDesign.updatedAt | date:'medium' }}
                </small>
              </div>
              <div class="col-md-4 text-end">
                <span class="badge" [class.badge-success]="currentDesign.status === 'validated'"
                  [class.badge-warning]="currentDesign.status === 'draft'">
                  {{ currentDesign.status | titlecase }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Saved Designs List -->
        <div class="card">
          <div class="card-header">
            <h4><i class="bi bi-folder-open"></i> Biblioteca de Diseños Guardados</h4>
          </div>
          <div class="card-body">

            <div *ngIf="savedDesigns.length === 0" class="text-center text-muted py-4">
              <i class="bi bi-folder-x display-4"></i>
              <p class="mt-3">No se encontraron diseños guardados. ¡Crea y guarda tu primer diseño de riego!</p>
            </div>

            <div class="row" *ngIf="savedDesigns.length > 0">
              <div class="col-md-6 col-lg-4 mb-3" *ngFor="let design of savedDesigns">
                <div class="card design-card h-100" [class.border-primary]="currentDesign?.id === design.id">

                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">{{ design.name }}</h6>
                    <span class="badge" [class.badge-success]="design.status === 'validated'"
                      [class.badge-warning]="design.status === 'draft'">
                      {{ design.status }}
                    </span>
                  </div>

                  <div class="card-body">
                    <p class="card-text text-muted small">{{ design.description || 'Sin descripción' }}</p>

                    <!-- Quick Stats -->
                    <div class="quick-stats" *ngIf="design.calculationResults">
                      <div class="stat-item">
                        <small class="text-muted">Eficiencia:</small>
                        <strong>{{ formatPercentage(design.calculationResults.hydraulic?.applicationEfficiency || 0)
                          }}</strong>
                      </div>
                      <div class="stat-item">
                        <small class="text-muted">Inversión:</small>
                        <strong>{{ formatCurrency(design.calculationResults.economic?.totalInvestment || 0) }}</strong>
                      </div>
                    </div>

                    <small class="text-muted d-block mt-2">
                      {{ design.updatedAt | date:'short' }}
                    </small>
                  </div>

                  <div class="card-footer">
                    <div class="btn-group w-100" role="group">
                      <button class="btn btn-outline-primary btn-sm" (click)="loadDesign(design)">
                        <i class="bi bi-folder-open"></i>
                        Cargar
                      </button>
                      <button class="btn btn-outline-info btn-sm" (click)="exportDesign()"
                        [disabled]="currentDesign?.id !== design.id">
                        <i class="bi bi-download"></i>
                        Exportar
                      </button>
                      <button class="btn btn-outline-danger btn-sm" (click)="deleteDesign(design)">
                        <i class="bi bi-trash"></i>
                        Eliminar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>