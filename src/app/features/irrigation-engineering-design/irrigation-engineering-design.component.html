<!-- src/app/features/irrigation-scheduling/irrigation-scheduling.component.html -->
<div class="irrigation-scheduling-container">

  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="bi bi-calendar-check"></i>
        Programación de Riego
      </h1>
      <p class="lead text-muted">Gestión de planes, entradas y modos de riego</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-success" (click)="exportToExcel()">
        <i class="bi bi-file-earmark-excel"></i>
        Exportar
      </button>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'plans'" 
        (click)="setActiveTab('plans')" 
        type="button">
        <i class="bi bi-calendar3"></i>
        Planes de Riego
        <span class="badge bg-primary ms-2">{{ irrigationPlans.length }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'entries'" 
        (click)="setActiveTab('entries')" 
        type="button">
        <i class="bi bi-clock-history"></i>
        Entradas de Programación
        <span class="badge bg-info ms-2">{{ irrigationEntries.length }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'modes'" 
        (click)="setActiveTab('modes')" 
        type="button">
        <i class="bi bi-gear"></i>
        Modos de Riego
        <span class="badge bg-secondary ms-2">{{ irrigationModes.length }}</span>
      </button>
    </li>
  </ul>

  <!-- Loading Spinner -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3 text-muted">Cargando datos...</p>
  </div>

  <!-- Tab Content -->
  <div class="tab-content" *ngIf="!isLoading">

    <!-- ==================== PLANS TAB ==================== -->
    <div class="tab-pane" [class.show]="activeTab === 'plans'" [class.active]="activeTab === 'plans'">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
              <i class="bi bi-calendar3"></i>
              Planes de Riego
            </h4>
            <button class="btn btn-primary" (click)="openPlanModal()">
              <i class="bi bi-plus-circle"></i>
              Nuevo Plan
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-header">
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Días de la Semana</th>
                  <th>Estado</th>
                  <th>Fecha Creación</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let plan of irrigationPlans">
                  <td>{{ plan.id }}</td>
                  <td>
                    <strong>{{ plan.name }}</strong>
                  </td>
                  <td>
                    <span class="badge bg-light text-dark">
                      {{ getDaysDisplay(plan.dayMask) }}
                    </span>
                  </td>
                  <td>
                    <span [class]="getStatusBadgeClass(plan.active)">
                      {{ getStatusText(plan.active) }}
                    </span>
                  </td>
                  <td>{{ plan.dateCreated | date:'short' }}</td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm">
                      <button 
                        class="btn btn-outline-primary" 
                        (click)="openPlanModal(plan)"
                        title="Editar">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button 
                        class="btn btn-outline-danger" 
                        (click)="deletePlan(plan)"
                        title="Eliminar">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="irrigationPlans.length === 0">
                  <td colspan="6" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No hay planes de riego registrados
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== ENTRIES TAB ==================== -->
    <div class="tab-pane" [class.show]="activeTab === 'entries'" [class.active]="activeTab === 'entries'">
      
      <!-- Filters Section -->
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-funnel"></i>
            Filtros
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Plan de Riego</label>
              <select class="form-select" [(ngModel)]="filterPlanId" (change)="applyFilters()">
                <option [ngValue]="null">Todos los planes</option>
                <option *ngFor="let plan of irrigationPlans" [ngValue]="plan.id">
                  {{ plan.name }}
                </option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Modo de Riego</label>
              <select class="form-select" [(ngModel)]="filterModeId" (change)="applyFilters()">
                <option [ngValue]="null">Todos los modos</option>
                <option *ngFor="let mode of irrigationModes" [ngValue]="mode.id">
                  {{ mode.name }}
                </option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Estado</label>
              <select class="form-select" [(ngModel)]="filterActive" (change)="applyFilters()">
                <option [ngValue]="null">Todos</option>
                <option [ngValue]="true">Activos</option>
                <option [ngValue]="false">Inactivos</option>
              </select>
            </div>
          </div>
          <div class="mt-3">
            <button class="btn btn-secondary btn-sm" (click)="clearFilters()">
              <i class="bi bi-x-circle"></i>
              Limpiar Filtros
            </button>
          </div>
        </div>
      </div>

      <!-- Entries Table -->
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
              <i class="bi bi-clock-history"></i>
              Entradas de Programación
            </h4>
            <button class="btn btn-primary" (click)="openEntryModal()">
              <i class="bi bi-plus-circle"></i>
              Nueva Entrada
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-header">
                <tr>
                  <th>ID</th>
                  <th>Plan</th>
                  <th>Modo</th>
                  <th>Hora Inicio</th>
                  <th>Duración (min)</th>
                  <th>Secuencia</th>
                  <th>Estado</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let entry of paginatedEntries">
                  <td>{{ entry.id }}</td>
                  <td>
                    <span class="badge bg-info">{{ entry.irrigationPlanName }}</span>
                  </td>
                  <td>
                    <span class="badge bg-primary">{{ entry.irrigationModeName }}</span>
                  </td>
                  <td>
                    <i class="bi bi-clock"></i>
                    {{ formatTimeDisplay(entry.startTime) }}
                  </td>
                  <td>
                    <strong>{{ entry.duration }}</strong> min
                  </td>
                  <td>
                    <span class="badge bg-secondary">{{ entry.sequence }}</span>
                  </td>
                  <td>
                    <span [class]="getStatusBadgeClass(entry.active)">
                      {{ getStatusText(entry.active) }}
                    </span>
                  </td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm">
                      <button 
                        class="btn btn-outline-primary" 
                        (click)="openEntryModal(entry)"
                        title="Editar">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button 
                        class="btn btn-outline-danger" 
                        (click)="deleteEntry(entry)"
                        title="Eliminar">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="paginatedEntries.length === 0">
                  <td colspan="8" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No hay entradas de programación
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <nav aria-label="Paginación" *ngIf="totalPages > 1">
            <ul class="pagination justify-content-center mb-0">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <a class="page-link" (click)="goToPage(currentPage - 1)">
                  <span>&laquo;</span>
                </a>
              </li>
              <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
                <a class="page-link" (click)="goToPage(page)">{{ page }}</a>
              </li>
              <li class="page-item" [class.disabled]="currentPage === totalPages">
                <a class="page-link" (click)="goToPage(currentPage + 1)">
                  <span>&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- ==================== MODES TAB ==================== -->
    <div class="tab-pane" [class.show]="activeTab === 'modes'" [class.active]="activeTab === 'modes'">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
              <i class="bi bi-gear"></i>
              Modos de Riego
            </h4>
            <button class="btn btn-primary" (click)="openModeModal()" disabled>
              <i class="bi bi-plus-circle"></i>
              Nuevo Modo
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Los modos de riego son configuraciones predefinidas del sistema. Actualmente: <strong>Planned</strong> (Programado) y <strong>OnDemand</strong> (Bajo Demanda).
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-header">
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Estado</th>
                  <th>Fecha Creación</th>
                  <th class="text-center">Entradas Asociadas</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let mode of irrigationModes">
                  <td>{{ mode.id }}</td>
                  <td>
                    <strong>{{ mode.name }}</strong>
                  </td>
                  <td>
                    <span [class]="getStatusBadgeClass(mode.active)">
                      {{ getStatusText(mode.active) }}
                    </span>
                  </td>
                  <td>{{ mode.dateCreated | date:'short' }}</td>
                  <td class="text-center">
                    <span class="badge bg-primary">
                      {{ getEntriesCountByMode(mode.id) }}
                    </span>
                  </td>
                </tr>
                <tr *ngIf="irrigationModes.length === 0">
                  <td colspan="5" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No hay modos de riego registrados
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>

</div>

<!-- ==================== PLAN MODAL ==================== -->
<div class="modal" [class.show]="showPlanModal" [style.display]="showPlanModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-calendar3"></i>
          {{ isEditMode ? 'Editar Plan de Riego' : 'Nuevo Plan de Riego' }}
        </h5>
        <button type="button" class="btn-close" (click)="closePlanModal()"></button>
      </div>
      <form [formGroup]="planForm" (ngSubmit)="savePlan()">
        <div class="modal-body">
          
          <!-- Name -->
          <div class="mb-3">
            <label class="form-label">Nombre del Plan <span class="text-danger">*</span></label>
            <input 
              type="text" 
              class="form-control" 
              formControlName="name"
              placeholder="Ej: Plan Semanal de Verano"
              [class.is-invalid]="planForm.get('name')?.invalid && planForm.get('name')?.touched">
            <div class="invalid-feedback">
              El nombre es requerido
            </div>
          </div>

          <!-- Days of Week -->
          <div class="mb-3">
            <label class="form-label">Días de la Semana <span class="text-danger">*</span></label>
            <div class="row g-2">
              <div class="col-6 col-md-3" *ngFor="let day of daysOfWeek">
                <div class="form-check">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [id]="'day-' + day.value"
                    [(ngModel)]="day.checked"
                    [ngModelOptions]="{standalone: true}">
                  <label class="form-check-label" [for]="'day-' + day.value">
                    {{ day.name }}
                  </label>
                </div>
              </div>
            </div>
            <small class="text-muted">Seleccione los días en que este plan estará activo</small>
          </div>

          <!-- Active Status -->
          <div class="mb-3">
            <div class="form-check form-switch">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="planActive"
                formControlName="active">
              <label class="form-check-label" for="planActive">
                Plan Activo
              </label>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closePlanModal()">
            <i class="bi bi-x-circle"></i>
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="planForm.invalid || isSaving">
            <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2"></span>
            <i class="bi bi-save" *ngIf="!isSaving"></i>
            {{ isEditMode ? 'Actualizar' : 'Guardar' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showPlanModal" *ngIf="showPlanModal"></div>

<!-- ==================== ENTRY MODAL ==================== -->
<div class="modal" [class.show]="showEntryModal" [style.display]="showEntryModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-clock-history"></i>
          {{ isEditMode ? 'Editar Entrada de Programación' : 'Nueva Entrada de Programación' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeEntryModal()"></button>
      </div>
      <form [formGroup]="entryForm" (ngSubmit)="saveEntry()">
        <div class="modal-body">
          
          <div class="row">
            <!-- Plan -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Plan de Riego <span class="text-danger">*</span></label>
              <select 
                class="form-select" 
                formControlName="irrigationPlanId"
                [class.is-invalid]="entryForm.get('irrigationPlanId')?.invalid && entryForm.get('irrigationPlanId')?.touched">
                <option [ngValue]="null">Seleccione un plan</option>
                <option *ngFor="let plan of irrigationPlans" [ngValue]="plan.id">
                  {{ plan.name }}
                </option>
              </select>
              <div class="invalid-feedback">
                Debe seleccionar un plan
              </div>
            </div>

            <!-- Mode -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Modo de Riego <span class="text-danger">*</span></label>
              <select 
                class="form-select" 
                formControlName="irrigationModeId"
                [class.is-invalid]="entryForm.get('irrigationModeId')?.invalid && entryForm.get('irrigationModeId')?.touched">
                <option [ngValue]="null">Seleccione un modo</option>
                <option *ngFor="let mode of irrigationModes" [ngValue]="mode.id">
                  {{ mode.name }}
                </option>
              </select>
              <div class="invalid-feedback">
                Debe seleccionar un modo
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Start Time -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Hora de Inicio <span class="text-danger">*</span></label>
              <input 
                type="time" 
                class="form-control" 
                formControlName="startTime"
                [class.is-invalid]="entryForm.get('startTime')?.invalid && entryForm.get('startTime')?.touched">
              <div class="invalid-feedback">
                La hora de inicio es requerida
              </div>
            </div>

            <!-- Duration -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Duración (minutos) <span class="text-danger">*</span></label>
              <input 
                type="number" 
                class="form-control" 
                formControlName="duration"
                min="1"
                placeholder="30"
                [class.is-invalid]="entryForm.get('duration')?.invalid && entryForm.get('duration')?.touched">
              <div class="invalid-feedback">
                La duración debe ser mayor a 0
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Week Start -->
            <div class="col-md-4 mb-3">
              <label class="form-label">Semana Inicio (1-52)</label>
              <input 
                type="number" 
                class="form-control" 
                formControlName="wStart"
                min="1"
                max="52"
                placeholder="Opcional">
            </div>

            <!-- Week End -->
            <div class="col-md-4 mb-3">
              <label class="form-label">Semana Fin (1-52)</label>
              <input 
                type="number" 
                class="form-control" 
                formControlName="wEnd"
                min="1"
                max="52"
                placeholder="Opcional">
            </div>

            <!-- Frequency -->
            <div class="col-md-4 mb-3">
              <label class="form-label">Frecuencia (días)</label>
              <input 
                type="number" 
                class="form-control" 
                formControlName="frequency"
                min="1"
                placeholder="Opcional">
            </div>
          </div>

          <!-- Sequence -->
          <div class="mb-3">
            <label class="form-label">Secuencia <span class="text-danger">*</span></label>
            <input 
              type="number" 
              class="form-control" 
              formControlName="sequence"
              min="1"
              placeholder="1"
              [class.is-invalid]="entryForm.get('sequence')?.invalid && entryForm.get('sequence')?.touched">
            <small class="text-muted">Orden de ejecución dentro del plan</small>
            <div class="invalid-feedback">
              La secuencia debe ser mayor a 0
            </div>
          </div>

          <!-- Active Status -->
          <div class="mb-3">
            <div class="form-check form-switch">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="entryActive"
                formControlName="active">
              <label class="form-check-label" for="entryActive">
                Entrada Activa
              </label>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeEntryModal()">
            <i class="bi bi-x-circle"></i>
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="entryForm.invalid || isSaving">
            <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2"></span>
            <i class="bi bi-save" *ngIf="!isSaving"></i>
            {{ isEditMode ? 'Actualizar' : 'Guardar' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showEntryModal" *ngIf="showEntryModal"></div>