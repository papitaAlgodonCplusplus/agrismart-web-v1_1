<!-- src/app/features/admin/admin.component.html -->
<div class="admin-container">
  <!-- Main Layout -->
  <div class="admin-layout">
    <!-- Sidebar Navigation -->
    <div class="admin-sidebar">
      <div class="sidebar-header">
        <h3><i class="bi bi-list-ul"></i> Entidades</h3>
      </div>
      
      <div class="entity-nav">
        <div class="entity-category">
          <h4>Gestión Principal</h4>
          <ul class="entity-list">
            <li *ngFor="let entityConfig of getMainEntities(); trackBy: trackByEntityConfig" 
                class="entity-item"
                [class.active]="selectedEntity === entityConfig.name"
                (click)="selectEntity(entityConfig.name)">
              <i [class]="entityConfig.icon"></i>
              <span>{{ entityConfig.displayName }}</span>
              <div class="entity-badge" *ngIf="getEntityCount(entityConfig.name) > 0">
                {{ getEntityCount(entityConfig.name) }}
              </div>
            </li>
          </ul>
        </div>

        <div class="entity-category">
          <h4>Configuración</h4>
          <ul class="entity-list">
            <li *ngFor="let entityConfig of getConfigEntities(); trackBy: trackByEntityConfig" 
                class="entity-item"
                [class.active]="selectedEntity === entityConfig.name"
                (click)="selectEntity(entityConfig.name)">
              <i [class]="entityConfig.icon"></i>
              <span>{{ entityConfig.displayName }}</span>
              <div class="entity-badge" *ngIf="getEntityCount(entityConfig.name) > 0">
                {{ getEntityCount(entityConfig.name) }}
              </div>
            </li>
          </ul>
        </div>

        <div class="entity-category">
          <h4>Avanzado</h4>
          <ul class="entity-list">
            <li *ngFor="let entityConfig of getAdvancedEntities(); trackBy: trackByEntityConfig" 
                class="entity-item"
                [class.active]="selectedEntity === entityConfig.name"
                (click)="selectEntity(entityConfig.name)">
              <i [class]="entityConfig.icon"></i>
              <span>{{ entityConfig.displayName }}</span>
              <div class="entity-badge" *ngIf="getEntityCount(entityConfig.name) > 0">
                {{ getEntityCount(entityConfig.name) }}
              </div>
            </li>
          </ul>
        </div>
      </div>
      
      <div class="sidebar-footer">
        <button class="btn btn-outline-light btn-sm w-100 mb-2" 
                (click)="goToDashboard()">
          <i class="bi bi-arrow-left"></i> Dashboard
        </button>
        <button class="btn btn-outline-danger btn-sm w-100" 
                (click)="logout()">
          <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
        </button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="admin-content">
      <!-- Welcome Screen -->
      <div *ngIf="!selectedEntity" class="welcome-screen">
        <div class="welcome-content">
          <div class="welcome-icon">
            <i class="bi bi-database"></i>
          </div>
          <h2>Bienvenido al Panel de Administración</h2>
          <p>Selecciona una entidad del menú lateral para comenzar a gestionar los datos del sistema.</p>
          
          <div class="welcome-features">
            <div class="feature-item">
              <i class="bi bi-lightning-charge text-warning"></i>
              <span>Gestión en tiempo real</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-shield-check text-success"></i>
              <span>Operaciones seguras</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-graph-up text-info"></i>
              <span>Análisis completo</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Entity Management Section -->
      <div *ngIf="selectedEntity" class="entity-section">
        <!-- Loading State -->
        <div *ngIf="isLoading" class="loading-overlay">
          <div class="loading-content">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="loading-text">Cargando {{ getCurrentEntityConfig()?.displayName }}...</p>
          </div>
        </div>

        <!-- Entity Header -->
        <div class="entity-header" *ngIf="!isLoading">
          <div class="entity-info">
            <h2 class="entity-title">
              <i [class]="getCurrentEntityConfig()?.icon"></i>
              {{ getCurrentEntityConfig()?.displayName }}
            </h2>
            <p class="entity-description">
              Gestiona {{ getCurrentEntityConfig()?.displayName?.toLowerCase() }} del sistema
            </p>
          </div>
          
          <div class="entity-actions">
            <div class="search-box">
              <input type="text" 
                     class="form-control" 
                     placeholder="Buscar..."
                     [(ngModel)]="searchTerm"
                     (ngModelChange)="applyFilters()">
              <i class="bi bi-search search-icon"></i>
            </div>
            
            <button class="btn btn-primary" (click)="openCreateModal()">
              <i class="bi bi-plus-lg"></i>
              Agregar {{ getCurrentEntityConfig()?.displayName?.slice(0, -1) }}
            </button>
            
            <button class="btn btn-outline-secondary" (click)="refreshData()">
              <i class="bi bi-arrow-clockwise"></i>
              Actualizar
            </button>
          </div>
        </div>

        <!-- Filters and Sort -->
        <div class="entity-filters" *ngIf="!isLoading">
          <div class="filter-group">
            <label>Estado:</label>
            <select class="form-select form-select-sm" 
                    [(ngModel)]="filterStatus" 
                    (ngModelChange)="applyFilters()">
              <option value="">Todos</option>
              <option value="active">Activos</option>
              <option value="inactive">Inactivos</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Ordenar por:</label>
            <select class="form-select form-select-sm" 
                    [(ngModel)]="sortField" 
                    (ngModelChange)="applySorting()">
              <option value="">Sin orden</option>
              <option value="id">ID</option>
              <option *ngIf="getCurrentEntityConfig()?.nameField" 
                      [value]="getCurrentEntityConfig()?.nameField">
                {{ getCurrentEntityConfig()?.nameField === 'deviceId' ? 'ID Dispositivo' : 
                   getCurrentEntityConfig()?.nameField === 'userEmail' ? 'Email' :
                   getCurrentEntityConfig()?.nameField === 'sensorLabel' ? 'Etiqueta' :
                   getCurrentEntityConfig()?.nameField === 'waterId' ? 'ID Agua' :
                   getCurrentEntityConfig()?.nameField === 'key' ? 'Clave' : 'Nombre' }}
              </option>
              <option value="active">Estado</option>
            </select>
          </div>
          
          <div class="filter-group">
            <button class="btn btn-outline-secondary btn-sm" 
                    (click)="sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'; applySorting()"
                    [disabled]="!sortField">
              <i class="bi" [class.bi-sort-alpha-down]="sortDirection === 'asc'" 
                 [class.bi-sort-alpha-up]="sortDirection === 'desc'"></i>
            </button>
          </div>
          
          <div class="filter-group">
            <button class="btn btn-outline-warning btn-sm" 
                    (click)="clearFilters()"
                    [disabled]="!searchTerm && !filterStatus && !sortField">
              <i class="bi bi-x-circle"></i>
              Limpiar
            </button>
          </div>
          
          <div class="filter-results">
            Mostrando {{ filteredData.length }} de {{ entityData.length }} registros
          </div>
        </div>

        <!-- Alert Messages -->
        <div class="alert alert-success alert-dismissible fade show" 
             *ngIf="successMessage" 
             role="alert">
          <i class="bi bi-check-circle"></i>
          {{ successMessage }}
          <button type="button" class="btn-close" (click)="clearMessages()"></button>
        </div>

        <div class="alert alert-danger alert-dismissible fade show" 
             *ngIf="errorMessage" 
             role="alert">
          <i class="bi bi-exclamation-triangle"></i>
          {{ errorMessage }}
          <button type="button" class="btn-close" (click)="clearMessages()"></button>
        </div>

        <!-- Data Table -->
        <div class="entity-table-container" *ngIf="!isLoading">
          <div class="table-responsive">
            <table class="table table-hover entity-table">
              <thead>
                <tr>
                  <th *ngFor="let field of getCurrentEntityConfig()?.fields?.slice(0, 6); trackBy: trackByField" 
                      [class.sortable]="field.type !== 'boolean'"
                      (click)="sortByField(field.key)">
                    {{ field.label }}
                    <i class="bi bi-arrow-down-short sort-indicator" 
                       *ngIf="sortField === field.key && sortDirection === 'asc'"></i>
                    <i class="bi bi-arrow-up-short sort-indicator" 
                       *ngIf="sortField === field.key && sortDirection === 'desc'"></i>
                  </th>
                  <th class="actions-column">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of filteredData; trackBy: trackByItem" 
                    class="entity-row">
                  <td *ngFor="let field of getCurrentEntityConfig()?.fields?.slice(0, 6); trackBy: trackByField" 
                      [class]="'field-' + field.type">
                    
                    <!-- Text fields -->
                    <span *ngIf="field.type === 'text' || field.type === 'email' || field.type === 'textarea'"
                          [title]="item[field.key]">
                      {{ (item[field.key] | slice:0:30) + (item[field.key]?.length > 30 ? '...' : '') || '-' }}
                    </span>
                    
                    <!-- Number fields -->
                    <span *ngIf="field.type === 'number'" class="number-value">
                      {{ item[field.key] !== null && item[field.key] !== undefined ? (item[field.key] | number:'1.0-2') : '-' }}
                    </span>
                    
                    <!-- Date fields -->
                    <span *ngIf="field.type === 'date'" class="date-value">
                      {{ item[field.key] ? formatDate(item[field.key]) : '-' }}
                    </span>

                    <!-- DateTime fields -->
                    <span *ngIf="field.type === 'datetime'" class="datetime-value">
                      {{ item[field.key] ? formatDateTime(item[field.key]) : '-' }}
                    </span>
                    
                    <!-- Boolean fields -->
                    <span *ngIf="field.type === 'boolean'" class="boolean-value">
                      <span class="badge" 
                            [class.bg-success]="getBooleanValue(item, field.key)" 
                            [class.bg-secondary]="!getBooleanValue(item, field.key)">
                        <i class="bi" 
                           [class.bi-check-lg]="getBooleanValue(item, field.key)" 
                           [class.bi-x-lg]="!getBooleanValue(item, field.key)"></i>
                        {{ getBooleanValue(item, field.key) ? 'Sí' : 'No' }}
                      </span>
                    </span>
                    
                    <!-- Select fields -->
                    <span *ngIf="field.type === 'select'">
                      {{ getSelectLabel(field, item[field.key]) }}
                    </span>
                  </td>
                  
                  <!-- Actions Column -->
                  <td class="actions-column">
                    <div class="action-buttons">
                      <button class="btn btn-sm btn-outline-warning" 
                              (click)="editItem(item)"
                              title="Editar">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" 
                              (click)="deleteItem(item)"
                              title="Eliminar">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Empty State -->
          <div *ngIf="filteredData.length === 0" class="empty-state">
            <div class="empty-content">
              <i class="bi bi-inbox display-1 text-muted"></i>
              <h4>No se encontraron registros</h4>
              <p *ngIf="searchTerm || filterStatus">
                Intenta ajustar los filtros de búsqueda o 
                <button class="btn btn-link p-0" (click)="clearFilters()">limpiar filtros</button>
              </p>
              <p *ngIf="!searchTerm && !filterStatus">
                No hay {{ getCurrentEntityConfig()?.displayName?.toLowerCase() }} registradas en el sistema.
              </p>
              <button class="btn btn-primary" (click)="openCreateModal()">
                <i class="bi bi-plus-lg"></i>
                Agregar {{ getCurrentEntityConfig()?.displayName?.slice(0, -1) }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Create/Edit -->
  <div class="modal fade" 
       [class.show]="showModal" 
       [style.display]="showModal ? 'block' : 'none'"
       tabindex="-1" 
       role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i [class]="getCurrentEntityConfig()?.icon"></i>
            {{ isEditing ? 'Editar' : 'Crear' }} {{ getCurrentEntityConfig()?.displayName?.slice(0, -1) }}
          </h5>
          <button type="button" 
                  class="btn-close" 
                  (click)="closeModal()"></button>
        </div>
        
        <div class="modal-body">
          <div class="row g-3" *ngIf="getCurrentEntityConfig()">
            <div *ngFor="let field of getCurrentEntityConfig()?.fields; trackBy: trackByField"
                 [class]="getFieldColumnClass(field)">
              <label class="form-label">
                {{ field.label }}
                <span class="text-danger" *ngIf="field.required">*</span>
              </label>
              
              <!-- Text Input -->
              <input *ngIf="field.type === 'text' || field.type === 'email'" 
                     [type]="field.type === 'email' ? 'email' : 'text'"
                     class="form-control"
                     [(ngModel)]="currentItem[field.key]"
                     [placeholder]="field.label"
                     >
              
              <!-- Number Input -->
              <input *ngIf="field.type === 'number'" 
                     type="number" 
                     class="form-control"
                     [(ngModel)]="currentItem[field.key]"
                     [placeholder]="field.label"
                     >
              
              <!-- Date Input -->
              <input *ngIf="field.type === 'date'" 
                     type="date" 
                     class="form-control"
                     [(ngModel)]="currentItem[field.key]"
                     >

              <!-- DateTime Input -->
              <input *ngIf="field.type === 'datetime'" 
                     type="datetime-local" 
                     class="form-control"
                     [(ngModel)]="currentItem[field.key]"
                     >
              
              <!-- Textarea -->
              <textarea *ngIf="field.type === 'textarea'" 
                        class="form-control"
                        [(ngModel)]="currentItem[field.key]"
                        [placeholder]="field.label"
                        
                        rows="3"></textarea>
              
              <!-- Select -->
              <select *ngIf="field.type === 'select'" 
                      class="form-select"
                      [(ngModel)]="currentItem[field.key]"
                      >
                <option value="">Seleccionar...</option>
                <option *ngFor="let option of field.options; trackBy: trackByOption" 
                        [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
              
              <!-- Boolean -->
              <div *ngIf="field.type === 'boolean'" class="form-check form-switch">
                <input class="form-check-input" 
                       type="checkbox" 
                       [(ngModel)]="currentItem[field.key]"
                       [id]="'switch-' + field.key">
                <label class="form-check-label" [for]="'switch-' + field.key">
                  {{ currentItem[field.key] ? 'Activo' : 'Inactivo' }}
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" 
                  class="btn btn-secondary" 
                  (click)="closeModal()">
            Cancelar
          </button>
          <button type="button" 
                  class="btn btn-primary" 
                  (click)="saveItem()"
                  [disabled]="isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
            <i *ngIf="!isLoading" class="bi" 
               [class.bi-plus-lg]="!isEditing" 
               [class.bi-check-lg]="isEditing"></i>
            {{ isEditing ? 'Actualizar' : 'Crear' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Backdrop -->
  <div *ngIf="showModal" class="modal-backdrop fade show"></div>
</div>